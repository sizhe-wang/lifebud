{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/@mastra/core/dist/chunk-PSIJ6OSV.js","sources":["file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/detection/TypeDetector.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/prompt/data-content.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/prompt/image-utils.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/utils/provider-compat.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/adapters/AIV4Adapter.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/adapters/AIV5Adapter.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/cache/CacheKeyGenerator.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/conversion/to-prompt.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/conversion/utils.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/conversion/input-converter.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/conversion/output-converter.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/stream/aisdk/v5/file.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/conversion/step-content.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/merge/MessageMerger.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/stream/aisdk/v5/compat/content.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/stream/aisdk/v5/compat/media.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/prompt/convert-file.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/prompt/attachments-to-parts.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/prompt/convert-to-mastra-v1.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/utils/fetchWithRetry.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/prompt/download-assets.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/state/serialization.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/state/MessageStateManager.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/message-list.ts","file:///Users/wsz/lifebud/version2/lifebud/node_modules/%40mastra/core/src/agent/message-list/utils/convert-messages.ts"],"sourcesContent":["import type { Message as AIV4Message, UIMessage as UIMessageV4 } from '@internal/ai-sdk-v4';\n\nimport type { MastraDBMessage, MastraMessageV1 } from '../state/types';\nimport type { AIV5Type, CoreMessageV4 } from '../types';\n\n/**\n * Type representing all possible message input formats\n */\nexport type MessageInput =\n  | AIV5Type.UIMessage\n  | AIV5Type.ModelMessage\n  | (UIMessageV4 & { metadata?: Record<string, unknown> })\n  | AIV4Message\n  | CoreMessageV4\n  | MastraMessageV1\n  | MastraDBMessage;\n\n/**\n * TypeDetector - Centralized type detection for different message formats\n *\n * This class provides consistent type detection across all message formats,\n * which is critical for:\n * - Determining which conversion path to use\n * - Validating incoming message formats\n * - Providing better TypeScript type narrowing\n *\n * The detection order is important because some formats share similar properties.\n */\nexport class TypeDetector {\n  /**\n   * Check if a message is a MastraDBMessage (format 2)\n   */\n  static isMastraDBMessage(msg: MessageInput): msg is MastraDBMessage {\n    return Boolean(\n      'content' in msg &&\n      msg.content &&\n      !Array.isArray(msg.content) &&\n      typeof msg.content !== 'string' &&\n      'format' in msg.content &&\n      msg.content.format === 2,\n    );\n  }\n\n  /**\n   * Check if a message is a MastraMessageV1 (legacy format)\n   */\n  static isMastraMessageV1(msg: MessageInput): msg is MastraMessageV1 {\n    return !TypeDetector.isMastraDBMessage(msg) && ('threadId' in msg || 'resourceId' in msg);\n  }\n\n  /**\n   * Check if a message is either Mastra format (V1 or V2/DB)\n   */\n  static isMastraMessage(msg: MessageInput): msg is MastraDBMessage | MastraMessageV1 {\n    return TypeDetector.isMastraDBMessage(msg) || TypeDetector.isMastraMessageV1(msg);\n  }\n\n  /**\n   * Check if a message is an AIV4 UIMessage\n   */\n  static isAIV4UIMessage(msg: MessageInput): msg is UIMessageV4 {\n    return (\n      !TypeDetector.isMastraMessage(msg) &&\n      !TypeDetector.isAIV4CoreMessage(msg) &&\n      'parts' in msg &&\n      !TypeDetector.hasAIV5UIMessageCharacteristics(msg)\n    );\n  }\n\n  /**\n   * Check if a message is an AIV5 UIMessage\n   */\n  static isAIV5UIMessage(msg: MessageInput): msg is AIV5Type.UIMessage {\n    return (\n      !TypeDetector.isMastraMessage(msg) &&\n      !TypeDetector.isAIV5CoreMessage(msg) &&\n      'parts' in msg &&\n      TypeDetector.hasAIV5UIMessageCharacteristics(msg)\n    );\n  }\n\n  /**\n   * Check if a message is an AIV4 CoreMessage\n   */\n  static isAIV4CoreMessage(msg: MessageInput): msg is CoreMessageV4 {\n    // V4 CoreMessage has role and content like V5, but content can be array of parts\n    return (\n      !TypeDetector.isMastraMessage(msg) &&\n      !('parts' in msg) &&\n      'content' in msg &&\n      !TypeDetector.hasAIV5CoreMessageCharacteristics(msg)\n    );\n  }\n\n  /**\n   * Check if a message is an AIV5 ModelMessage (CoreMessage equivalent)\n   */\n  static isAIV5CoreMessage(msg: MessageInput): msg is AIV5Type.ModelMessage {\n    return (\n      !TypeDetector.isMastraMessage(msg) &&\n      !('parts' in msg) &&\n      'content' in msg &&\n      TypeDetector.hasAIV5CoreMessageCharacteristics(msg)\n    );\n  }\n\n  /**\n   * Check if a message has AIV5 UIMessage characteristics\n   *\n   * V5 UIMessages have specific part types and field names that differ from V4\n   */\n  static hasAIV5UIMessageCharacteristics(\n    msg: AIV5Type.UIMessage | UIMessageV4 | AIV4Message,\n  ): msg is AIV5Type.UIMessage {\n    // ai v4 has these separated arrays of parts that don't record overall order\n    // so we can check for their presence as a faster/early check\n    if (\n      'toolInvocations' in msg ||\n      'reasoning' in msg ||\n      'experimental_attachments' in msg ||\n      'data' in msg ||\n      'annotations' in msg\n      // don't check `content` in msg because it fully narrows the type to v5 and there's a chance someone might mess up and add content to a v5 message, that's more likely than the other keys\n    )\n      return false;\n\n    if (!msg.parts) return false; // this is likely an AIV4Type.Message\n\n    for (const part of msg.parts) {\n      if ('metadata' in part) return true;\n\n      // tools are annoying cause ai v5 has the type as\n      // tool-${toolName}\n      // in v4 we had tool-invocation\n      // technically\n      // v4 tool\n      if ('toolInvocation' in part) return false;\n      // v5 tool\n      if ('toolCallId' in part) return true;\n\n      if (part.type === 'source') return false;\n      if (part.type === 'source-url') return true;\n\n      if (part.type === 'reasoning') {\n        if ('state' in part || 'text' in part) return true; // v5\n        if ('reasoning' in part || 'details' in part) return false; // v4\n      }\n\n      if (part.type === 'file' && 'mediaType' in part) return true;\n    }\n\n    return false; // default to v4 for backwards compat\n  }\n\n  /**\n   * Check if a message has AIV5 CoreMessage characteristics\n   *\n   * V5 ModelMessages use different field names (output vs result, input vs args, mediaType vs mimeType)\n   */\n  static hasAIV5CoreMessageCharacteristics(\n    msg:\n      | CoreMessageV4\n      | AIV5Type.ModelMessage\n      // This is here because AIV4 \"Message\" type can omit parts! ðŸ˜±\n      | AIV4Message,\n  ): msg is AIV5Type.ModelMessage {\n    if ('experimental_providerMetadata' in msg) return false; // is v4 cause v5 doesn't have this property\n\n    // String content is identical in both v4 and v5, so we can safely treat it as v5-compatible\n    // This doesn't misclassify v4 messages because the format is the same\n    if (typeof msg.content === 'string') return true;\n\n    for (const part of msg.content) {\n      if (part.type === 'tool-result' && 'output' in part) return true; // v5 renamed result->output,\n      if (part.type === 'tool-call' && 'input' in part) return true; // v5 renamed args->input\n      if (part.type === 'tool-result' && 'result' in part) return false; // v5 renamed result->output,\n      if (part.type === 'tool-call' && 'args' in part) return false; // v5 renamed args->input\n\n      // for file and image\n      if ('mediaType' in part) return true; // v5 renamed mimeType->mediaType\n      if ('mimeType' in part) return false;\n\n      // applies to multiple part types\n      if ('experimental_providerMetadata' in part) return false; // was in v4 but deprecated for providerOptions, v4+5 have providerOptions though, can't check the other way\n\n      if (part.type === 'reasoning' && 'signature' in part) return false; // v5 doesn't have signature, which is optional in v4\n\n      if (part.type === 'redacted-reasoning') return false; // only in v4, seems like in v5 they add it to providerOptions or something?\n    }\n\n    // If no distinguishing features were found, the message format is identical in v4 and v5\n    // We return true (v5-compatible) because the message can be used as-is with v5\n    return true;\n  }\n\n  /**\n   * Get the normalized role for a message\n   * Maps 'tool' role to 'assistant' since tool messages are displayed as part of assistant conversation\n   */\n  static getRole(message: MessageInput): MastraDBMessage['role'] {\n    if (message.role === 'assistant' || message.role === 'tool') return 'assistant';\n    if (message.role === 'user') return 'user';\n    if (message.role === 'system') return 'system';\n    throw new Error(\n      `BUG: add handling for message role ${message.role} in message ${JSON.stringify(message, null, 2)}`,\n    );\n  }\n}\n","import { convertUint8ArrayToBase64 } from '@ai-sdk/provider-utils-v5';\nimport { z } from 'zod';\n\n/**\nData content. Can either be a base64-encoded string, a Uint8Array, an ArrayBuffer, or a Buffer.\n */\nexport type DataContent = string | Uint8Array | ArrayBuffer | Buffer;\n\n/**\n@internal\n */\nexport const dataContentSchema: z.ZodType<DataContent> = z.union([\n  z.string(),\n  z.instanceof(Uint8Array),\n  z.instanceof(ArrayBuffer),\n  z.custom(\n    // Buffer might not be available in some environments such as CloudFlare:\n    (value: unknown): value is Buffer => globalThis.Buffer?.isBuffer(value) ?? false,\n    { message: 'Must be a Buffer' },\n  ),\n]);\n\n/**\nConverts data content to a base64-encoded string.\n\n@param content - Data content to convert.\n@returns Base64-encoded string.\n*/\nexport function convertDataContentToBase64String(content: DataContent): string {\n  if (typeof content === 'string') {\n    return content;\n  }\n\n  if (content instanceof ArrayBuffer) {\n    return convertUint8ArrayToBase64(new Uint8Array(content));\n  }\n\n  return convertUint8ArrayToBase64(content);\n}\n","import { convertDataContentToBase64String } from './data-content';\n\n/**\n * Image content can be a string (URL or data URI), a URL object, or binary data\n */\nexport type ImageContent = string | URL | Uint8Array | ArrayBuffer | Buffer;\n\n/**\n * Represents the parsed components of a data URI\n */\nexport interface DataUriParts {\n  mimeType?: string;\n  base64Content: string;\n  isDataUri: boolean;\n}\n\n/**\n * Parses a data URI string into its components.\n * Format: data:[<mediatype>][;base64],<data>\n *\n * @param dataUri - The data URI string to parse\n * @returns Parsed components including MIME type and base64 content\n */\nexport function parseDataUri(dataUri: string): DataUriParts {\n  if (!dataUri.startsWith('data:')) {\n    return {\n      isDataUri: false,\n      base64Content: dataUri,\n    };\n  }\n\n  const base64Index = dataUri.indexOf(',');\n  if (base64Index === -1) {\n    // Malformed data URI, return as-is\n    return {\n      isDataUri: true,\n      base64Content: dataUri,\n    };\n  }\n\n  const header = dataUri.substring(5, base64Index); // Skip 'data:' prefix\n  const base64Content = dataUri.substring(base64Index + 1);\n\n  // Extract MIME type from header (before ';base64' or ';')\n  const semicolonIndex = header.indexOf(';');\n  const mimeType = semicolonIndex !== -1 ? header.substring(0, semicolonIndex) : header;\n\n  return {\n    isDataUri: true,\n    mimeType: mimeType || undefined,\n    base64Content,\n  };\n}\n\n/**\n * Creates a data URI from base64 content and MIME type.\n *\n * @param base64Content - The base64 encoded content\n * @param mimeType - The MIME type (defaults to 'application/octet-stream')\n * @returns A properly formatted data URI\n */\nexport function createDataUri(base64Content: string, mimeType: string = 'application/octet-stream'): string {\n  // If it's already a data URI, return as-is\n  if (base64Content.startsWith('data:')) {\n    return base64Content;\n  }\n  return `data:${mimeType};base64,${base64Content}`;\n}\n\n/**\n * Converts various image data formats to a string representation.\n * - Strings are returned as-is (could be URLs or data URIs)\n * - URL objects are converted to strings\n * - Binary data (Uint8Array, ArrayBuffer, Buffer) is converted to base64\n *\n * @param image - The image data in various formats\n * @param fallbackMimeType - MIME type to use when creating data URIs from binary data\n * @returns String representation of the image (URL, data URI, or base64)\n */\nexport function imageContentToString(image: ImageContent, fallbackMimeType?: string): string {\n  if (typeof image === 'string') {\n    return image;\n  }\n\n  if (image instanceof URL) {\n    return image.toString();\n  }\n\n  if (image instanceof Uint8Array || image instanceof ArrayBuffer || (globalThis.Buffer && Buffer.isBuffer(image))) {\n    // Convert binary data to base64\n    const base64 = convertDataContentToBase64String(image);\n    // If it's not already a data URI, create one\n    if (fallbackMimeType && !base64.startsWith('data:')) {\n      return `data:${fallbackMimeType};base64,${base64}`;\n    }\n    return base64;\n  }\n\n  // Fallback for unknown types - try to convert to string\n  return String(image);\n}\n\n/**\n * Converts various image data formats to a data URI string.\n *\n * @param image - The image data in various formats\n * @param mimeType - MIME type for the data URI (defaults to 'image/png')\n * @returns Data URI string\n */\nexport function imageContentToDataUri(image: ImageContent, mimeType: string = 'image/png'): string {\n  const imageStr = imageContentToString(image, mimeType);\n\n  // If it's already a data URI, return as-is\n  if (imageStr.startsWith('data:')) {\n    return imageStr;\n  }\n\n  // If it's an HTTP(S) URL, return as-is (can't convert to data URI)\n  if (imageStr.startsWith('http://') || imageStr.startsWith('https://')) {\n    return imageStr;\n  }\n\n  // Otherwise, assume it's base64 and create a data URI\n  return `data:${mimeType};base64,${imageStr}`;\n}\n\n/**\n * Gets a stable cache key component for image content.\n * Used for generating hash keys for caching purposes.\n *\n * @param image - The image data in various formats\n * @returns A string or number suitable for cache key generation\n */\nexport function getImageCacheKey(image: ImageContent): string | number {\n  if (image instanceof URL) {\n    return image.toString();\n  }\n\n  if (typeof image === 'string') {\n    return image.length;\n  }\n\n  if (image instanceof Uint8Array) {\n    return image.byteLength;\n  }\n\n  if (image instanceof ArrayBuffer) {\n    return image.byteLength;\n  }\n\n  return image;\n}\n\n/**\n * Checks if a string is a valid URL (including protocol-relative URLs).\n *\n * @param str - The string to check\n * @returns true if the string is a valid URL\n */\nexport function isValidUrl(str: string): boolean {\n  try {\n    new URL(str);\n    return true;\n  } catch {\n    // Try as protocol-relative URL\n    if (str.startsWith('//')) {\n      try {\n        new URL(`https:${str}`);\n        return true;\n      } catch {\n        return false;\n      }\n    }\n    return false;\n  }\n}\n\n/**\n * Categorizes a string as a URL, data URI, or raw data (base64/other).\n * Also extracts MIME type from data URIs when present.\n *\n * @param data - The string data to categorize\n * @param fallbackMimeType - Optional fallback MIME type\n * @returns Categorized data with type and extracted MIME type\n */\nexport function categorizeFileData(\n  data: string,\n  fallbackMimeType?: string,\n): {\n  type: 'url' | 'dataUri' | 'raw';\n  mimeType?: string;\n  data: string;\n} {\n  // Parse as data URI first to extract MIME type\n  const parsed = parseDataUri(data);\n  const mimeType = parsed.isDataUri && parsed.mimeType ? parsed.mimeType : fallbackMimeType;\n\n  // Check if it's a data URI\n  if (parsed.isDataUri) {\n    return {\n      type: 'dataUri',\n      mimeType,\n      data,\n    };\n  }\n\n  // Check if it's a URL\n  if (isValidUrl(data)) {\n    return {\n      type: 'url',\n      mimeType,\n      data,\n    };\n  }\n\n  // Otherwise it's raw data (likely base64 or other string data)\n  return {\n    type: 'raw',\n    mimeType,\n    data,\n  };\n}\n\n/**\n * Classifies a string as a URL, data URI, or raw data.\n *\n * @param data - The string to classify\n * @returns Object with classification and extracted metadata\n */\nexport function classifyFileData(data: string): {\n  type: 'url' | 'dataUri' | 'base64' | 'other';\n  mimeType?: string;\n} {\n  // Check if it's a data URI\n  const parsed = parseDataUri(data);\n  if (parsed.isDataUri) {\n    return {\n      type: 'dataUri',\n      mimeType: parsed.mimeType,\n    };\n  }\n\n  // Check if it's a URL\n  if (isValidUrl(data)) {\n    return { type: 'url' };\n  }\n\n  // Check if it looks like base64 (simple heuristic)\n  if (/^[A-Za-z0-9+/\\-_]+=*$/.test(data) && data.length > 20) {\n    return { type: 'base64' };\n  }\n\n  return { type: 'other' };\n}\n","import type { CoreMessage as CoreMessageV4 } from '@internal/ai-sdk-v4';\nimport type { ModelMessage, ToolResultPart } from '@internal/ai-sdk-v5';\n\nimport { MastraError, ErrorDomain, ErrorCategory } from '../../../error';\nimport type { MastraDBMessage } from '../state/types';\n\n/**\n * Tool result with input field (Anthropic requirement)\n */\nexport type ToolResultWithInput = ToolResultPart & {\n  input: Record<string, unknown>;\n};\n\n// ============================================================================\n// Gemini Compatibility\n// ============================================================================\n\n/**\n * Ensures message array is compatible with Gemini API requirements.\n *\n * Gemini API requires:\n * 1. The first non-system message must be from the user role\n * 2. Cannot have only system messages - at least one user/assistant is required\n *\n * @param messages - Array of model messages to validate and fix\n * @returns Modified messages array that satisfies Gemini requirements\n * @throws MastraError if no user or assistant messages are present\n *\n * @see https://github.com/mastra-ai/mastra/issues/7287 - Tool call ordering\n * @see https://github.com/mastra-ai/mastra/issues/8053 - Single turn validation\n */\nexport function ensureGeminiCompatibleMessages<T extends ModelMessage | CoreMessageV4>(messages: T[]): T[] {\n  const result = [...messages];\n\n  // Ensure first non-system message is user\n  const firstNonSystemIndex = result.findIndex(m => m.role !== 'system');\n\n  if (firstNonSystemIndex === -1) {\n    // Only system messages or empty - this is an error condition\n    throw new MastraError({\n      id: 'NO_USER_OR_ASSISTANT_MESSAGES',\n      domain: ErrorDomain.AGENT,\n      category: ErrorCategory.USER,\n      text: 'This request does not contain any user or assistant messages. At least one user or assistant message is required to generate a response.',\n    });\n  } else if (result[firstNonSystemIndex]?.role === 'assistant') {\n    // First non-system is assistant, insert user message before it\n    result.splice(firstNonSystemIndex, 0, {\n      role: 'user',\n      content: '.',\n    } as T);\n  }\n\n  return result;\n}\n\n// ============================================================================\n// Anthropic Compatibility\n// ============================================================================\n\n/**\n * Ensures model messages are compatible with Anthropic API requirements.\n *\n * Anthropic API requires tool-result parts to include an 'input' field\n * that matches the original tool call arguments.\n *\n * @param messages - Array of model messages to transform\n * @param dbMessages - MastraDB messages to look up tool call args from\n * @returns Messages with tool-result parts enriched with input field\n *\n * @see https://github.com/mastra-ai/mastra/issues/11376 - Anthropic models fail with empty object tool input\n */\nexport function ensureAnthropicCompatibleMessages(\n  messages: ModelMessage[],\n  dbMessages: MastraDBMessage[],\n): ModelMessage[] {\n  return messages.map(msg => enrichToolResultsWithInput(msg, dbMessages));\n}\n\n/**\n * Enriches a single message's tool-result parts with input field\n */\nfunction enrichToolResultsWithInput(message: ModelMessage, dbMessages: MastraDBMessage[]): ModelMessage {\n  if (message.role !== 'tool' || !Array.isArray(message.content)) {\n    return message;\n  }\n\n  return {\n    ...message,\n    content: message.content.map(part => {\n      if (part.type === 'tool-result') {\n        return {\n          ...part,\n          input: findToolCallArgs(dbMessages, part.toolCallId),\n        } as ToolResultWithInput;\n      }\n      return part;\n    }),\n  } as ModelMessage;\n}\n\n// ============================================================================\n// OpenAI Compatibility\n// ============================================================================\n\n/**\n * Checks if a message part has OpenAI reasoning itemId\n *\n * OpenAI reasoning items are tracked via `providerMetadata.openai.itemId` (e.g., `rs_...`).\n * Each reasoning item has a unique itemId that must be preserved for proper deduplication.\n *\n * @param part - A message part to check\n * @returns true if the part has an OpenAI itemId\n *\n * @see https://github.com/mastra-ai/mastra/issues/9005 - OpenAI reasoning items filtering\n */\nexport function hasOpenAIReasoningItemId(part: unknown): boolean {\n  if (!part || typeof part !== 'object') return false;\n  const partAny = part as Record<string, unknown>;\n\n  if (!('providerMetadata' in partAny) || !partAny.providerMetadata) return false;\n  const metadata = partAny.providerMetadata as Record<string, unknown>;\n\n  if (!('openai' in metadata) || !metadata.openai) return false;\n  const openai = metadata.openai as Record<string, unknown>;\n\n  return 'itemId' in openai && typeof openai.itemId === 'string';\n}\n\n/**\n * Extracts the OpenAI itemId from a message part if present\n *\n * @param part - A message part to extract from\n * @returns The itemId string or undefined if not present\n */\nexport function getOpenAIReasoningItemId(part: unknown): string | undefined {\n  if (!hasOpenAIReasoningItemId(part)) return undefined;\n\n  const partAny = part as Record<string, unknown>;\n  const metadata = partAny.providerMetadata as Record<string, unknown>;\n  const openai = metadata.openai as Record<string, unknown>;\n\n  return openai.itemId as string;\n}\n\n// ============================================================================\n// Tool Call Args Lookup\n// ============================================================================\n\n/**\n * Finds the tool call args for a given toolCallId by searching through messages.\n * This is used to reconstruct the input field when converting tool-result parts to StaticToolResult.\n *\n * Searches through messages in reverse order (most recent first) for better performance.\n * Checks both content.parts (v2 format) and toolInvocations (legacy AIV4 format).\n *\n * @param messages - Array of MastraDB messages to search through\n * @param toolCallId - The ID of the tool call to find args for\n * @returns The args object from the matching tool call, or an empty object if not found\n */\nexport function findToolCallArgs(messages: MastraDBMessage[], toolCallId: string): Record<string, unknown> {\n  // Search through all messages in reverse order (most recent first) for better performance\n  for (let i = messages.length - 1; i >= 0; i--) {\n    const msg = messages[i];\n    if (!msg || msg.role !== 'assistant') {\n      continue;\n    }\n\n    // Check both content.parts (v2 format) and toolInvocations (legacy format)\n    if (msg.content.parts) {\n      // Look for tool-invocation with matching toolCallId (can be in 'call' or 'result' state)\n      const toolCallPart = msg.content.parts.find(\n        p => p.type === 'tool-invocation' && p.toolInvocation.toolCallId === toolCallId,\n      );\n\n      if (toolCallPart && toolCallPart.type === 'tool-invocation') {\n        // Return the args even if it's undefined or empty object\n        return toolCallPart.toolInvocation.args || {};\n      }\n    }\n\n    // Also check toolInvocations array (AIV4 format)\n    if (msg.content.toolInvocations) {\n      const toolInvocation = msg.content.toolInvocations.find(inv => inv.toolCallId === toolCallId);\n\n      if (toolInvocation) {\n        return toolInvocation.args || {};\n      }\n    }\n  }\n\n  // If not found in DB messages, return empty object\n  return {};\n}\n","import type {\n  UIMessage as UIMessageV4,\n  CoreMessage as CoreMessageV4,\n  ToolInvocation as ToolInvocationV4,\n} from '@internal/ai-sdk-v4';\n\nimport { MastraError, ErrorDomain, ErrorCategory } from '../../../error';\nimport { TypeDetector } from '../detection/TypeDetector';\nimport { convertDataContentToBase64String } from '../prompt/data-content';\nimport { categorizeFileData, createDataUri, imageContentToString } from '../prompt/image-utils';\nimport type {\n  MastraDBMessage,\n  MastraMessageContentV2,\n  MastraMessagePart,\n  UIMessageV4Part,\n  MessageSource,\n  UIMessageWithMetadata,\n} from '../state/types';\nimport { findToolCallArgs } from '../utils/provider-compat';\n\n/**\n * Filter out data-* parts from MastraMessagePart[] to get V4-compatible parts.\n * Data parts are a Mastra extension for custom streaming data and aren't supported by AI SDK V4.\n */\nfunction filterDataParts(parts: MastraMessagePart[]): UIMessageV4Part[] {\n  return parts.filter((part): part is UIMessageV4Part => !part.type.startsWith('data-'));\n}\n\n// Re-export for backward compatibility\nexport type { UIMessageWithMetadata };\n\nexport interface AIV4AdapterContext {\n  memoryInfo: { threadId?: string; resourceId?: string } | null;\n  newMessageId(): string;\n  generateCreatedAt(messageSource: MessageSource, start?: unknown): Date;\n  /** Messages array for looking up tool call args */\n  dbMessages?: MastraDBMessage[];\n}\n\n/**\n * AIV4Adapter - Handles conversions between MastraDBMessage and AI SDK V4 formats\n *\n * This adapter centralizes all AI SDK V4 (UIMessage and CoreMessage) conversion logic.\n */\nexport class AIV4Adapter {\n  /**\n   * Convert MastraDBMessage to AI SDK V4 UIMessage\n   */\n  static toUIMessage(m: MastraDBMessage): UIMessageWithMetadata {\n    const experimentalAttachments: UIMessageWithMetadata['experimental_attachments'] = m.content\n      .experimental_attachments\n      ? [...m.content.experimental_attachments]\n      : [];\n    const contentString =\n      typeof m.content.content === `string` && m.content.content !== ''\n        ? m.content.content\n        : (m.content.parts ?? []).reduce((prev, part) => {\n            if (part.type === `text`) {\n              // return only the last text part like AI SDK does\n              return part.text;\n            }\n            return prev;\n          }, '');\n\n    const parts: MastraMessageContentV2['parts'] = [];\n    const sourceParts = m.content.parts ?? [];\n\n    if (sourceParts.length) {\n      for (const part of sourceParts) {\n        if (part.type === `file`) {\n          // Normalize part.data to ensure it's a valid URL or data URI\n          let normalizedUrl: string;\n          if (typeof part.data === 'string') {\n            const categorized = categorizeFileData(part.data, part.mimeType);\n            if (categorized.type === 'raw') {\n              // Raw base64 - convert to data URI\n              normalizedUrl = createDataUri(part.data, part.mimeType || 'application/octet-stream');\n            } else {\n              // Already a URL or data URI\n              normalizedUrl = part.data;\n            }\n          } else {\n            // It's a non-string (shouldn't happen in practice for file parts, but handle it)\n            normalizedUrl = part.data;\n          }\n\n          experimentalAttachments.push({\n            contentType: part.mimeType,\n            url: normalizedUrl,\n          });\n        } else if (\n          part.type === 'tool-invocation' &&\n          (part.toolInvocation.state === 'call' || part.toolInvocation.state === 'partial-call')\n        ) {\n          // Filter out tool invocations with call or partial-call states\n          continue;\n        } else if (part.type === 'tool-invocation') {\n          // Handle tool invocations with step number logic\n          const toolInvocation = { ...part.toolInvocation };\n\n          // Find the step number for this tool invocation\n          let currentStep = -1;\n          let toolStep = -1;\n          for (const innerPart of sourceParts) {\n            if (innerPart.type === `step-start`) currentStep++;\n            if (\n              innerPart.type === `tool-invocation` &&\n              innerPart.toolInvocation.toolCallId === part.toolInvocation.toolCallId\n            ) {\n              toolStep = currentStep;\n              break;\n            }\n          }\n\n          if (toolStep >= 0) {\n            const preparedInvocation = {\n              step: toolStep,\n              ...toolInvocation,\n            };\n            parts.push({\n              type: 'tool-invocation',\n              toolInvocation: preparedInvocation,\n            });\n          } else {\n            parts.push({\n              type: 'tool-invocation',\n              toolInvocation,\n            });\n          }\n        } else {\n          parts.push(part);\n        }\n      }\n    }\n\n    if (parts.length === 0 && experimentalAttachments.length > 0) {\n      // make sure we have atleast one part so this message doesn't get removed when converting to core message\n      parts.push({ type: 'text', text: '' });\n    }\n\n    // Filter out data-* parts when converting to UIMessageV4 (V4 doesn't support them)\n    const v4Parts = filterDataParts(parts);\n\n    if (m.role === `user`) {\n      const uiMessage: UIMessageWithMetadata = {\n        id: m.id,\n        role: m.role,\n        content: m.content.content || contentString,\n        createdAt: m.createdAt,\n        parts: v4Parts,\n        experimental_attachments: experimentalAttachments,\n      };\n      // Preserve metadata if present\n      if (m.content.metadata) {\n        uiMessage.metadata = m.content.metadata;\n      }\n      return uiMessage;\n    } else if (m.role === `assistant`) {\n      const isSingleTextContentArray =\n        Array.isArray(m.content.content) && m.content.content.length === 1 && m.content.content[0].type === `text`;\n\n      const uiMessage: UIMessageWithMetadata = {\n        id: m.id,\n        role: m.role,\n        content: isSingleTextContentArray ? contentString : m.content.content || contentString,\n        createdAt: m.createdAt,\n        parts: v4Parts,\n        reasoning: undefined,\n        toolInvocations:\n          `toolInvocations` in m.content ? m.content.toolInvocations?.filter(t => t.state === 'result') : undefined,\n      };\n      // Preserve metadata if present\n      if (m.content.metadata) {\n        uiMessage.metadata = m.content.metadata;\n      }\n      return uiMessage;\n    }\n\n    const uiMessage: UIMessageWithMetadata = {\n      id: m.id,\n      role: m.role,\n      content: m.content.content || contentString,\n      createdAt: m.createdAt,\n      parts: v4Parts,\n      experimental_attachments: experimentalAttachments,\n    };\n    // Preserve metadata if present\n    if (m.content.metadata) {\n      uiMessage.metadata = m.content.metadata;\n    }\n    return uiMessage;\n  }\n\n  /**\n   * Converts a MastraDBMessage system message directly to AIV4 CoreMessage format\n   */\n  static systemToV4Core(message: MastraDBMessage): CoreMessageV4 {\n    if (message.role !== `system` || !message.content.content)\n      throw new MastraError({\n        id: 'INVALID_SYSTEM_MESSAGE_FORMAT',\n        domain: ErrorDomain.AGENT,\n        category: ErrorCategory.USER,\n        text: `Invalid system message format. System messages must include 'role' and 'content' properties. The content should be a string.`,\n        details: {\n          receivedMessage: JSON.stringify(message, null, 2),\n        },\n      });\n\n    const coreMessage: CoreMessageV4 = { role: 'system', content: message.content.content };\n\n    // Preserve message-level providerMetadata as experimental_providerMetadata (V4 field name)\n    if (message.content.providerMetadata) {\n      coreMessage.experimental_providerMetadata = message.content.providerMetadata;\n    }\n\n    return coreMessage;\n  }\n\n  /**\n   * Convert AI SDK V4 UIMessage to MastraDBMessage\n   */\n  static fromUIMessage(\n    message: UIMessageV4 | UIMessageWithMetadata,\n    ctx: AIV4AdapterContext,\n    messageSource: MessageSource,\n  ): MastraDBMessage {\n    const content: MastraMessageContentV2 = {\n      format: 2,\n      parts: message.parts,\n    };\n\n    if (message.toolInvocations) content.toolInvocations = message.toolInvocations;\n    if (message.reasoning) content.reasoning = message.reasoning;\n    if (message.annotations) content.annotations = message.annotations;\n    if (message.experimental_attachments) {\n      content.experimental_attachments = message.experimental_attachments;\n    }\n    // Preserve metadata field if present\n    if ('metadata' in message && message.metadata !== null && message.metadata !== undefined) {\n      content.metadata = message.metadata as Record<string, unknown>;\n    }\n\n    return {\n      id: message.id || ctx.newMessageId(),\n      role: TypeDetector.getRole(message),\n      createdAt: ctx.generateCreatedAt(messageSource, message.createdAt),\n      threadId: ctx.memoryInfo?.threadId,\n      resourceId: ctx.memoryInfo?.resourceId,\n      content,\n    } satisfies MastraDBMessage;\n  }\n\n  /**\n   * Convert AI SDK V4 CoreMessage to MastraDBMessage\n   */\n  static fromCoreMessage(\n    coreMessage: CoreMessageV4,\n    ctx: AIV4AdapterContext,\n    messageSource: MessageSource,\n  ): MastraDBMessage {\n    const id = `id` in coreMessage ? (coreMessage.id as string) : ctx.newMessageId();\n    const parts: UIMessageV4['parts'] = [];\n    const experimentalAttachments: UIMessageV4['experimental_attachments'] = [];\n    const toolInvocations: ToolInvocationV4[] = [];\n\n    const isSingleTextContent =\n      messageSource === `response` &&\n      Array.isArray(coreMessage.content) &&\n      coreMessage.content.length === 1 &&\n      coreMessage.content[0] &&\n      coreMessage.content[0].type === `text` &&\n      `text` in coreMessage.content[0] &&\n      coreMessage.content[0].text;\n\n    if (isSingleTextContent && messageSource === `response`) {\n      coreMessage.content = isSingleTextContent;\n    }\n\n    if (typeof coreMessage.content === 'string') {\n      parts.push({\n        type: 'text',\n        text: coreMessage.content,\n      });\n    } else if (Array.isArray(coreMessage.content)) {\n      for (const aiV4Part of coreMessage.content) {\n        switch (aiV4Part.type) {\n          case 'text': {\n            // Add step-start only after tool invocations, not at the beginning\n            const prevPart = parts.at(-1);\n            if (coreMessage.role === 'assistant' && prevPart && prevPart.type === 'tool-invocation') {\n              parts.push({ type: 'step-start' });\n            }\n\n            const part: MastraDBMessage['content']['parts'][number] = {\n              type: 'text' as const,\n              text: aiV4Part.text,\n            };\n            if (aiV4Part.providerOptions) {\n              part.providerMetadata = aiV4Part.providerOptions;\n            }\n            parts.push(part);\n            break;\n          }\n\n          case 'tool-call': {\n            const part: MastraDBMessage['content']['parts'][number] = {\n              type: 'tool-invocation' as const,\n              toolInvocation: {\n                state: 'call',\n                toolCallId: aiV4Part.toolCallId,\n                toolName: aiV4Part.toolName,\n                args: aiV4Part.args,\n              },\n            };\n            if (aiV4Part.providerOptions) {\n              part.providerMetadata = aiV4Part.providerOptions;\n            }\n            parts.push(part);\n            break;\n          }\n\n          case 'tool-result':\n            {\n              // Try to find args from the corresponding tool-call in previous messages\n              let toolArgs: Record<string, unknown> = {};\n\n              // First, check if there's a tool-call in the same message\n              const toolCallInSameMsg = coreMessage.content.find(\n                p => p.type === 'tool-call' && p.toolCallId === aiV4Part.toolCallId,\n              );\n              if (toolCallInSameMsg && toolCallInSameMsg.type === 'tool-call') {\n                toolArgs = toolCallInSameMsg.args as Record<string, unknown>;\n              }\n\n              // If not found, look in previous messages for the corresponding tool-call\n              if (Object.keys(toolArgs).length === 0 && ctx.dbMessages) {\n                toolArgs = findToolCallArgs(ctx.dbMessages, aiV4Part.toolCallId);\n              }\n\n              // Only use part-level providerOptions if present\n              const invocation: ToolInvocationV4 = {\n                state: 'result' as const,\n                toolCallId: aiV4Part.toolCallId,\n                toolName: aiV4Part.toolName,\n                result: aiV4Part.result ?? '',\n                args: toolArgs,\n              };\n\n              const part: MastraDBMessage['content']['parts'][number] = {\n                type: 'tool-invocation',\n                toolInvocation: invocation,\n              };\n\n              if (aiV4Part.providerOptions) {\n                part.providerMetadata = aiV4Part.providerOptions;\n              }\n\n              parts.push(part);\n              toolInvocations.push(invocation);\n            }\n            break;\n\n          case 'reasoning':\n            {\n              const part: MastraDBMessage['content']['parts'][number] = {\n                type: 'reasoning',\n                reasoning: '',\n                details: [{ type: 'text', text: aiV4Part.text, signature: aiV4Part.signature }],\n              };\n              if (aiV4Part.providerOptions) {\n                part.providerMetadata = aiV4Part.providerOptions;\n              }\n              parts.push(part);\n            }\n            break;\n          case 'redacted-reasoning':\n            {\n              const part: MastraDBMessage['content']['parts'][number] = {\n                type: 'reasoning',\n                reasoning: '',\n                details: [{ type: 'redacted', data: aiV4Part.data }],\n              };\n              if (aiV4Part.providerOptions) {\n                part.providerMetadata = aiV4Part.providerOptions;\n              }\n              parts.push(part);\n            }\n            break;\n          case 'image': {\n            const part: MastraDBMessage['content']['parts'][number] = {\n              type: 'file' as const,\n              data: imageContentToString(aiV4Part.image),\n              mimeType: aiV4Part.mimeType!,\n            };\n            if (aiV4Part.providerOptions) {\n              part.providerMetadata = aiV4Part.providerOptions;\n            }\n            parts.push(part);\n            break;\n          }\n          case 'file': {\n            if (aiV4Part.data instanceof URL) {\n              const part: MastraDBMessage['content']['parts'][number] = {\n                type: 'file' as const,\n                data: aiV4Part.data.toString(),\n                mimeType: aiV4Part.mimeType,\n              };\n              if (aiV4Part.providerOptions) {\n                part.providerMetadata = aiV4Part.providerOptions;\n              }\n              parts.push(part);\n            } else if (typeof aiV4Part.data === 'string') {\n              const categorized = categorizeFileData(aiV4Part.data, aiV4Part.mimeType);\n\n              if (categorized.type === 'url' || categorized.type === 'dataUri') {\n                const part: MastraDBMessage['content']['parts'][number] = {\n                  type: 'file' as const,\n                  data: aiV4Part.data,\n                  mimeType: categorized.mimeType || 'image/png',\n                };\n                if (aiV4Part.providerOptions) {\n                  part.providerMetadata = aiV4Part.providerOptions;\n                }\n                parts.push(part);\n              } else {\n                try {\n                  const part: MastraDBMessage['content']['parts'][number] = {\n                    type: 'file' as const,\n                    mimeType: categorized.mimeType || 'image/png',\n                    data: convertDataContentToBase64String(aiV4Part.data),\n                  };\n                  if (aiV4Part.providerOptions) {\n                    part.providerMetadata = aiV4Part.providerOptions;\n                  }\n                  parts.push(part);\n                } catch (error) {\n                  console.error(`Failed to convert binary data to base64 in CoreMessage file part: ${error}`, error);\n                }\n              }\n            } else {\n              try {\n                const part: MastraDBMessage['content']['parts'][number] = {\n                  type: 'file' as const,\n                  mimeType: aiV4Part.mimeType,\n                  data: convertDataContentToBase64String(aiV4Part.data),\n                };\n                if (aiV4Part.providerOptions) {\n                  part.providerMetadata = aiV4Part.providerOptions;\n                }\n                parts.push(part);\n              } catch (error) {\n                console.error(`Failed to convert binary data to base64 in CoreMessage file part: ${error}`, error);\n              }\n            }\n            break;\n          }\n        }\n      }\n    }\n\n    const content: MastraDBMessage['content'] = {\n      format: 2,\n      parts,\n    };\n\n    if (toolInvocations.length) content.toolInvocations = toolInvocations;\n    if (typeof coreMessage.content === `string`) content.content = coreMessage.content;\n\n    if (experimentalAttachments.length) content.experimental_attachments = experimentalAttachments;\n\n    // V4 uses experimental_providerMetadata, V5 uses providerOptions\n    if (coreMessage.providerOptions) {\n      content.providerMetadata = coreMessage.providerOptions;\n    } else if ('experimental_providerMetadata' in coreMessage && coreMessage.experimental_providerMetadata) {\n      content.providerMetadata = coreMessage.experimental_providerMetadata;\n    }\n\n    if ('metadata' in coreMessage && coreMessage.metadata !== null && coreMessage.metadata !== undefined) {\n      content.metadata = coreMessage.metadata as Record<string, unknown>;\n    }\n\n    const rawCreatedAt =\n      'metadata' in coreMessage &&\n      coreMessage.metadata &&\n      typeof coreMessage.metadata === 'object' &&\n      'createdAt' in coreMessage.metadata\n        ? coreMessage.metadata.createdAt\n        : undefined;\n\n    return {\n      id,\n      role: TypeDetector.getRole(coreMessage),\n      createdAt: ctx.generateCreatedAt(messageSource, rawCreatedAt),\n      threadId: ctx.memoryInfo?.threadId,\n      resourceId: ctx.memoryInfo?.resourceId,\n      content,\n    } satisfies MastraDBMessage;\n  }\n}\n","import type { ToolInvocationUIPart } from '@ai-sdk/ui-utils-v5';\nimport * as AIV5 from '@internal/ai-sdk-v5';\n\nimport { MastraError, ErrorDomain, ErrorCategory } from '../../../error';\nimport { categorizeFileData, createDataUri, parseDataUri } from '../prompt/image-utils';\nimport type { MastraDBMessage, MastraMessageContentV2, MessageSource } from '../state/types';\nimport type { AIV5Type } from '../types';\n\n/**\n * Extract tool name from AI SDK v5 tool type string\n *\n * V5 format: \"tool-${toolName}\" or \"dynamic-tool\"\n * V4 format: \"tool-invocation\"\n *\n * @param type - The tool type string from AI SDK v5\n * @returns The tool name or 'dynamic-tool' if it's a dynamic tool\n */\nfunction getToolName(type: string | { type: string }): string {\n  // Handle objects with type property\n  if (typeof type === 'object' && type && 'type' in type) {\n    type = type.type;\n  }\n\n  // Ensure type is a string\n  if (typeof type !== 'string') {\n    return 'unknown';\n  }\n\n  if (type === 'dynamic-tool') {\n    return 'dynamic-tool';\n  }\n\n  // Extract tool name from \"tool-${toolName}\" format\n  if (type.startsWith('tool-')) {\n    return type.slice('tool-'.length); // Remove \"tool-\" prefix\n  }\n\n  // Fallback for unexpected formats\n  return type;\n}\n\nexport interface AIV5AdapterContext {\n  memoryInfo: { threadId?: string; resourceId?: string } | null;\n  newMessageId?(): string;\n  generateCreatedAt?(messageSource: MessageSource, start?: unknown): Date;\n}\n\n/**\n * AIV5Adapter - Handles conversions between MastraDBMessage and AI SDK V5 formats\n *\n * This adapter centralizes all AI SDK V5 (UIMessage and ModelMessage) conversion logic.\n */\nexport class AIV5Adapter {\n  /**\n   * Direct conversion from MastraDBMessage to AIV5 UIMessage\n   */\n  static toUIMessage(dbMsg: MastraDBMessage): AIV5Type.UIMessage {\n    const parts: AIV5Type.UIMessage['parts'] = [];\n    const metadata: Record<string, unknown> = { ...(dbMsg.content.metadata || {}) };\n\n    // Add Mastra-specific metadata\n    if (dbMsg.createdAt) metadata.createdAt = dbMsg.createdAt;\n    if (dbMsg.threadId) metadata.threadId = dbMsg.threadId;\n    if (dbMsg.resourceId) metadata.resourceId = dbMsg.resourceId;\n\n    // Preserve message-level providerMetadata in metadata so it survives UI â†’ Model conversion\n    if (dbMsg.content.providerMetadata) {\n      metadata.providerMetadata = dbMsg.content.providerMetadata;\n    }\n\n    // 1. Handle tool invocations (only if not already in parts array)\n    const hasToolInvocationParts = dbMsg.content.parts?.some(p => p.type === 'tool-invocation');\n    if (dbMsg.content.toolInvocations && !hasToolInvocationParts) {\n      for (const invocation of dbMsg.content.toolInvocations) {\n        if (invocation.state === 'result') {\n          parts.push({\n            type: `tool-${invocation.toolName}`,\n            toolCallId: invocation.toolCallId,\n            state: 'output-available',\n            input: invocation.args,\n            output: invocation.result,\n          });\n        } else {\n          parts.push({\n            type: `tool-${invocation.toolName}`,\n            toolCallId: invocation.toolCallId,\n            state: invocation.state === 'call' ? 'input-available' : 'input-streaming',\n            input: invocation.args,\n          });\n        }\n      }\n    }\n\n    // 2. Check if we have parts with providerMetadata first\n    const hasReasoningInParts = dbMsg.content.parts?.some(p => p.type === 'reasoning');\n    const hasFileInParts = dbMsg.content.parts?.some(p => p.type === 'file');\n\n    // 3. Handle reasoning (AIV4 reasoning is a string) - only if not in parts\n    if (dbMsg.content.reasoning && !hasReasoningInParts) {\n      parts.push({\n        type: 'reasoning',\n        text: dbMsg.content.reasoning,\n      });\n    }\n\n    // 4. Handle files (experimental_attachments) - only if not in parts\n    const attachmentUrls = new Set<string>();\n    if (dbMsg.content.experimental_attachments && !hasFileInParts) {\n      for (const attachment of dbMsg.content.experimental_attachments) {\n        attachmentUrls.add(attachment.url);\n        parts.push({\n          type: 'file',\n          url: attachment.url,\n          mediaType: attachment.contentType || 'unknown',\n        });\n      }\n    }\n\n    // 5. Handle parts directly (if present in V2)\n    let hasNonToolReasoningParts = false;\n    if (dbMsg.content.parts) {\n      for (const part of dbMsg.content.parts) {\n        // Handle tool-invocation parts\n        if (part.type === 'tool-invocation' && part.toolInvocation) {\n          const inv = part.toolInvocation;\n\n          if (inv.state === 'result') {\n            parts.push({\n              type: `tool-${inv.toolName}`,\n              toolCallId: inv.toolCallId,\n              input: inv.args,\n              output: inv.result,\n              state: 'output-available',\n              callProviderMetadata: part.providerMetadata,\n            } satisfies AIV5Type.ToolUIPart);\n          } else {\n            parts.push({\n              type: `tool-${inv.toolName}`,\n              toolCallId: inv.toolCallId,\n              input: inv.args,\n              state: 'input-available',\n              callProviderMetadata: part.providerMetadata,\n            } satisfies AIV5Type.ToolUIPart);\n          }\n          continue;\n        }\n\n        // Handle reasoning parts\n        if (part.type === 'reasoning') {\n          const text =\n            part.reasoning ||\n            (part.details?.reduce((p: string, c) => {\n              if (c.type === `text` && c.text) return p + c.text;\n              return p;\n            }, '') ??\n              '');\n          if (text || part.details?.length) {\n            const v5UIPart: AIV5Type.ReasoningUIPart = {\n              type: 'reasoning' as const,\n              text: text || '',\n              state: 'done' as const,\n            };\n            if (part.providerMetadata) {\n              v5UIPart.providerMetadata = part.providerMetadata;\n            }\n            parts.push(v5UIPart);\n          }\n          continue;\n        }\n\n        // Skip tool-invocation parts without toolInvocation object and other tool- parts\n        if (part.type === 'tool-invocation' || part.type.startsWith('tool-')) {\n          continue;\n        }\n\n        // Convert file parts from V2 format (data) to AIV5 format (url)\n        if (part.type === 'file') {\n          // Skip file parts that came from experimental_attachments to avoid duplicates\n          if (typeof part.data === 'string' && attachmentUrls.has(part.data)) {\n            continue;\n          }\n\n          const categorized =\n            typeof part.data === 'string'\n              ? categorizeFileData(part.data, part.mimeType)\n              : { type: 'raw' as const, mimeType: part.mimeType, data: part.data };\n\n          if (categorized.type === 'url' && typeof part.data === 'string') {\n            const v5UIPart: AIV5Type.FileUIPart = {\n              type: 'file' as const,\n              url: part.data,\n              mediaType: categorized.mimeType || 'image/png',\n            };\n            if (part.providerMetadata) {\n              v5UIPart.providerMetadata = part.providerMetadata;\n            }\n            parts.push(v5UIPart);\n          } else {\n            let filePartData: string;\n            let extractedMimeType = part.mimeType;\n\n            if (typeof part.data === 'string') {\n              const parsed = parseDataUri(part.data);\n\n              if (parsed.isDataUri) {\n                filePartData = parsed.base64Content;\n                if (parsed.mimeType) {\n                  extractedMimeType = extractedMimeType || parsed.mimeType;\n                }\n              } else {\n                filePartData = part.data;\n              }\n            } else {\n              filePartData = part.data;\n            }\n\n            const finalMimeType = extractedMimeType || 'image/png';\n\n            let dataUri: string;\n            if (typeof filePartData === 'string' && filePartData.startsWith('data:')) {\n              dataUri = filePartData;\n            } else {\n              dataUri = createDataUri(filePartData, finalMimeType);\n            }\n\n            const v5UIPart: AIV5Type.FileUIPart = {\n              type: 'file' as const,\n              url: dataUri,\n              mediaType: finalMimeType,\n            };\n            if (part.providerMetadata) {\n              v5UIPart.providerMetadata = part.providerMetadata;\n            }\n            parts.push(v5UIPart);\n          }\n        } else if (part.type === 'source') {\n          const v5UIPart: AIV5Type.SourceUrlUIPart = {\n            type: 'source-url' as const,\n            url: part.source.url,\n            sourceId: part.source.id,\n            title: part.source.title,\n          };\n          if (part.providerMetadata) {\n            v5UIPart.providerMetadata = part.providerMetadata;\n          }\n\n          parts.push(v5UIPart);\n        } else if (part.type === 'text') {\n          const v5UIPart: AIV5Type.TextUIPart = {\n            type: 'text' as const,\n            text: part.text,\n          };\n          if (part.providerMetadata) {\n            v5UIPart.providerMetadata = part.providerMetadata;\n          }\n          parts.push(v5UIPart);\n          hasNonToolReasoningParts = true;\n        } else {\n          // Other parts (step-start, etc.) can be pushed as-is\n          parts.push(part);\n          hasNonToolReasoningParts = true;\n        }\n      }\n    }\n\n    // 6. Handle text content (fallback if no parts)\n    if (dbMsg.content.content && !hasNonToolReasoningParts) {\n      parts.push({ type: 'text', text: dbMsg.content.content });\n    }\n\n    return {\n      id: dbMsg.id,\n      role: dbMsg.role,\n      metadata,\n      parts,\n    };\n  }\n\n  /**\n   * Direct conversion from AIV5 UIMessage to MastraDBMessage\n   */\n  static fromUIMessage(uiMsg: AIV5Type.UIMessage): MastraDBMessage {\n    const { parts, metadata: rawMetadata } = uiMsg;\n    const metadata = (rawMetadata || {}) as Record<string, unknown>;\n\n    // Extract Mastra-specific metadata\n    const createdAtValue = metadata.createdAt;\n    const createdAt = createdAtValue\n      ? typeof createdAtValue === 'string'\n        ? new Date(createdAtValue)\n        : createdAtValue instanceof Date\n          ? createdAtValue\n          : new Date()\n      : new Date();\n    const threadId = metadata.threadId as string | undefined;\n    const resourceId = metadata.resourceId as string | undefined;\n\n    // Remove Mastra-specific metadata from the metadata object\n    const cleanMetadata = { ...metadata };\n    delete cleanMetadata.createdAt;\n    delete cleanMetadata.threadId;\n    delete cleanMetadata.resourceId;\n\n    // Process parts to build V2 content\n    const toolInvocationParts = parts.filter(p => AIV5.isToolUIPart(p));\n    const reasoningParts = parts.filter(p => p.type === 'reasoning');\n    const fileParts = parts.filter(p => p.type === 'file');\n    const textParts = parts.filter(p => p.type === 'text');\n\n    // Build tool invocations array\n    let toolInvocations: MastraDBMessage['content']['toolInvocations'] = undefined;\n    if (toolInvocationParts.length > 0) {\n      toolInvocations = toolInvocationParts.map(p => {\n        const toolName = getToolName(p);\n        if (p.state === 'output-available') {\n          return {\n            args: p.input,\n            result:\n              typeof p.output === 'object' && p.output && 'value' in p.output\n                ? (p.output as { value: unknown }).value\n                : p.output,\n            toolCallId: p.toolCallId,\n            toolName,\n            state: 'result',\n          } satisfies NonNullable<MastraDBMessage['content']['toolInvocations']>[0];\n        }\n        return {\n          args: p.input,\n          toolCallId: p.toolCallId,\n          toolName,\n          state: 'call',\n        } satisfies NonNullable<MastraDBMessage['content']['toolInvocations']>[0];\n      });\n    }\n\n    // Build reasoning string (AIV4 reasoning is a string, not an array)\n    let reasoning: MastraDBMessage['content']['reasoning'] = undefined;\n    if (reasoningParts.length > 0) {\n      reasoning = reasoningParts.map(p => p.text).join('\\n');\n    }\n\n    // Build experimental_attachments from file parts\n    let experimental_attachments: MastraDBMessage['content']['experimental_attachments'] = undefined;\n    if (fileParts.length > 0) {\n      experimental_attachments = fileParts.map(p => ({\n        url: p.url || '',\n        contentType: p.mediaType,\n      }));\n    }\n\n    // Build content from text parts (AIV4 content is a string)\n    let content: MastraDBMessage['content']['content'] = undefined;\n    if (textParts.length > 0) {\n      content = textParts.map(p => p.text).join('');\n    }\n    // Build V2-compatible parts array\n    const v2Parts = parts\n      .map(p => {\n        // Convert AIV5 UI parts to V2 parts\n        if (AIV5.isToolUIPart(p)) {\n          const toolName = getToolName(p);\n          const callProviderMetadata = 'callProviderMetadata' in p ? p.callProviderMetadata : undefined;\n          if (p.state === 'output-available') {\n            return {\n              type: 'tool-invocation' as const,\n              toolInvocation: {\n                toolCallId: p.toolCallId,\n                toolName,\n                args: p.input,\n                result:\n                  typeof p.output === 'object' && p.output && 'value' in p.output\n                    ? (p.output as { value: unknown }).value\n                    : p.output,\n                state: 'result' as const,\n              },\n              providerMetadata: callProviderMetadata,\n            } satisfies ToolInvocationUIPart & { providerMetadata?: AIV5Type.ProviderMetadata };\n          }\n          return {\n            type: 'tool-invocation' as const,\n            toolInvocation: {\n              toolCallId: p.toolCallId,\n              toolName,\n              args: p.input,\n              state: 'call' as const,\n            },\n            providerMetadata: callProviderMetadata,\n          } satisfies ToolInvocationUIPart & { providerMetadata?: AIV5Type.ProviderMetadata };\n        }\n\n        if (p.type === 'reasoning') {\n          return {\n            type: 'reasoning' as const,\n            reasoning: '',\n            details: [\n              {\n                type: 'text' as const,\n                text: p.text,\n              },\n            ],\n            providerMetadata: p.providerMetadata,\n          };\n        }\n\n        if (p.type === 'file') {\n          return {\n            type: 'file' as const,\n            mimeType: p.mediaType,\n            data: p.url || '',\n            providerMetadata: p.providerMetadata,\n          };\n        }\n\n        if (p.type === 'source-url') {\n          return {\n            type: 'source' as const,\n            source: {\n              url: p.url,\n              sourceType: 'url',\n              id: p.url,\n              providerMetadata: p.providerMetadata,\n            },\n            providerMetadata: p.providerMetadata,\n          };\n        }\n\n        if (p.type === 'text') {\n          type V2TextPart = {\n            type: 'text';\n            text: string;\n            providerMetadata?: AIV5Type.ProviderMetadata;\n          };\n          return {\n            type: 'text' as const,\n            text: p.text,\n            providerMetadata: p.providerMetadata,\n          } satisfies V2TextPart;\n        }\n\n        if (p.type === 'step-start') {\n          return p;\n        }\n\n        // Handle data-* parts (custom parts emitted by tools via writer.custom())\n        if (typeof p.type === 'string' && p.type.startsWith('data-')) {\n          return {\n            type: p.type,\n            data: 'data' in p ? (p as any).data : undefined,\n          };\n        }\n\n        return null;\n      })\n      .filter((p): p is NonNullable<typeof p> => p !== null);\n\n    return {\n      id: uiMsg.id,\n      role: uiMsg.role,\n      createdAt,\n      threadId,\n      resourceId,\n      content: {\n        format: 2,\n        parts: v2Parts as MastraMessageContentV2['parts'],\n        toolInvocations,\n        reasoning,\n        experimental_attachments,\n        content,\n        metadata: Object.keys(cleanMetadata).length > 0 ? cleanMetadata : undefined,\n      },\n    };\n  }\n\n  /**\n   * Convert image or file to data URI or URL for V2 file part\n   */\n  private static getDataStringFromAIV5DataPart(part: AIV5Type.ImagePart | AIV5Type.FilePart): string {\n    let mimeType: string;\n    let data: AIV5.FilePart['data'] | AIV5.ImagePart['image'];\n    if ('data' in part) {\n      mimeType = part.mediaType || 'application/octet-stream';\n      data = part.data;\n    } else if ('image' in part) {\n      mimeType = part.mediaType || 'image/jpeg';\n      data = part.image;\n    } else {\n      throw new MastraError({\n        id: 'MASTRA_AIV5_DATA_PART_INVALID',\n        domain: ErrorDomain.AGENT,\n        category: ErrorCategory.USER,\n        text: 'Invalid AIV5 data part in getDataStringFromAIV5DataPart',\n        details: {\n          part,\n        },\n      });\n    }\n\n    if (data instanceof URL) {\n      return data.toString();\n    } else {\n      if (data instanceof Buffer) {\n        const base64 = data.toString('base64');\n        return `data:${mimeType};base64,${base64}`;\n      } else if (typeof data === 'string') {\n        return data.startsWith('data:') || data.startsWith('http') ? data : `data:${mimeType};base64,${data}`;\n      } else if (data instanceof Uint8Array) {\n        const base64 = Buffer.from(data).toString('base64');\n        return `data:${mimeType};base64,${base64}`;\n      } else if (data instanceof ArrayBuffer) {\n        const base64 = Buffer.from(data).toString('base64');\n        return `data:${mimeType};base64,${base64}`;\n      } else {\n        return '';\n      }\n    }\n  }\n\n  /**\n   * Direct conversion from AIV5 ModelMessage to MastraDBMessage\n   */\n  static fromModelMessage(modelMsg: AIV5Type.ModelMessage, _messageSource?: MessageSource): MastraDBMessage {\n    const content = Array.isArray(modelMsg.content)\n      ? modelMsg.content\n      : [{ type: 'text', text: modelMsg.content } satisfies AIV5.TextPart];\n\n    const mastraDBParts: MastraMessageContentV2['parts'] = [];\n    const toolInvocations: NonNullable<MastraDBMessage['content']['toolInvocations']> = [];\n    const reasoningParts: string[] = [];\n    const experimental_attachments: NonNullable<MastraDBMessage['content']['experimental_attachments']> = [];\n\n    let lastPartWasToolResult = false;\n\n    for (const part of content) {\n      if (part.type === 'text') {\n        const textPart: MastraDBMessage['content']['parts'][number] = {\n          type: 'text' as const,\n          text: part.text,\n        };\n        if (part.providerOptions) {\n          textPart.providerMetadata = part.providerOptions;\n        }\n        mastraDBParts.push(textPart);\n        lastPartWasToolResult = false;\n      } else if (part.type === 'tool-call') {\n        const toolCallPart = part as AIV5Type.ToolCallPart;\n        const toolInvocationPart: MastraDBMessage['content']['parts'][number] = {\n          type: 'tool-invocation' as const,\n          toolInvocation: {\n            toolCallId: toolCallPart.toolCallId,\n            toolName: toolCallPart.toolName,\n            args: toolCallPart.input,\n            state: 'call',\n          },\n        };\n        if (part.providerOptions) {\n          toolInvocationPart.providerMetadata = part.providerOptions;\n        }\n        mastraDBParts.push(toolInvocationPart);\n        toolInvocations.push({\n          toolCallId: toolCallPart.toolCallId,\n          toolName: toolCallPart.toolName,\n          args: toolCallPart.input,\n          state: 'call',\n        });\n        lastPartWasToolResult = false;\n      } else if (part.type === 'tool-result') {\n        const toolResultPart = part;\n        const matchingCall = toolInvocations.find(inv => inv.toolCallId === toolResultPart.toolCallId);\n\n        const matchingV2Part = mastraDBParts.find(\n          (p): p is Extract<MastraDBMessage['content']['parts'][number], { type: 'tool-invocation' }> =>\n            p.type === 'tool-invocation' &&\n            'toolInvocation' in p &&\n            p.toolInvocation.toolCallId === toolResultPart.toolCallId,\n        );\n\n        const updateMatchingCallInvocationResult = (toolResultPart: AIV5Type.ToolResultPart, matchingCall: any) => {\n          matchingCall.state = 'result';\n          matchingCall.result =\n            typeof toolResultPart.output === 'object' && toolResultPart.output && 'value' in toolResultPart.output\n              ? toolResultPart.output.value\n              : toolResultPart.output;\n        };\n\n        if (matchingCall) {\n          updateMatchingCallInvocationResult(toolResultPart, matchingCall);\n        } else {\n          const call: any = {\n            state: 'call',\n            toolCallId: toolResultPart.toolCallId,\n            toolName: toolResultPart.toolName || 'unknown',\n            args: {},\n          };\n          updateMatchingCallInvocationResult(toolResultPart, call);\n          toolInvocations.push(call);\n        }\n\n        if (matchingV2Part && matchingV2Part.type === 'tool-invocation') {\n          updateMatchingCallInvocationResult(toolResultPart, matchingV2Part.toolInvocation);\n        } else {\n          const toolInvocationPart: MastraDBMessage['content']['parts'][number] = {\n            type: 'tool-invocation' as const,\n            toolInvocation: {\n              toolCallId: toolResultPart.toolCallId,\n              toolName: toolResultPart.toolName || 'unknown',\n              args: {},\n              state: 'call',\n            },\n          };\n          updateMatchingCallInvocationResult(toolResultPart, toolInvocationPart.toolInvocation);\n          mastraDBParts.push(toolInvocationPart);\n        }\n        lastPartWasToolResult = true;\n      } else if (part.type === 'reasoning') {\n        const v2ReasoningPart: MastraDBMessage['content']['parts'][number] = {\n          type: 'reasoning',\n          reasoning: '',\n          details: [{ type: 'text', text: part.text }],\n        };\n        if (part.providerOptions) {\n          v2ReasoningPart.providerMetadata = part.providerOptions;\n        }\n        mastraDBParts.push(v2ReasoningPart);\n        reasoningParts.push(part.text);\n        lastPartWasToolResult = false;\n      } else if (part.type === 'image') {\n        const imagePart = part;\n        const mimeType = imagePart.mediaType || 'image/jpeg';\n        const imageData = this.getDataStringFromAIV5DataPart(imagePart);\n\n        const imageFilePart: MastraDBMessage['content']['parts'][number] = {\n          type: 'file',\n          data: imageData,\n          mimeType,\n        };\n        if (part.providerOptions) {\n          imageFilePart.providerMetadata = part.providerOptions;\n        }\n        mastraDBParts.push(imageFilePart);\n        experimental_attachments.push({\n          url: imageData,\n          contentType: mimeType,\n        });\n        lastPartWasToolResult = false;\n      } else if (part.type === 'file') {\n        const filePart = part;\n        const mimeType = filePart.mediaType || 'application/octet-stream';\n        const fileData = this.getDataStringFromAIV5DataPart(filePart);\n\n        const v2FilePart: MastraDBMessage['content']['parts'][number] = {\n          type: 'file',\n          data: fileData,\n          mimeType,\n        };\n        if (part.providerOptions) {\n          v2FilePart.providerMetadata = part.providerOptions;\n        }\n        mastraDBParts.push(v2FilePart);\n        experimental_attachments.push({\n          url: fileData,\n          contentType: mimeType,\n        });\n        lastPartWasToolResult = false;\n      }\n    }\n\n    // Insert step-start if assistant message starts after tool result\n    if (modelMsg.role === 'assistant' && lastPartWasToolResult && mastraDBParts.length > 0) {\n      const lastPart = mastraDBParts[mastraDBParts.length - 1];\n      if (lastPart && lastPart.type !== 'text') {\n        const emptyTextPart: MastraDBMessage['content']['parts'][number] = { type: 'text', text: '' };\n        mastraDBParts.push(emptyTextPart);\n      }\n    }\n\n    // Build V2 content string\n    const contentString = mastraDBParts\n      .filter(p => p.type === 'text')\n      .map(p => p.text)\n      .join('\\n');\n\n    // Preserve metadata from the input message if present\n    const metadata: Record<string, unknown> =\n      'metadata' in modelMsg && modelMsg.metadata !== null && modelMsg.metadata !== undefined\n        ? (modelMsg.metadata as Record<string, unknown>)\n        : {};\n\n    // Generate ID from modelMsg if available, otherwise create a new one\n    const id =\n      `id` in modelMsg && typeof modelMsg.id === `string`\n        ? modelMsg.id\n        : `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n\n    const message: MastraDBMessage = {\n      id,\n      role: modelMsg.role === 'tool' ? 'assistant' : modelMsg.role,\n      createdAt: new Date(),\n      content: {\n        format: 2,\n        parts: mastraDBParts,\n        toolInvocations: toolInvocations.length > 0 ? toolInvocations : undefined,\n        reasoning: reasoningParts.length > 0 ? reasoningParts.join('\\n') : undefined,\n        experimental_attachments: experimental_attachments.length > 0 ? experimental_attachments : undefined,\n        content: contentString || undefined,\n        metadata: Object.keys(metadata).length > 0 ? metadata : undefined,\n      },\n    };\n    // Add message-level providerOptions if present\n    if (modelMsg.providerOptions) {\n      message.content.providerMetadata = modelMsg.providerOptions;\n    }\n\n    return message;\n  }\n}\n","import type { UIMessage as UIMessageV4 } from '@internal/ai-sdk-v4';\nimport * as AIV5 from '@internal/ai-sdk-v5';\n\nimport { getImageCacheKey } from '../prompt/image-utils';\nimport type { AIV5Type, CoreMessageV4 } from '../types';\nimport type { MastraMessagePart, UIMessageV4Part } from './types';\n\n/**\n * CacheKeyGenerator - Centralized cache key generation for message equality checks\n *\n * This class provides consistent cache key generation across all message formats,\n * which is critical for:\n * - Deduplication of messages\n * - Detecting when messages have been updated\n * - Comparing messages across different formats\n *\n * Cache key invariants:\n * - Same message content should always produce the same key\n * - Different content should produce different keys\n * - Provider metadata (e.g., OpenAI reasoning itemId) must be included for proper distinction\n */\nexport class CacheKeyGenerator {\n  /**\n   * Generate cache key from AIV4 UIMessage parts\n   */\n  static fromAIV4Parts(parts: UIMessageV4['parts']): string {\n    let key = '';\n    for (const part of parts) {\n      key += part.type;\n      key += CacheKeyGenerator.fromAIV4Part(part);\n    }\n    return key;\n  }\n\n  /**\n   * Generate cache key from a single AIV4 UIMessage part\n   */\n  static fromAIV4Part(part: UIMessageV4['parts'][number]): string {\n    let cacheKey = '';\n    if (part.type === 'text') {\n      cacheKey += part.text;\n    }\n    if (part.type === 'tool-invocation') {\n      cacheKey += part.toolInvocation.toolCallId;\n      cacheKey += part.toolInvocation.state;\n    }\n    if (part.type === 'reasoning') {\n      cacheKey += part.reasoning;\n      cacheKey += part.details.reduce((prev, current) => {\n        if (current.type === 'text') {\n          return prev + current.text.length + (current.signature?.length || 0);\n        }\n        return prev;\n      }, 0);\n\n      // OpenAI sends reasoning items (rs_...) inside part.providerMetadata.openai.itemId.\n      // When the reasoning text is empty, the default cache key logic produces \"reasoning0\"\n      // for *all* reasoning parts. This makes distinct rs_ entries appear identical, so the\n      // message-merging logic drops the latest reasoning item. The result is that subsequent\n      // OpenAI calls fail with:\n      //\n      //   \"Item 'fc_...' was provided without its required 'reasoning' item\"\n      //\n      // To fix this, we incorporate the OpenAI itemId into the cache key so each rs_ entry\n      // is treated as distinct.\n      //\n      // Note: We cast `part` to `any` here because the AI SDK's ReasoningUIPart V4 type does\n      // NOT declare `providerMetadata` (even though Mastra attaches it at runtime). This\n      // access is safe in JavaScript, but TypeScript cannot type it without augmentation,\n      // so we intentionally narrow to `any` only for this metadata lookup.\n\n      const partAny = part as any;\n\n      if (\n        partAny &&\n        Object.hasOwn(partAny, 'providerMetadata') &&\n        partAny.providerMetadata &&\n        Object.hasOwn(partAny.providerMetadata, 'openai') &&\n        partAny.providerMetadata.openai &&\n        Object.hasOwn(partAny.providerMetadata.openai, 'itemId')\n      ) {\n        const itemId = partAny.providerMetadata.openai.itemId;\n        cacheKey += `|${itemId}`;\n      }\n    }\n    if (part.type === 'file') {\n      cacheKey += part.data;\n      cacheKey += part.mimeType;\n    }\n\n    return cacheKey;\n  }\n\n  /**\n   * Generate cache key from MastraDB message parts\n   */\n  static fromDBParts(parts: MastraMessagePart[]): string {\n    let key = '';\n    for (const part of parts) {\n      key += part.type;\n      if (part.type.startsWith('data-')) {\n        // Stringify data for proper cache key comparison since data can be any type\n        const data = (part as AIV5Type.DataUIPart<AIV5.UIDataTypes>).data;\n        key += JSON.stringify(data);\n      } else {\n        // Cast to UIMessageV4Part since we've already handled data-* parts above\n        key += CacheKeyGenerator.fromAIV4Part(part as UIMessageV4Part);\n      }\n    }\n    return key;\n  }\n\n  /**\n   * Generate cache key from AIV4 CoreMessage content\n   */\n  static fromAIV4CoreMessageContent(content: CoreMessageV4['content']): string {\n    if (typeof content === 'string') return content;\n    let key = '';\n    for (const part of content) {\n      key += part.type;\n      if (part.type === 'text') {\n        key += part.text.length;\n      }\n      if (part.type === 'reasoning') {\n        key += part.text.length;\n      }\n      if (part.type === 'tool-call') {\n        key += part.toolCallId;\n        key += part.toolName;\n      }\n      if (part.type === 'tool-result') {\n        key += part.toolCallId;\n        key += part.toolName;\n      }\n      if (part.type === 'file') {\n        key += part.filename;\n        key += part.mimeType;\n      }\n      if (part.type === 'image') {\n        key += getImageCacheKey(part.image);\n        key += part.mimeType;\n      }\n      if (part.type === 'redacted-reasoning') {\n        key += part.data.length;\n      }\n    }\n    return key;\n  }\n\n  /**\n   * Generate cache key from AIV5 UIMessage parts\n   */\n  static fromAIV5Parts(parts: AIV5Type.UIMessage['parts']): string {\n    let key = '';\n    for (const part of parts) {\n      key += part.type;\n      if (part.type === 'text') {\n        key += part.text;\n      }\n      if (AIV5.isToolUIPart(part) || part.type === 'dynamic-tool') {\n        key += part.toolCallId;\n        key += part.state;\n      }\n      if (part.type === 'reasoning') {\n        key += part.text;\n      }\n      if (part.type === 'file') {\n        key += part.url.length;\n        key += part.mediaType;\n        key += part.filename || '';\n      }\n    }\n    return key;\n  }\n\n  /**\n   * Generate cache key from AIV5 ModelMessage content\n   */\n  static fromAIV5ModelMessageContent(content: AIV5Type.ModelMessage['content']): string {\n    if (typeof content === 'string') return content;\n    let key = '';\n    for (const part of content) {\n      key += part.type;\n      if (part.type === 'text') {\n        key += part.text.length;\n      }\n      if (part.type === 'reasoning') {\n        key += part.text.length;\n      }\n      if (part.type === 'tool-call') {\n        key += part.toolCallId;\n        key += part.toolName;\n      }\n      if (part.type === 'tool-result') {\n        key += part.toolCallId;\n        key += part.toolName;\n      }\n      if (part.type === 'file') {\n        key += part.filename;\n        key += part.mediaType;\n      }\n      if (part.type === 'image') {\n        key += getImageCacheKey(part.image);\n        key += part.mediaType;\n      }\n    }\n    return key;\n  }\n}\n","import type { LanguageModelV2Prompt } from '@ai-sdk/provider-v5';\nimport type { LanguageModelV1Prompt, CoreMessage as CoreMessageV4 } from '@internal/ai-sdk-v4';\n\nimport { convertDataContentToBase64String } from '../prompt/data-content';\nimport { categorizeFileData, createDataUri } from '../prompt/image-utils';\nimport type { AIV5Type } from '../types';\n\ntype AIV5LanguageModelV2Message = LanguageModelV2Prompt[0];\ntype LanguageModelV1Message = LanguageModelV1Prompt[0];\n\n/**\n * Convert an AI SDK V4 CoreMessage to a V1 LanguageModel prompt message.\n * Used for creating LLM prompt messages without AI SDK streamText/generateText.\n */\nexport function aiV4CoreMessageToV1PromptMessage(coreMessage: CoreMessageV4): LanguageModelV1Message {\n  if (coreMessage.role === `system`) {\n    return coreMessage;\n  }\n\n  if (typeof coreMessage.content === `string` && (coreMessage.role === `assistant` || coreMessage.role === `user`)) {\n    return {\n      ...coreMessage,\n      content: [{ type: 'text', text: coreMessage.content }],\n    };\n  }\n\n  if (typeof coreMessage.content === `string`) {\n    throw new Error(\n      `Saw text content for input CoreMessage, but the role is ${coreMessage.role}. This is only allowed for \"system\", \"assistant\", and \"user\" roles.`,\n    );\n  }\n\n  const roleContent: {\n    user: Exclude<Extract<LanguageModelV1Message, { role: 'user' }>['content'], string>;\n    assistant: Exclude<Extract<LanguageModelV1Message, { role: 'assistant' }>['content'], string>;\n    tool: Exclude<Extract<LanguageModelV1Message, { role: 'tool' }>['content'], string>;\n  } = {\n    user: [],\n    assistant: [],\n    tool: [],\n  };\n\n  const role = coreMessage.role;\n\n  for (const part of coreMessage.content) {\n    const incompatibleMessage = `Saw incompatible message content part type ${part.type} for message role ${role}`;\n\n    switch (part.type) {\n      case 'text': {\n        if (role === `tool`) {\n          throw new Error(incompatibleMessage);\n        }\n        roleContent[role].push(part);\n        break;\n      }\n\n      case 'redacted-reasoning':\n      case 'reasoning': {\n        if (role !== `assistant`) {\n          throw new Error(incompatibleMessage);\n        }\n        roleContent[role].push(part);\n        break;\n      }\n\n      case 'tool-call': {\n        if (role === `tool` || role === `user`) {\n          throw new Error(incompatibleMessage);\n        }\n        roleContent[role].push(part);\n        break;\n      }\n\n      case 'tool-result': {\n        if (role === `assistant` || role === `user`) {\n          throw new Error(incompatibleMessage);\n        }\n        roleContent[role].push(part);\n        break;\n      }\n\n      case 'image': {\n        if (role === `tool` || role === `assistant`) {\n          throw new Error(incompatibleMessage);\n        }\n\n        let processedImage: URL | Uint8Array;\n\n        if (part.image instanceof URL || part.image instanceof Uint8Array) {\n          processedImage = part.image;\n        } else if (Buffer.isBuffer(part.image) || part.image instanceof ArrayBuffer) {\n          processedImage = new Uint8Array(part.image);\n        } else {\n          // part.image is a string - could be a URL, data URI, or raw base64\n          const categorized = categorizeFileData(part.image, part.mimeType);\n\n          if (categorized.type === 'raw') {\n            // Raw base64 - convert to data URI before creating URL\n            const dataUri = createDataUri(part.image, part.mimeType || 'image/png');\n            processedImage = new URL(dataUri);\n          } else {\n            // It's already a URL or data URI\n            processedImage = new URL(part.image);\n          }\n        }\n\n        roleContent[role].push({\n          ...part,\n          image: processedImage,\n        });\n        break;\n      }\n\n      case 'file': {\n        if (role === `tool`) {\n          throw new Error(incompatibleMessage);\n        }\n        roleContent[role].push({\n          ...part,\n          data:\n            part.data instanceof URL\n              ? part.data\n              : typeof part.data === 'string'\n                ? part.data\n                : convertDataContentToBase64String(part.data),\n        });\n        break;\n      }\n    }\n  }\n\n  if (role === `tool`) {\n    return {\n      ...coreMessage,\n      content: roleContent[role],\n    };\n  }\n  if (role === `user`) {\n    return {\n      ...coreMessage,\n      content: roleContent[role],\n    };\n  }\n  if (role === `assistant`) {\n    return {\n      ...coreMessage,\n      content: roleContent[role],\n    };\n  }\n\n  throw new Error(\n    `Encountered unknown role ${role} when converting V4 CoreMessage -> V4 LanguageModelV1Prompt, input message: ${JSON.stringify(coreMessage, null, 2)}`,\n  );\n}\n\n/**\n * Convert an AI SDK V5 ModelMessage to a V2 LanguageModel prompt message.\n * Used for creating LLM prompt messages without AI SDK streamText/generateText.\n */\nexport function aiV5ModelMessageToV2PromptMessage(modelMessage: AIV5Type.ModelMessage): AIV5LanguageModelV2Message {\n  if (modelMessage.role === `system`) {\n    return modelMessage;\n  }\n\n  if (typeof modelMessage.content === `string` && (modelMessage.role === `assistant` || modelMessage.role === `user`)) {\n    return {\n      role: modelMessage.role,\n      content: [{ type: 'text', text: modelMessage.content }],\n      providerOptions: modelMessage.providerOptions,\n    };\n  }\n\n  if (typeof modelMessage.content === `string`) {\n    throw new Error(\n      `Saw text content for input ModelMessage, but the role is ${modelMessage.role}. This is only allowed for \"system\", \"assistant\", and \"user\" roles.`,\n    );\n  }\n\n  const roleContent: {\n    user: Extract<AIV5LanguageModelV2Message, { role: 'user' }>['content'];\n    assistant: Extract<AIV5LanguageModelV2Message, { role: 'assistant' }>['content'];\n    tool: Extract<AIV5LanguageModelV2Message, { role: 'tool' }>['content'];\n  } = {\n    user: [],\n    assistant: [],\n    tool: [],\n  };\n\n  const role = modelMessage.role;\n\n  for (const part of modelMessage.content) {\n    const incompatibleMessage = `Saw incompatible message content part type ${part.type} for message role ${role}`;\n\n    switch (part.type) {\n      case 'text': {\n        if (role === `tool`) {\n          throw new Error(incompatibleMessage);\n        }\n        roleContent[role].push(part);\n        break;\n      }\n\n      case 'reasoning': {\n        if (role === `tool` || role === `user`) {\n          throw new Error(incompatibleMessage);\n        }\n        roleContent[role].push(part);\n        break;\n      }\n\n      case 'tool-call': {\n        if (role !== `assistant`) {\n          throw new Error(incompatibleMessage);\n        }\n        roleContent[role].push(part);\n        break;\n      }\n\n      case 'tool-result': {\n        if (role === `assistant` || role === `user`) {\n          throw new Error(incompatibleMessage);\n        }\n        roleContent[role].push(part);\n        break;\n      }\n\n      case 'file': {\n        if (role === `tool`) {\n          throw new Error(incompatibleMessage);\n        }\n        roleContent[role].push({\n          ...part,\n          data: part.data instanceof ArrayBuffer ? new Uint8Array(part.data) : part.data,\n        });\n        break;\n      }\n\n      case 'image': {\n        if (role === `tool`) {\n          throw new Error(incompatibleMessage);\n        }\n        roleContent[role].push({\n          ...part,\n          mediaType: part.mediaType || 'image/unknown',\n          type: 'file',\n          data: part.image instanceof ArrayBuffer ? new Uint8Array(part.image) : part.image,\n        });\n        break;\n      }\n    }\n  }\n\n  if (role === `tool`) {\n    return {\n      ...modelMessage,\n      content: roleContent[role],\n    };\n  }\n  if (role === `user`) {\n    return {\n      ...modelMessage,\n      content: roleContent[role],\n    };\n  }\n  if (role === `assistant`) {\n    return {\n      ...modelMessage,\n      content: roleContent[role],\n    };\n  }\n\n  throw new Error(\n    `Encountered unknown role ${role} when converting V5 ModelMessage -> V5 LanguageModelV2Message, input message: ${JSON.stringify(modelMessage, null, 2)}`,\n  );\n}\n","import type { CoreMessage as CoreMessageV4 } from '@internal/ai-sdk-v4';\n\nimport { CacheKeyGenerator } from '../cache/CacheKeyGenerator';\nimport { TypeDetector } from '../detection/TypeDetector';\nimport type { MessageInput } from '../types';\n\n/**\n * Convert CoreMessage content to a plain string.\n * Extracts text from text parts and concatenates them.\n */\nexport function coreContentToString(content: CoreMessageV4['content']): string {\n  if (typeof content === `string`) return content;\n\n  return content.reduce((p, c) => {\n    if (c.type === `text`) {\n      p += c.text;\n    }\n    return p;\n  }, '');\n}\n\n/**\n * Compare two messages for equality based on their content.\n * Uses cache keys for efficient comparison across different message formats.\n */\nexport function messagesAreEqual(one: MessageInput, two: MessageInput): boolean {\n  const oneUIV4 = TypeDetector.isAIV4UIMessage(one) && one;\n  const twoUIV4 = TypeDetector.isAIV4UIMessage(two) && two;\n  if (oneUIV4 && !twoUIV4) return false;\n  if (oneUIV4 && twoUIV4) {\n    return CacheKeyGenerator.fromAIV4Parts(one.parts) === CacheKeyGenerator.fromAIV4Parts(two.parts);\n  }\n\n  const oneCMV4 = TypeDetector.isAIV4CoreMessage(one) && one;\n  const twoCMV4 = TypeDetector.isAIV4CoreMessage(two) && two;\n  if (oneCMV4 && !twoCMV4) return false;\n  if (oneCMV4 && twoCMV4) {\n    return (\n      CacheKeyGenerator.fromAIV4CoreMessageContent(oneCMV4.content) ===\n      CacheKeyGenerator.fromAIV4CoreMessageContent(twoCMV4.content)\n    );\n  }\n\n  const oneMM1 = TypeDetector.isMastraMessageV1(one) && one;\n  const twoMM1 = TypeDetector.isMastraMessageV1(two) && two;\n  if (oneMM1 && !twoMM1) return false;\n  if (oneMM1 && twoMM1) {\n    return (\n      oneMM1.id === twoMM1.id &&\n      CacheKeyGenerator.fromAIV4CoreMessageContent(oneMM1.content) ===\n        CacheKeyGenerator.fromAIV4CoreMessageContent(twoMM1.content)\n    );\n  }\n\n  const oneMM2 = TypeDetector.isMastraDBMessage(one) && one;\n  const twoMM2 = TypeDetector.isMastraDBMessage(two) && two;\n  if (oneMM2 && !twoMM2) return false;\n  if (oneMM2 && twoMM2) {\n    return (\n      oneMM2.id === twoMM2.id &&\n      CacheKeyGenerator.fromDBParts(oneMM2.content.parts) === CacheKeyGenerator.fromDBParts(twoMM2.content.parts)\n    );\n  }\n\n  const oneUIV5 = TypeDetector.isAIV5UIMessage(one) && one;\n  const twoUIV5 = TypeDetector.isAIV5UIMessage(two) && two;\n  if (oneUIV5 && !twoUIV5) return false;\n  if (oneUIV5 && twoUIV5) {\n    return CacheKeyGenerator.fromAIV5Parts(one.parts) === CacheKeyGenerator.fromAIV5Parts(two.parts);\n  }\n\n  const oneCMV5 = TypeDetector.isAIV5CoreMessage(one) && one;\n  const twoCMV5 = TypeDetector.isAIV5CoreMessage(two) && two;\n  if (oneCMV5 && !twoCMV5) return false;\n  if (oneCMV5 && twoCMV5) {\n    return (\n      CacheKeyGenerator.fromAIV5ModelMessageContent(oneCMV5.content) ===\n      CacheKeyGenerator.fromAIV5ModelMessageContent(twoCMV5.content)\n    );\n  }\n\n  // default to it did change. we'll likely never reach this codepath\n  return true;\n}\n","import type { CoreMessage as CoreMessageV4, UIMessage as UIMessageV4 } from '@internal/ai-sdk-v4';\n\nimport { AIV4Adapter, AIV5Adapter } from '../adapters';\nimport { TypeDetector } from '../detection/TypeDetector';\nimport type {\n  MastraDBMessage,\n  MastraMessageV1,\n  MessageSource,\n  MemoryInfo,\n  UIMessageWithMetadata,\n} from '../state/types';\nimport type { MessageInput } from '../types';\n\n/**\n * Context required for input conversion functions.\n * This is passed from MessageList to provide access to instance-specific utilities.\n */\nexport interface InputConversionContext {\n  memoryInfo: MemoryInfo | null;\n  newMessageId: () => string;\n  generateCreatedAt: (messageSource: MessageSource, start?: unknown) => Date;\n  /** Messages array for looking up tool call args */\n  dbMessages: MastraDBMessage[];\n}\n\n/**\n * Convert any supported message input format to MastraDBMessage.\n * Routes to the appropriate converter based on message type detection.\n */\nexport function inputToMastraDBMessage(\n  message: MessageInput,\n  messageSource: MessageSource,\n  context: InputConversionContext,\n): MastraDBMessage {\n  // Validate threadId matches (except for memory messages which can come from other threads)\n  if (\n    messageSource !== `memory` &&\n    `threadId` in message &&\n    message.threadId &&\n    context.memoryInfo &&\n    message.threadId !== context.memoryInfo.threadId\n  ) {\n    throw new Error(\n      `Received input message with wrong threadId. Input ${message.threadId}, expected ${context.memoryInfo.threadId}`,\n    );\n  }\n\n  // Validate resourceId matches\n  if (\n    `resourceId` in message &&\n    message.resourceId &&\n    context.memoryInfo?.resourceId &&\n    message.resourceId !== context.memoryInfo.resourceId\n  ) {\n    throw new Error(\n      `Received input message with wrong resourceId. Input ${message.resourceId}, expected ${context.memoryInfo.resourceId}`,\n    );\n  }\n\n  if (TypeDetector.isMastraMessageV1(message)) {\n    return mastraMessageV1ToMastraDBMessage(message, messageSource, context);\n  }\n  if (TypeDetector.isMastraDBMessage(message)) {\n    return hydrateMastraDBMessageFields(message, context);\n  }\n  if (TypeDetector.isAIV4CoreMessage(message)) {\n    return AIV4Adapter.fromCoreMessage(message, context, messageSource);\n  }\n  if (TypeDetector.isAIV4UIMessage(message)) {\n    return AIV4Adapter.fromUIMessage(message as UIMessageV4 | UIMessageWithMetadata, context, messageSource);\n  }\n\n  // Use custom ID generator if message doesn't have an ID, otherwise keep the original\n  const hasOriginalId = 'id' in message && typeof message.id === 'string';\n  const id = hasOriginalId ? message.id : context.newMessageId();\n\n  if (TypeDetector.isAIV5CoreMessage(message)) {\n    const dbMsg = AIV5Adapter.fromModelMessage(message, messageSource);\n    // Only use the original createdAt from input message metadata, not the generated one from the static method\n    // This fixes issue #10683 where messages without createdAt would get shuffled\n    const rawCreatedAt =\n      'metadata' in message &&\n      message.metadata &&\n      typeof message.metadata === 'object' &&\n      'createdAt' in message.metadata\n        ? message.metadata.createdAt\n        : undefined;\n    return {\n      ...dbMsg,\n      id,\n      createdAt: context.generateCreatedAt(messageSource, rawCreatedAt),\n      threadId: context.memoryInfo?.threadId,\n      resourceId: context.memoryInfo?.resourceId,\n    };\n  }\n  if (TypeDetector.isAIV5UIMessage(message)) {\n    const dbMsg = AIV5Adapter.fromUIMessage(message);\n    // Only use the original createdAt from input message, not the generated one from the static method\n    // This fixes issue #10683 where messages without createdAt would get shuffled\n    const rawCreatedAt = 'createdAt' in message ? message.createdAt : undefined;\n    return {\n      ...dbMsg,\n      id,\n      createdAt: context.generateCreatedAt(messageSource, rawCreatedAt),\n      threadId: context.memoryInfo?.threadId,\n      resourceId: context.memoryInfo?.resourceId,\n    };\n  }\n\n  throw new Error(`Found unhandled message ${JSON.stringify(message)}`);\n}\n\n/**\n * Convert MastraMessageV1 format to MastraDBMessage.\n */\nexport function mastraMessageV1ToMastraDBMessage(\n  message: MastraMessageV1,\n  messageSource: MessageSource,\n  context: InputConversionContext,\n): MastraDBMessage {\n  const coreV2 = AIV4Adapter.fromCoreMessage(\n    {\n      content: message.content,\n      role: message.role,\n    } as CoreMessageV4,\n    context,\n    messageSource,\n  );\n\n  return {\n    id: message.id,\n    role: coreV2.role,\n    createdAt: context.generateCreatedAt(messageSource, message.createdAt),\n    threadId: message.threadId,\n    resourceId: message.resourceId,\n    content: coreV2.content,\n  };\n}\n\n/**\n * Hydrate a MastraDBMessage with missing fields (id, createdAt, threadId, resourceId).\n * Also fixes toolInvocations with empty args by looking in the parts array.\n */\nexport function hydrateMastraDBMessageFields(\n  message: MastraDBMessage,\n  context: InputConversionContext,\n): MastraDBMessage {\n  // Generate ID if missing\n  if (!message.id) {\n    message.id = context.newMessageId();\n  }\n\n  if (!(message.createdAt instanceof Date)) {\n    message.createdAt = new Date(message.createdAt);\n  }\n\n  // Fix toolInvocations with empty args by looking in the parts array\n  // This handles messages restored from database where toolInvocations might have lost their args\n  if (message.content.toolInvocations && message.content.parts) {\n    message.content.toolInvocations = message.content.toolInvocations.map(ti => {\n      if (!ti.args || Object.keys(ti.args).length === 0) {\n        // Find the corresponding tool-invocation part with args\n        const partWithArgs = message.content.parts.find(\n          part =>\n            part.type === 'tool-invocation' &&\n            part.toolInvocation &&\n            part.toolInvocation.toolCallId === ti.toolCallId &&\n            part.toolInvocation.args &&\n            Object.keys(part.toolInvocation.args).length > 0,\n        );\n        if (partWithArgs && partWithArgs.type === 'tool-invocation') {\n          return { ...ti, args: partWithArgs.toolInvocation.args };\n        }\n      }\n      return ti;\n    });\n  }\n\n  if (!message.threadId && context.memoryInfo?.threadId) {\n    message.threadId = context.memoryInfo.threadId;\n\n    if (!message.resourceId && context.memoryInfo?.resourceId) {\n      message.resourceId = context.memoryInfo.resourceId;\n    }\n  }\n\n  return message;\n}\n","import { convertToCoreMessages as convertToCoreMessagesV4 } from '@internal/ai-sdk-v4';\nimport type { CoreMessage as CoreMessageV4, UIMessage as UIMessageV4 } from '@internal/ai-sdk-v4';\nimport * as AIV5 from '@internal/ai-sdk-v5';\n\nimport { AIV4Adapter, AIV5Adapter } from '../adapters';\nimport type { AdapterContext } from '../adapters';\nimport { TypeDetector } from '../detection/TypeDetector';\nimport type { MastraDBMessage, MessageSource } from '../state/types';\nimport type { AIV5Type } from '../types';\nimport { ensureAnthropicCompatibleMessages } from '../utils/provider-compat';\n\n/**\n * Sanitizes AIV4 UI messages by filtering out incomplete tool calls.\n * Removes messages with empty parts arrays after sanitization.\n */\nexport function sanitizeAIV4UIMessages(messages: UIMessageV4[]): UIMessageV4[] {\n  const msgs = messages\n    .map(m => {\n      if (m.parts.length === 0) return false;\n      const safeParts = m.parts.filter(\n        p =>\n          p.type !== `tool-invocation` ||\n          // calls and partial-calls should be updated to be results at this point\n          // if they haven't we can't send them back to the llm and need to remove them.\n          (p.toolInvocation.state !== `call` && p.toolInvocation.state !== `partial-call`),\n      );\n\n      // fully remove this message if it has an empty parts array after stripping out incomplete tool calls.\n      if (!safeParts.length) return false;\n\n      const sanitized = {\n        ...m,\n        parts: safeParts,\n      };\n\n      // ensure toolInvocations are also updated to only show results\n      if (`toolInvocations` in m && m.toolInvocations) {\n        sanitized.toolInvocations = m.toolInvocations.filter(t => t.state === `result`);\n      }\n\n      return sanitized;\n    })\n    .filter((m): m is UIMessageV4 => Boolean(m));\n  return msgs;\n}\n\n/**\n * Sanitizes AIV5 UI messages by filtering out streaming states and optionally incomplete tool calls.\n */\nexport function sanitizeV5UIMessages(\n  messages: AIV5Type.UIMessage[],\n  filterIncompleteToolCalls = false,\n): AIV5Type.UIMessage[] {\n  const msgs = messages\n    .map(m => {\n      if (m.parts.length === 0) return false;\n      // Filter out streaming states and optionally input-available (which aren't supported by convertToModelMessages)\n      const safeParts = m.parts.filter(p => {\n        if (!AIV5.isToolUIPart(p)) return true;\n\n        // When sending messages TO the LLM: only keep completed tool calls (output-available/output-error)\n        // This filters out input-available (incomplete client-side tool calls) and input-streaming\n        if (filterIncompleteToolCalls) {\n          return p.state === 'output-available' || p.state === 'output-error';\n        }\n\n        // When processing response messages FROM the LLM: keep input-available states\n        // (tool calls waiting for client-side execution) but filter out input-streaming\n        return p.state !== 'input-streaming';\n      });\n\n      if (!safeParts.length) return false;\n\n      const sanitized = {\n        ...m,\n        parts: safeParts.map(part => {\n          if (AIV5.isToolUIPart(part) && part.state === 'output-available') {\n            return {\n              ...part,\n              output:\n                typeof part.output === 'object' && part.output && 'value' in part.output\n                  ? part.output.value\n                  : part.output,\n            };\n          }\n          return part;\n        }),\n      };\n\n      return sanitized;\n    })\n    .filter((m): m is AIV5Type.UIMessage => Boolean(m));\n  return msgs;\n}\n\n/**\n * Adds step-start parts between tool parts and non-tool parts for proper AIV5 message conversion.\n * This ensures AIV5.convertToModelMessages produces the correct message order.\n */\nexport function addStartStepPartsForAIV5(messages: AIV5Type.UIMessage[]): AIV5Type.UIMessage[] {\n  for (const message of messages) {\n    if (message.role !== `assistant`) continue;\n    for (const [index, part] of message.parts.entries()) {\n      if (!AIV5.isToolUIPart(part)) continue;\n      const nextPart = message.parts.at(index + 1);\n      // If we don't insert step-start between tools and other parts, AIV5.convertToModelMessages will incorrectly add extra tool parts in the wrong order\n      // ex: ui message with parts: [tool-result, text] becomes [assistant-message-with-both-parts, tool-result-message], when it should become [tool-call-message, tool-result-message, text-message]\n      // However, we should NOT add step-start between consecutive tool parts (parallel tool calls)\n      if (nextPart && nextPart.type !== `step-start` && !AIV5.isToolUIPart(nextPart)) {\n        message.parts.splice(index + 1, 0, { type: 'step-start' });\n      }\n    }\n  }\n  return messages;\n}\n\n/**\n * Converts AIV4 UI messages to AIV4 Core messages.\n */\nexport function aiV4UIMessagesToAIV4CoreMessages(messages: UIMessageV4[]): CoreMessageV4[] {\n  return convertToCoreMessagesV4(sanitizeAIV4UIMessages(messages));\n}\n\n/**\n * Converts AIV5 UI messages to AIV5 Model messages.\n * Handles sanitization, step-start insertion, provider options restoration, and Anthropic compatibility.\n *\n * @param messages - AIV5 UI messages to convert\n * @param dbMessages - MastraDB messages used to look up tool call args for Anthropic compatibility\n * @param filterIncompleteToolCalls - Whether to filter out incomplete tool calls\n */\nexport function aiV5UIMessagesToAIV5ModelMessages(\n  messages: AIV5Type.UIMessage[],\n  dbMessages: MastraDBMessage[],\n  filterIncompleteToolCalls = false,\n): AIV5Type.ModelMessage[] {\n  const sanitized = sanitizeV5UIMessages(messages, filterIncompleteToolCalls);\n  const preprocessed = addStartStepPartsForAIV5(sanitized);\n  const result = AIV5.convertToModelMessages(preprocessed);\n\n  // Restore message-level providerOptions from metadata.providerMetadata\n  // This preserves providerOptions through the DB â†’ UI â†’ Model conversion\n  const withProviderOptions = result.map((modelMsg, index) => {\n    const uiMsg = preprocessed[index];\n\n    if (\n      uiMsg?.metadata &&\n      typeof uiMsg.metadata === 'object' &&\n      'providerMetadata' in uiMsg.metadata &&\n      uiMsg.metadata.providerMetadata\n    ) {\n      return {\n        ...modelMsg,\n        providerOptions: uiMsg.metadata.providerMetadata as AIV5Type.ProviderMetadata,\n      } satisfies AIV5Type.ModelMessage;\n    }\n\n    return modelMsg;\n  });\n\n  // Add input field to tool-result parts for Anthropic API compatibility (fixes issue #11376)\n  return ensureAnthropicCompatibleMessages(withProviderOptions, dbMessages);\n}\n\n/**\n * Converts AIV4 Core messages to AIV5 Model messages.\n */\nexport function aiV4CoreMessagesToAIV5ModelMessages(\n  messages: CoreMessageV4[],\n  source: MessageSource,\n  adapterContext: AdapterContext,\n  dbMessages: MastraDBMessage[],\n): AIV5Type.ModelMessage[] {\n  return aiV5UIMessagesToAIV5ModelMessages(\n    messages.map(m => AIV4Adapter.fromCoreMessage(m, adapterContext, source)).map(m => AIV5Adapter.toUIMessage(m)),\n    dbMessages,\n  );\n}\n\n/**\n * Converts various message formats to AIV4 CoreMessage format for system messages.\n * Supports string, MastraDBMessage, or AI SDK message types.\n */\nexport function systemMessageToAIV4Core(\n  message: CoreMessageV4 | AIV5Type.ModelMessage | MastraDBMessage | string,\n): CoreMessageV4 {\n  if (typeof message === `string`) {\n    return { role: 'system', content: message };\n  }\n\n  if (TypeDetector.isAIV5CoreMessage(message)) {\n    const dbMsg = AIV5Adapter.fromModelMessage(message as AIV5Type.ModelMessage, 'system');\n    return AIV4Adapter.systemToV4Core(dbMsg);\n  }\n\n  if (TypeDetector.isMastraDBMessage(message)) {\n    return AIV4Adapter.systemToV4Core(message);\n  }\n\n  return message;\n}\n","import { convertBase64ToUint8Array, convertUint8ArrayToBase64 } from '@ai-sdk/provider-utils-v5';\n\n/**\n * A generated file.\n */\nexport interface GeneratedFile {\n  /**\n  File as a base64 encoded string.\n       */\n  readonly base64: string;\n\n  /**\n  File as a Uint8Array.\n       */\n  readonly uint8Array: Uint8Array;\n\n  /**\n  The IANA media type of the file.\n  \n  @see https://www.iana.org/assignments/media-types/media-types.xhtml\n     */\n  readonly mediaType: string;\n}\n\nexport class DefaultGeneratedFile implements GeneratedFile {\n  private base64Data: string | undefined;\n  private uint8ArrayData: Uint8Array | undefined;\n\n  readonly mediaType: string;\n\n  constructor({ data, mediaType }: { data: string | Uint8Array; mediaType: string }) {\n    const isUint8Array = data instanceof Uint8Array;\n    this.base64Data = isUint8Array ? undefined : data;\n    this.uint8ArrayData = isUint8Array ? data : undefined;\n    this.mediaType = mediaType;\n  }\n\n  // lazy conversion with caching to avoid unnecessary conversion overhead:\n  get base64() {\n    if (this.base64Data == null) {\n      this.base64Data = convertUint8ArrayToBase64(this.uint8ArrayData!);\n    }\n    return this.base64Data;\n  }\n\n  // lazy conversion with caching to avoid unnecessary conversion overhead:\n  get uint8Array() {\n    if (this.uint8ArrayData == null) {\n      this.uint8ArrayData = convertBase64ToUint8Array(this.base64Data!);\n    }\n    return this.uint8ArrayData;\n  }\n}\n\nexport class DefaultGeneratedFileWithType extends DefaultGeneratedFile {\n  readonly type = 'file';\n\n  constructor(options: { data: string | Uint8Array; mediaType: string }) {\n    super(options);\n  }\n}\n","import * as AIV5 from '@internal/ai-sdk-v5';\n\nimport { DefaultGeneratedFileWithType } from '../../../stream/aisdk/v5/file';\nimport { convertDataContentToBase64String } from '../prompt/data-content';\nimport { parseDataUri } from '../prompt/image-utils';\nimport type { MastraDBMessage } from '../state/types';\nimport type { AIV5Type } from '../types';\nimport { findToolCallArgs } from '../utils/provider-compat';\nimport { sanitizeV5UIMessages } from './output-converter';\n\n/**\n * StepContentExtractor - Handles extraction of step content from response messages\n *\n * This class encapsulates the complex logic for:\n * - Finding step boundaries by looking for step-start markers\n * - Handling special cases like -1 (last step) and tool-only steps\n * - Converting UI messages to model messages and extracting content\n */\nexport class StepContentExtractor {\n  /**\n   * Extract content for a specific step number from UI messages\n   *\n   * @param uiMessages - Array of AI SDK V5 UI messages\n   * @param stepNumber - Step number to extract (1-indexed, or -1 for last step)\n   * @param stepContentFn - Function to convert model messages to step content\n   * @returns Step content array\n   */\n  static extractStepContent(\n    uiMessages: AIV5Type.UIMessage[],\n    stepNumber: number,\n    stepContentFn: (message?: AIV5Type.ModelMessage) => AIV5Type.StepResult<any>['content'],\n  ): AIV5Type.StepResult<any>['content'] {\n    const uiMessagesParts = uiMessages.flatMap(item => item.parts);\n\n    // Find step boundaries by looking for step-start markers\n    const stepBoundaries: number[] = [];\n    uiMessagesParts.forEach((part, index) => {\n      if (part.type === 'step-start') {\n        stepBoundaries.push(index);\n      }\n    });\n\n    // Handle -1 to get the last step (the current/most recent step)\n    if (stepNumber === -1) {\n      return StepContentExtractor.extractLastStep(uiMessagesParts, stepBoundaries, stepContentFn);\n    }\n\n    // Step 1 is everything before the first step-start\n    if (stepNumber === 1) {\n      return StepContentExtractor.extractFirstStep(uiMessagesParts, stepBoundaries, stepContentFn);\n    }\n\n    // For steps 2+, content is between (stepNumber-1)th and stepNumber-th step-start markers\n    return StepContentExtractor.extractMiddleStep(uiMessagesParts, stepBoundaries, stepNumber, stepContentFn);\n  }\n\n  /**\n   * Extract the last step content (stepNumber === -1)\n   */\n  private static extractLastStep(\n    uiMessagesParts: AIV5Type.UIMessage['parts'],\n    stepBoundaries: number[],\n    stepContentFn: (message?: AIV5Type.ModelMessage) => AIV5Type.StepResult<any>['content'],\n  ): AIV5Type.StepResult<any>['content'] {\n    // For tool-only steps without step-start markers, we need different logic\n    // Each tool part represents a complete step (tool call + result)\n    const toolParts = uiMessagesParts.filter(p => p.type?.startsWith('tool-'));\n    const hasStepStart = stepBoundaries.length > 0;\n\n    if (!hasStepStart && toolParts.length > 0) {\n      // No step-start markers but we have tool parts\n      // Each tool part is a separate step, so return only the last tool\n      const lastToolPart = toolParts[toolParts.length - 1];\n      if (!lastToolPart) {\n        return [];\n      }\n      const lastToolIndex = uiMessagesParts.indexOf(lastToolPart);\n      const previousToolPart = toolParts[toolParts.length - 2];\n      const previousToolIndex = previousToolPart ? uiMessagesParts.indexOf(previousToolPart) : -1;\n\n      const startIndex = previousToolIndex + 1;\n      const stepParts = uiMessagesParts.slice(startIndex, lastToolIndex + 1);\n\n      return StepContentExtractor.convertPartsToContent(stepParts, 'last-step', stepContentFn);\n    }\n\n    // Count total steps (1 + number of step-start markers)\n    const totalSteps = stepBoundaries.length + 1;\n\n    // Get the content for the last step using the regular step logic\n    if (totalSteps === 1 && !hasStepStart) {\n      // Only one step, return all content\n      return StepContentExtractor.convertPartsToContent(uiMessagesParts, 'last-step', stepContentFn);\n    }\n\n    // Multiple steps - get content after the last step-start marker\n    const lastStepStart = stepBoundaries[stepBoundaries.length - 1];\n    if (lastStepStart === undefined) {\n      return [];\n    }\n    const stepParts = uiMessagesParts.slice(lastStepStart + 1);\n\n    if (stepParts.length === 0) {\n      return [];\n    }\n\n    return StepContentExtractor.convertPartsToContent(stepParts, 'last-step', stepContentFn);\n  }\n\n  /**\n   * Extract the first step content (stepNumber === 1)\n   */\n  private static extractFirstStep(\n    uiMessagesParts: AIV5Type.UIMessage['parts'],\n    stepBoundaries: number[],\n    stepContentFn: (message?: AIV5Type.ModelMessage) => AIV5Type.StepResult<any>['content'],\n  ): AIV5Type.StepResult<any>['content'] {\n    const firstStepStart = stepBoundaries[0] ?? uiMessagesParts.length;\n    if (firstStepStart === 0) {\n      // No content before first step-start\n      return [];\n    }\n\n    const stepParts = uiMessagesParts.slice(0, firstStepStart);\n    return StepContentExtractor.convertPartsToContent(stepParts, 'step-1', stepContentFn);\n  }\n\n  /**\n   * Extract content for steps 2+ (between step-start markers)\n   */\n  private static extractMiddleStep(\n    uiMessagesParts: AIV5Type.UIMessage['parts'],\n    stepBoundaries: number[],\n    stepNumber: number,\n    stepContentFn: (message?: AIV5Type.ModelMessage) => AIV5Type.StepResult<any>['content'],\n  ): AIV5Type.StepResult<any>['content'] {\n    const stepIndex = stepNumber - 2; // -2 because step 2 is at index 0 in boundaries\n    if (stepIndex < 0 || stepIndex >= stepBoundaries.length) {\n      return [];\n    }\n\n    const startIndex = (stepBoundaries[stepIndex] ?? 0) + 1; // Start after the step-start marker\n    const endIndex = stepBoundaries[stepIndex + 1] ?? uiMessagesParts.length;\n\n    if (startIndex >= endIndex) {\n      return [];\n    }\n\n    const stepParts = uiMessagesParts.slice(startIndex, endIndex);\n    return StepContentExtractor.convertPartsToContent(stepParts, `step-${stepNumber}`, stepContentFn);\n  }\n\n  /**\n   * Convert UI message parts to step content\n   */\n  private static convertPartsToContent(\n    parts: AIV5Type.UIMessage['parts'],\n    stepId: string,\n    stepContentFn: (message?: AIV5Type.ModelMessage) => AIV5Type.StepResult<any>['content'],\n  ): AIV5Type.StepResult<any>['content'] {\n    const stepUiMessages: AIV5Type.UIMessage[] = [\n      {\n        id: stepId,\n        role: 'assistant',\n        parts,\n      },\n    ];\n\n    const modelMessages = AIV5.convertToModelMessages(sanitizeV5UIMessages(stepUiMessages));\n    return modelMessages.flatMap(stepContentFn);\n  }\n\n  /**\n   * Convert a single model message content to step result content\n   *\n   * This handles:\n   * - Tool results: adding input field from DB messages\n   * - Files: converting to GeneratedFile format\n   * - Images: converting to file format with proper media type\n   * - Other content: passed through as-is\n   *\n   * @param message - Model message to convert (or undefined to use latest)\n   * @param dbMessages - Database messages for looking up tool call args\n   * @param getLatestMessage - Function to get the latest model message if not provided\n   */\n  static convertToStepContent(\n    message: AIV5Type.ModelMessage | undefined,\n    dbMessages: MastraDBMessage[],\n    getLatestMessage: () => AIV5Type.ModelMessage | undefined,\n  ): AIV5Type.StepResult<any>['content'] {\n    const latest = message ? message : getLatestMessage();\n    if (!latest) return [];\n\n    if (typeof latest.content === 'string') {\n      return [{ type: 'text', text: latest.content }];\n    }\n\n    return latest.content.map(c => {\n      if (c.type === 'tool-result') {\n        return {\n          type: 'tool-result',\n          input: findToolCallArgs(dbMessages, c.toolCallId),\n          output: c.output,\n          toolCallId: c.toolCallId,\n          toolName: c.toolName,\n        } satisfies AIV5Type.StaticToolResult<any>;\n      }\n\n      if (c.type === 'file') {\n        return {\n          type: 'file',\n          file: new DefaultGeneratedFileWithType({\n            data:\n              typeof c.data === 'string'\n                ? parseDataUri(c.data).base64Content // Strip data URI prefix if present\n                : c.data instanceof URL\n                  ? c.data.toString()\n                  : convertDataContentToBase64String(c.data),\n            mediaType: c.mediaType,\n          }),\n        } satisfies Extract<AIV5Type.StepResult<any>['content'][number], { type: 'file' }>;\n      }\n\n      if (c.type === 'image') {\n        return {\n          type: 'file',\n          file: new DefaultGeneratedFileWithType({\n            data:\n              typeof c.image === 'string'\n                ? parseDataUri(c.image).base64Content // Strip data URI prefix if present\n                : c.image instanceof URL\n                  ? c.image.toString()\n                  : convertDataContentToBase64String(c.image),\n            mediaType: c.mediaType || 'unknown',\n          }),\n        };\n      }\n\n      return { ...c };\n    });\n  }\n}\n","import { CacheKeyGenerator } from '../cache/CacheKeyGenerator';\nimport type { MastraDBMessage, MastraMessageContentV2 } from '../state/types';\n\n/**\n * MessageMerger - Handles complex logic for merging assistant messages\n *\n * When streaming responses from LLMs, we often receive multiple messages that need to be\n * merged together:\n * - Tool calls that need to be updated with their results\n * - Text parts that need to be appended\n * - Step-start markers that need to be inserted\n *\n * This class encapsulates all the complex merging logic that was previously spread\n * throughout the MessageList.addOne method.\n */\nexport class MessageMerger {\n  /**\n   * Check if we should merge an incoming message with the latest message\n   *\n   * @param latestMessage - The most recent message in the list\n   * @param incomingMessage - The message being added\n   * @param messageSource - The source of the incoming message ('memory', 'input', 'response', 'context')\n   * @param isLatestFromMemory - Whether the latest message is from memory\n   * @param agentNetworkAppend - Whether agent network append mode is enabled\n   */\n  static shouldMerge(\n    latestMessage: MastraDBMessage | undefined,\n    incomingMessage: MastraDBMessage,\n    messageSource: string,\n    isLatestFromMemory: boolean,\n    agentNetworkAppend: boolean = false,\n  ): boolean {\n    if (!latestMessage) return false;\n\n    // Basic merge conditions: both messages must be assistant messages from the same thread\n    const shouldAppendToLastAssistantMessage =\n      latestMessage.role === 'assistant' &&\n      incomingMessage.role === 'assistant' &&\n      latestMessage.threadId === incomingMessage.threadId &&\n      // If the message is from memory, don't append to the last assistant message\n      messageSource !== 'memory';\n\n    // Agent network append flag handling\n    // When enabled, only merge if the latest message is NOT from memory\n    const appendNetworkMessage = agentNetworkAppend ? !isLatestFromMemory : true;\n\n    return shouldAppendToLastAssistantMessage && appendNetworkMessage;\n  }\n\n  /**\n   * Merge an incoming assistant message into the latest assistant message\n   *\n   * This handles:\n   * - Updating tool invocations with their results\n   * - Adding new parts in the correct order using anchor maps\n   * - Inserting step-start markers where needed\n   * - Updating timestamps and content strings\n   */\n  static merge(latestMessage: MastraDBMessage, incomingMessage: MastraDBMessage): void {\n    // Update timestamp\n    latestMessage.createdAt = incomingMessage.createdAt || latestMessage.createdAt;\n\n    // Used for mapping indexes for incomingMessage parts to corresponding indexes in latestMessage\n    const toolResultAnchorMap = new Map<number, number>();\n    const partsToAdd = new Map<number, MastraMessageContentV2['parts'][number]>();\n\n    for (const [index, part] of incomingMessage.content.parts.entries()) {\n      // If the incoming part is a tool-invocation result, find the corresponding call in the latest message\n      if (part.type === 'tool-invocation') {\n        const existingCallPart = [...latestMessage.content.parts]\n          .reverse()\n          .find(p => p.type === 'tool-invocation' && p.toolInvocation.toolCallId === part.toolInvocation.toolCallId);\n\n        const existingCallToolInvocation = !!existingCallPart && existingCallPart.type === 'tool-invocation';\n\n        if (existingCallToolInvocation) {\n          if (part.toolInvocation.state === 'result') {\n            // Update the existing tool-call part with the result\n            existingCallPart.toolInvocation = {\n              ...existingCallPart.toolInvocation,\n              step: part.toolInvocation.step,\n              state: 'result',\n              result: part.toolInvocation.result,\n              args: {\n                ...existingCallPart.toolInvocation.args,\n                ...part.toolInvocation.args,\n              },\n            };\n            if (!latestMessage.content.toolInvocations) {\n              latestMessage.content.toolInvocations = [];\n            }\n            const toolInvocationIndex = latestMessage.content.toolInvocations.findIndex(\n              t => t.toolCallId === existingCallPart.toolInvocation.toolCallId,\n            );\n            if (toolInvocationIndex === -1) {\n              latestMessage.content.toolInvocations.push(existingCallPart.toolInvocation);\n            } else {\n              latestMessage.content.toolInvocations[toolInvocationIndex] = existingCallPart.toolInvocation;\n            }\n          }\n          // Map the index of the tool call in incomingMessage to the index of the tool call in latestMessage\n          const existingIndex = latestMessage.content.parts.findIndex(p => p === existingCallPart);\n          toolResultAnchorMap.set(index, existingIndex);\n          // Otherwise we do nothing, as we're not updating the tool call\n        } else {\n          partsToAdd.set(index, part);\n        }\n      } else {\n        partsToAdd.set(index, part);\n      }\n    }\n\n    MessageMerger.addPartsToMessage({\n      latestMessage,\n      incomingMessage,\n      anchorMap: toolResultAnchorMap,\n      partsToAdd,\n    });\n\n    if (latestMessage.createdAt.getTime() < incomingMessage.createdAt.getTime()) {\n      latestMessage.createdAt = incomingMessage.createdAt;\n    }\n    if (!latestMessage.content.content && incomingMessage.content.content) {\n      latestMessage.content.content = incomingMessage.content.content;\n    }\n    if (\n      latestMessage.content.content &&\n      incomingMessage.content.content &&\n      latestMessage.content.content !== incomingMessage.content.content\n    ) {\n      // Match what AI SDK does - content string is always the latest text part.\n      latestMessage.content.content = incomingMessage.content.content;\n    }\n  }\n\n  /**\n   * Add parts from the incoming message to the latest message using anchor positions\n   */\n  private static addPartsToMessage({\n    latestMessage,\n    incomingMessage,\n    anchorMap,\n    partsToAdd,\n  }: {\n    latestMessage: MastraDBMessage;\n    incomingMessage: MastraDBMessage;\n    anchorMap: Map<number, number>;\n    partsToAdd: Map<number, MastraMessageContentV2['parts'][number]>;\n  }): void {\n    // Walk through incomingMessage, inserting any part not present at the canonical position\n    for (let i = 0; i < incomingMessage.content.parts.length; ++i) {\n      const part = incomingMessage.content.parts[i];\n      if (!part) continue;\n      const key = CacheKeyGenerator.fromDBParts([part]);\n      const partToAdd = partsToAdd.get(i);\n      if (!key || !partToAdd) continue;\n      if (anchorMap.size > 0) {\n        if (anchorMap.has(i)) continue; // skip anchors\n        // Find left anchor in incomingMessage\n        const leftAnchorV2 = [...anchorMap.keys()].filter(idx => idx < i).pop() ?? -1;\n        // Find right anchor in incomingMessage\n        const rightAnchorV2 = [...anchorMap.keys()].find(idx => idx > i) ?? -1;\n\n        // Map to latestMessage\n        const leftAnchorLatest = leftAnchorV2 !== -1 ? anchorMap.get(leftAnchorV2)! : 0;\n\n        // Compute offset from anchor\n        const offset = leftAnchorV2 === -1 ? i : i - leftAnchorV2;\n\n        // Insert at proportional position\n        const insertAt = leftAnchorLatest + offset;\n\n        const rightAnchorLatest =\n          rightAnchorV2 !== -1 ? anchorMap.get(rightAnchorV2)! : latestMessage.content.parts.length;\n\n        if (\n          insertAt >= 0 &&\n          insertAt <= rightAnchorLatest &&\n          !latestMessage.content.parts\n            .slice(insertAt, rightAnchorLatest)\n            .some(p => CacheKeyGenerator.fromDBParts([p]) === CacheKeyGenerator.fromDBParts([part]))\n        ) {\n          MessageMerger.pushNewPart({\n            latestMessage,\n            newMessage: incomingMessage,\n            part,\n            insertAt,\n          });\n          for (const [v2Idx, latestIdx] of anchorMap.entries()) {\n            if (latestIdx >= insertAt) {\n              anchorMap.set(v2Idx, latestIdx + 1);\n            }\n          }\n        }\n      } else {\n        MessageMerger.pushNewPart({\n          latestMessage,\n          newMessage: incomingMessage,\n          part,\n        });\n      }\n    }\n  }\n\n  /**\n   * Push a new message part to the latest message\n   */\n  private static pushNewPart({\n    latestMessage,\n    newMessage,\n    part,\n    insertAt,\n  }: {\n    latestMessage: MastraDBMessage;\n    newMessage: MastraDBMessage;\n    part: MastraMessageContentV2['parts'][number];\n    insertAt?: number;\n  }): void {\n    const partKey = CacheKeyGenerator.fromDBParts([part]);\n    const latestPartCount = latestMessage.content.parts.filter(\n      p => CacheKeyGenerator.fromDBParts([p]) === partKey,\n    ).length;\n    const newPartCount = newMessage.content.parts.filter(p => CacheKeyGenerator.fromDBParts([p]) === partKey).length;\n    // If the number of parts in the latest message is less than the number of parts in the new message, insert the part\n    if (latestPartCount < newPartCount) {\n      // Check if we need to add a step-start before text parts when merging assistant messages\n      // Only add after tool invocations, and only if the incoming message doesn't already have step-start\n      const partIndex = newMessage.content.parts.indexOf(part);\n      const hasStepStartBefore = partIndex > 0 && newMessage.content.parts[partIndex - 1]?.type === 'step-start';\n\n      const needsStepStart =\n        latestMessage.role === 'assistant' &&\n        part.type === 'text' &&\n        !hasStepStartBefore &&\n        latestMessage.content.parts.length > 0 &&\n        latestMessage.content.parts.at(-1)?.type === 'tool-invocation';\n\n      if (typeof insertAt === 'number') {\n        if (needsStepStart) {\n          latestMessage.content.parts.splice(insertAt, 0, { type: 'step-start' });\n          latestMessage.content.parts.splice(insertAt + 1, 0, part);\n        } else {\n          latestMessage.content.parts.splice(insertAt, 0, part);\n        }\n      } else {\n        if (needsStepStart) {\n          latestMessage.content.parts.push({ type: 'step-start' });\n        }\n        latestMessage.content.parts.push(part);\n      }\n    }\n  }\n}\n","import type { LanguageModelV2DataContent } from '@ai-sdk/provider-v5';\nimport type { DataContent } from '@internal/ai-sdk-v5';\nimport { ErrorCategory, ErrorDomain, MastraError } from '../../../../error';\n\nfunction splitDataUrl(dataUrl: string): {\n  mediaType: string | undefined;\n  base64Content: string | undefined;\n} {\n  try {\n    const [header, base64Content] = dataUrl.split(',');\n    return {\n      mediaType: header?.split(';')[0]?.split(':')[1],\n      base64Content,\n    };\n  } catch {\n    return {\n      mediaType: undefined,\n      base64Content: undefined,\n    };\n  }\n}\n\nexport function convertToDataContent(content: DataContent | URL): {\n  data: LanguageModelV2DataContent;\n  mediaType: string | undefined;\n} {\n  // Buffer & Uint8Array:\n  if (content instanceof Uint8Array) {\n    return { data: content, mediaType: undefined };\n  }\n\n  // ArrayBuffer needs conversion to Uint8Array (lightweight):\n  if (content instanceof ArrayBuffer) {\n    return { data: new Uint8Array(content), mediaType: undefined };\n  }\n\n  // Attempt to create a URL from the data. If it fails, we can assume the data\n  // is not a URL and likely some other sort of data.\n  if (typeof content === 'string') {\n    try {\n      content = new URL(content);\n    } catch {\n      // ignored\n    }\n  }\n\n  // Extract data from data URL:\n  if (content instanceof URL && content.protocol === 'data:') {\n    const { mediaType: dataUrlMediaType, base64Content } = splitDataUrl(content.toString());\n\n    if (dataUrlMediaType == null || base64Content == null) {\n      throw new MastraError({\n        id: 'INVALID_DATA_URL_FORMAT',\n        text: `Invalid data URL format in content ${content.toString()}`,\n        domain: ErrorDomain.LLM,\n        category: ErrorCategory.USER,\n      });\n    }\n\n    return { data: base64Content, mediaType: dataUrlMediaType };\n  }\n\n  return { data: content, mediaType: undefined };\n}\n","import { convertBase64ToUint8Array } from '@ai-sdk/provider-utils-v5';\n\nexport const imageMediaTypeSignatures = [\n  {\n    mediaType: 'image/gif' as const,\n    bytesPrefix: [0x47, 0x49, 0x46],\n    base64Prefix: 'R0lG',\n  },\n  {\n    mediaType: 'image/png' as const,\n    bytesPrefix: [0x89, 0x50, 0x4e, 0x47],\n    base64Prefix: 'iVBORw',\n  },\n  {\n    mediaType: 'image/jpeg' as const,\n    bytesPrefix: [0xff, 0xd8],\n    base64Prefix: '/9j/',\n  },\n  {\n    mediaType: 'image/webp' as const,\n    bytesPrefix: [0x52, 0x49, 0x46, 0x46],\n    base64Prefix: 'UklGRg',\n  },\n  {\n    mediaType: 'image/bmp' as const,\n    bytesPrefix: [0x42, 0x4d],\n    base64Prefix: 'Qk',\n  },\n  {\n    mediaType: 'image/tiff' as const,\n    bytesPrefix: [0x49, 0x49, 0x2a, 0x00],\n    base64Prefix: 'SUkqAA',\n  },\n  {\n    mediaType: 'image/tiff' as const,\n    bytesPrefix: [0x4d, 0x4d, 0x00, 0x2a],\n    base64Prefix: 'TU0AKg',\n  },\n  {\n    mediaType: 'image/avif' as const,\n    bytesPrefix: [0x00, 0x00, 0x00, 0x20, 0x66, 0x74, 0x79, 0x70, 0x61, 0x76, 0x69, 0x66],\n    base64Prefix: 'AAAAIGZ0eXBhdmlm',\n  },\n  {\n    mediaType: 'image/heic' as const,\n    bytesPrefix: [0x00, 0x00, 0x00, 0x20, 0x66, 0x74, 0x79, 0x70, 0x68, 0x65, 0x69, 0x63],\n    base64Prefix: 'AAAAIGZ0eXBoZWlj',\n  },\n] as const;\n\nexport const audioMediaTypeSignatures = [\n  {\n    mediaType: 'audio/mpeg' as const,\n    bytesPrefix: [0xff, 0xfb],\n    base64Prefix: '//s=',\n  },\n  {\n    mediaType: 'audio/mpeg' as const,\n    bytesPrefix: [0xff, 0xfa],\n    base64Prefix: '//o=',\n  },\n  {\n    mediaType: 'audio/mpeg' as const,\n    bytesPrefix: [0xff, 0xf3],\n    base64Prefix: '//M=',\n  },\n  {\n    mediaType: 'audio/mpeg' as const,\n    bytesPrefix: [0xff, 0xf2],\n    base64Prefix: '//I=',\n  },\n  {\n    mediaType: 'audio/mpeg' as const,\n    bytesPrefix: [0xff, 0xe3],\n    base64Prefix: '/+M=',\n  },\n  {\n    mediaType: 'audio/mpeg' as const,\n    bytesPrefix: [0xff, 0xe2],\n    base64Prefix: '/+I=',\n  },\n  {\n    mediaType: 'audio/wav' as const,\n    bytesPrefix: [0x52, 0x49, 0x46, 0x46],\n    base64Prefix: 'UklGR',\n  },\n  {\n    mediaType: 'audio/ogg' as const,\n    bytesPrefix: [0x4f, 0x67, 0x67, 0x53],\n    base64Prefix: 'T2dnUw',\n  },\n  {\n    mediaType: 'audio/flac' as const,\n    bytesPrefix: [0x66, 0x4c, 0x61, 0x43],\n    base64Prefix: 'ZkxhQw',\n  },\n  {\n    mediaType: 'audio/aac' as const,\n    bytesPrefix: [0x40, 0x15, 0x00, 0x00],\n    base64Prefix: 'QBUA',\n  },\n  {\n    mediaType: 'audio/mp4' as const,\n    bytesPrefix: [0x66, 0x74, 0x79, 0x70],\n    base64Prefix: 'ZnR5cA',\n  },\n  {\n    mediaType: 'audio/webm',\n    bytesPrefix: [0x1a, 0x45, 0xdf, 0xa3],\n    base64Prefix: 'GkXf',\n  },\n] as const;\n\nconst stripID3 = (data: Uint8Array | string) => {\n  const bytes = typeof data === 'string' ? convertBase64ToUint8Array(data) : data;\n  const id3Size =\n    // @ts-ignore\n    ((bytes[6] & 0x7f) << 21) |\n    // @ts-ignore\n    ((bytes[7] & 0x7f) << 14) |\n    // @ts-ignore\n    ((bytes[8] & 0x7f) << 7) |\n    // @ts-ignore\n    (bytes[9] & 0x7f);\n\n  // The raw MP3 starts here\n  return bytes.slice(id3Size + 10);\n};\n\nfunction stripID3TagsIfPresent(data: Uint8Array | string): Uint8Array | string {\n  const hasId3 =\n    (typeof data === 'string' && data.startsWith('SUQz')) ||\n    (typeof data !== 'string' &&\n      data.length > 10 &&\n      data[0] === 0x49 && // 'I'\n      data[1] === 0x44 && // 'D'\n      data[2] === 0x33); // '3'\n\n  return hasId3 ? stripID3(data) : data;\n}\n\nexport function detectMediaType({\n  data,\n  signatures,\n}: {\n  data: Uint8Array | string;\n  signatures: typeof audioMediaTypeSignatures | typeof imageMediaTypeSignatures;\n}): (typeof signatures)[number]['mediaType'] | undefined {\n  const processedData = stripID3TagsIfPresent(data);\n\n  for (const signature of signatures) {\n    if (\n      typeof processedData === 'string'\n        ? processedData.startsWith(signature.base64Prefix)\n        : processedData.length >= signature.bytesPrefix.length &&\n          signature.bytesPrefix.every((byte, index) => processedData[index] === byte)\n    ) {\n      return signature.mediaType;\n    }\n  }\n\n  return undefined;\n}\n","import type { DataContent, ImagePart, FilePart } from '@ai-sdk/provider-utils-v5';\nimport type { LanguageModelV2FilePart, LanguageModelV2TextPart } from '@ai-sdk/provider-v5';\nimport { convertToDataContent, detectMediaType, imageMediaTypeSignatures } from '../../../stream/aisdk/v5/compat';\n\nexport function convertImageFilePart(\n  part: ImagePart | FilePart,\n  downloadedAssets?: Record<string, { mediaType: string | undefined; data: Uint8Array }>,\n): LanguageModelV2TextPart | LanguageModelV2FilePart {\n  let originalData: DataContent | URL;\n  const type = part.type;\n  switch (type) {\n    case 'image':\n      originalData = part.image;\n      break;\n    case 'file':\n      originalData = part.data;\n\n      break;\n    default:\n      throw new Error(`Unsupported part type: ${type}`);\n  }\n\n  const { data: convertedData, mediaType: convertedMediaType } = convertToDataContent(originalData);\n\n  let mediaType: string | undefined = convertedMediaType ?? part.mediaType;\n  let data: Uint8Array | string | URL = convertedData; // binary | base64 | url\n\n  // If the content is a URL, we check if it was downloaded:\n  if (data instanceof URL && downloadedAssets) {\n    const downloadedFile = downloadedAssets[data.toString()];\n    if (downloadedFile) {\n      data = downloadedFile.data;\n      mediaType ??= downloadedFile.mediaType;\n    }\n  }\n\n  // Now that we have the normalized data either as a URL or a Uint8Array,\n  // we can create the LanguageModelV2Part.\n  switch (type) {\n    case 'image': {\n      // When possible, try to detect the media type automatically\n      // to deal with incorrect media type inputs.\n      // When detection fails, use provided media type.\n      if (data instanceof Uint8Array || typeof data === 'string') {\n        mediaType = detectMediaType({ data, signatures: imageMediaTypeSignatures }) ?? mediaType;\n      }\n\n      return {\n        type: 'file',\n        mediaType: mediaType ?? 'image/*', // any image\n        filename: undefined,\n        data,\n        providerOptions: part.providerOptions,\n      };\n    }\n\n    case 'file': {\n      // We must have a mediaType for files, if not, throw an error.\n      if (mediaType == null) {\n        throw new Error(`Media type is missing for file part`);\n      }\n\n      return {\n        type: 'file',\n        mediaType,\n        filename: part.filename,\n        data,\n        providerOptions: part.providerOptions,\n      };\n    }\n  }\n}\n","import type { Attachment } from '@ai-sdk/ui-utils-v5';\nimport type { FilePart, ImagePart, TextPart } from '@internal/ai-sdk-v4';\nimport { categorizeFileData, createDataUri } from './image-utils';\n\ntype ContentPart = TextPart | ImagePart | FilePart;\n\n/**\n * Converts a list of attachments to a list of content parts\n * for consumption by `ai/core` functions.\n * Currently only supports images and text attachments.\n */\nexport function attachmentsToParts(attachments: Attachment[]): ContentPart[] {\n  const parts: ContentPart[] = [];\n\n  for (const attachment of attachments) {\n    // Categorize the attachment URL to determine if it's a URL, data URI, or raw base64\n    const categorized = categorizeFileData(attachment.url, attachment.contentType);\n\n    // If it's raw data (base64), convert it to a data URI\n    let urlString = attachment.url;\n    if (categorized.type === 'raw') {\n      urlString = createDataUri(attachment.url, attachment.contentType || 'application/octet-stream');\n    }\n\n    let url;\n    try {\n      url = new URL(urlString);\n    } catch {\n      throw new Error(`Invalid URL: ${attachment.url}`);\n    }\n\n    switch (url.protocol) {\n      case 'http:':\n      case 'https:':\n      // Cloud storage protocols supported by AI providers (e.g., Vertex AI for gs://, Bedrock for s3://)\n      case 'gs:':\n      case 's3:': {\n        if (attachment.contentType?.startsWith('image/')) {\n          parts.push({ type: 'image', image: url.toString(), mimeType: attachment.contentType });\n        } else {\n          if (!attachment.contentType) {\n            throw new Error('If the attachment is not an image, it must specify a content type');\n          }\n\n          parts.push({\n            type: 'file',\n            data: url.toString(),\n            mimeType: attachment.contentType,\n          });\n        }\n        break;\n      }\n\n      case 'data:': {\n        if (attachment.contentType?.startsWith('image/')) {\n          parts.push({\n            type: 'image',\n            image: urlString,\n            mimeType: attachment.contentType,\n          });\n        } else if (attachment.contentType?.startsWith('text/')) {\n          parts.push({\n            type: 'file',\n            data: urlString,\n            mimeType: attachment.contentType,\n          });\n        } else {\n          if (!attachment.contentType) {\n            throw new Error('If the attachment is not an image or text, it must specify a content type');\n          }\n\n          parts.push({\n            type: 'file',\n            data: urlString,\n            mimeType: attachment.contentType,\n          });\n        }\n\n        break;\n      }\n\n      default: {\n        throw new Error(`Unsupported URL protocol: ${url.protocol}`);\n      }\n    }\n  }\n\n  return parts;\n}\n","/**\n * This file is an adaptation of https://github.com/vercel/ai/blob/e14c066bf4d02c5ee2180c56a01fa0e5216bc582/packages/ai/core/prompt/convert-to-core-messages.ts\n * But has been modified to work with Mastra storage adapter messages (MastraMessageV1)\n */\nimport type { AssistantContent, ToolResultPart } from '@internal/ai-sdk-v4';\nimport type { MastraMessageV1 } from '../../../memory/types';\nimport type { MastraMessageContentV2, MastraDBMessage } from '../../message-list';\nimport { attachmentsToParts } from './attachments-to-parts';\n\nconst makePushOrCombine = (v1Messages: MastraMessageV1[]) => {\n  // Track how many times each ID has been used to create unique IDs for split messages\n  const idUsageCount = new Map<string, number>();\n\n  // Pattern to detect if an ID already has our split suffix\n  const SPLIT_SUFFIX_PATTERN = /__split-\\d+$/;\n\n  return (msg: MastraMessageV1) => {\n    const previousMessage = v1Messages.at(-1);\n    if (\n      msg.role === previousMessage?.role &&\n      Array.isArray(previousMessage.content) &&\n      Array.isArray(msg.content) &&\n      // we were creating new messages for tool calls before and not appending to the assistant message\n      // so don't append here so everything works as before\n      (msg.role !== `assistant` || (msg.role === `assistant` && msg.content.at(-1)?.type !== `tool-call`))\n    ) {\n      for (const part of msg.content) {\n        // @ts-ignore needs type gymnastics? msg.content and previousMessage.content are the same type here since both are arrays\n        // I'm not sure what's adding `never` to the union but this code definitely works..\n        previousMessage.content.push(part);\n      }\n    } else {\n      // When pushing a new message, check if we need to deduplicate the ID\n      let baseId = msg.id;\n\n      // Check if this ID already has a split suffix and extract the base ID\n      const hasSplitSuffix = SPLIT_SUFFIX_PATTERN.test(baseId);\n      if (hasSplitSuffix) {\n        // This ID already has a split suffix, don't add another one\n        v1Messages.push(msg);\n        return;\n      }\n\n      const currentCount = idUsageCount.get(baseId) || 0;\n\n      // If we've seen this ID before, append our unique split suffix\n      if (currentCount > 0) {\n        msg.id = `${baseId}__split-${currentCount}`;\n      }\n\n      // Increment the usage count for this base ID\n      idUsageCount.set(baseId, currentCount + 1);\n\n      v1Messages.push(msg);\n    }\n  };\n};\nexport function convertToV1Messages(messages: Array<MastraDBMessage>) {\n  const v1Messages: MastraMessageV1[] = [];\n  const pushOrCombine = makePushOrCombine(v1Messages);\n\n  for (let i = 0; i < messages.length; i++) {\n    const message = messages[i];\n    const isLastMessage = i === messages.length - 1;\n    if (!message?.content) continue;\n    const { content, experimental_attachments: inputAttachments = [], parts: inputParts } = message.content;\n    const { role } = message;\n\n    const fields = {\n      id: message.id,\n      createdAt: message.createdAt,\n      resourceId: message.resourceId!,\n      threadId: message.threadId!,\n    };\n\n    const experimental_attachments = [...inputAttachments];\n    const parts: typeof inputParts = [];\n    for (const part of inputParts) {\n      if (part.type === 'file') {\n        experimental_attachments.push({\n          url: part.data,\n          contentType: part.mimeType,\n        });\n      } else {\n        parts.push(part);\n      }\n    }\n\n    switch (role) {\n      case 'user': {\n        if (parts == null) {\n          const userContent = experimental_attachments\n            ? [{ type: 'text', text: content || '' }, ...attachmentsToParts(experimental_attachments)]\n            : { type: 'text', text: content || '' };\n          pushOrCombine({\n            role: 'user',\n            ...fields,\n            type: 'text',\n            // @ts-ignore\n            content: userContent,\n          });\n        } else {\n          const textParts = message.content.parts\n            .filter(part => part.type === 'text')\n            .map(part => ({\n              type: 'text' as const,\n              text: part.text,\n            }));\n\n          const userContent = experimental_attachments\n            ? [...textParts, ...attachmentsToParts(experimental_attachments)]\n            : textParts;\n          pushOrCombine({\n            role: 'user',\n            ...fields,\n            type: 'text',\n            content:\n              Array.isArray(userContent) &&\n              userContent.length === 1 &&\n              userContent[0]?.type === `text` &&\n              typeof content !== `undefined`\n                ? content\n                : userContent,\n          });\n        }\n        break;\n      }\n\n      case 'assistant': {\n        if (message.content.parts != null) {\n          let currentStep = 0;\n          let blockHasToolInvocations = false;\n          let block: MastraMessageContentV2['parts'] = [];\n\n          function processBlock() {\n            const content: AssistantContent = [];\n\n            for (const part of block) {\n              switch (part.type) {\n                case 'file':\n                case 'text': {\n                  content.push(part);\n                  break;\n                }\n                case 'reasoning': {\n                  for (const detail of part.details) {\n                    switch (detail.type) {\n                      case 'text':\n                        content.push({\n                          type: 'reasoning' as const,\n                          text: detail.text,\n                          signature: detail.signature,\n                        });\n                        break;\n                      case 'redacted':\n                        content.push({\n                          type: 'redacted-reasoning' as const,\n                          data: detail.data,\n                        });\n                        break;\n                    }\n                  }\n                  break;\n                }\n                case 'tool-invocation':\n                  // Skip updateWorkingMemory tool calls as they should not be visible in history\n                  if (part.toolInvocation.toolName !== 'updateWorkingMemory') {\n                    content.push({\n                      type: 'tool-call' as const,\n                      toolCallId: part.toolInvocation.toolCallId,\n                      toolName: part.toolInvocation.toolName,\n                      args: part.toolInvocation.args,\n                    });\n                  }\n                  break;\n              }\n            }\n\n            pushOrCombine({\n              role: 'assistant',\n              ...fields,\n              type: content.some(c => c.type === `tool-call`) ? 'tool-call' : 'text',\n              content:\n                typeof content !== `string` &&\n                Array.isArray(content) &&\n                content.length === 1 &&\n                content[0]?.type === `text`\n                  ? content[0].text\n                  : content,\n            });\n\n            // check if there are tool invocations with results in the block\n            const stepInvocations = block\n              .filter(part => `type` in part && part.type === 'tool-invocation')\n              .map(part => part.toolInvocation)\n              .filter(ti => ti.toolName !== 'updateWorkingMemory');\n\n            // Only create tool-result message if there are actual results\n            const invocationsWithResults = stepInvocations.filter(ti => ti.state === 'result' && 'result' in ti);\n\n            if (invocationsWithResults.length > 0) {\n              pushOrCombine({\n                role: 'tool',\n                ...fields,\n                type: 'tool-result',\n                content: invocationsWithResults.map((toolInvocation): ToolResultPart => {\n                  const { toolCallId, toolName, result } = toolInvocation;\n                  return {\n                    type: 'tool-result',\n                    toolCallId,\n                    toolName,\n                    result,\n                  };\n                }),\n              });\n            }\n\n            // updates for next block\n            block = [];\n            blockHasToolInvocations = false;\n            currentStep++;\n          }\n\n          for (const part of message.content.parts) {\n            switch (part.type) {\n              case 'text': {\n                if (blockHasToolInvocations) {\n                  processBlock(); // text must come after tool invocations\n                }\n                block.push(part);\n                break;\n              }\n              case 'file':\n              case 'reasoning': {\n                block.push(part);\n                break;\n              }\n              case 'tool-invocation': {\n                // If we have non-tool content (text/file/reasoning) in the block, process it first\n                const hasNonToolContent = block.some(\n                  p => p.type === 'text' || p.type === 'file' || p.type === 'reasoning',\n                );\n                if (hasNonToolContent || (part.toolInvocation.step ?? 0) !== currentStep) {\n                  processBlock();\n                }\n                block.push(part);\n                blockHasToolInvocations = true;\n                break;\n              }\n            }\n          }\n\n          processBlock();\n\n          // Check if there are toolInvocations that weren't processed from parts\n          const toolInvocations = message.content.toolInvocations;\n          if (toolInvocations && toolInvocations.length > 0) {\n            // Find tool invocations that weren't already processed from parts\n            const processedToolCallIds = new Set<string>();\n            for (const part of message.content.parts) {\n              if (part.type === 'tool-invocation' && part.toolInvocation.toolCallId) {\n                processedToolCallIds.add(part.toolInvocation.toolCallId);\n              }\n            }\n\n            const unprocessedToolInvocations = toolInvocations.filter(\n              ti => !processedToolCallIds.has(ti.toolCallId) && ti.toolName !== 'updateWorkingMemory',\n            );\n\n            if (unprocessedToolInvocations.length > 0) {\n              // Group by step, handling undefined steps\n              const invocationsByStep = new Map<number, typeof unprocessedToolInvocations>();\n\n              for (const inv of unprocessedToolInvocations) {\n                const step = inv.step ?? 0;\n                if (!invocationsByStep.has(step)) {\n                  invocationsByStep.set(step, []);\n                }\n                invocationsByStep.get(step)!.push(inv);\n              }\n\n              // Process each step\n              const sortedSteps = Array.from(invocationsByStep.keys()).sort((a, b) => a - b);\n\n              for (const step of sortedSteps) {\n                const stepInvocations = invocationsByStep.get(step)!;\n\n                // Create tool-call message for all invocations (calls and results)\n                pushOrCombine({\n                  role: 'assistant',\n                  ...fields,\n                  type: 'tool-call',\n                  content: [\n                    ...stepInvocations.map(({ toolCallId, toolName, args }) => ({\n                      type: 'tool-call' as const,\n                      toolCallId,\n                      toolName,\n                      args,\n                    })),\n                  ],\n                });\n\n                // Only create tool-result message if there are actual results\n                const invocationsWithResults = stepInvocations.filter(ti => ti.state === 'result' && 'result' in ti);\n\n                if (invocationsWithResults.length > 0) {\n                  pushOrCombine({\n                    role: 'tool',\n                    ...fields,\n                    type: 'tool-result',\n                    content: invocationsWithResults.map((toolInvocation): ToolResultPart => {\n                      const { toolCallId, toolName, result } = toolInvocation;\n                      return {\n                        type: 'tool-result',\n                        toolCallId,\n                        toolName,\n                        result,\n                      };\n                    }),\n                  });\n                }\n              }\n            }\n          }\n\n          break;\n        }\n\n        const toolInvocations = message.content.toolInvocations;\n\n        if (toolInvocations == null || toolInvocations.length === 0) {\n          pushOrCombine({ role: 'assistant', ...fields, content: content || '', type: 'text' });\n          break;\n        }\n\n        const maxStep = toolInvocations.reduce((max, toolInvocation) => {\n          return Math.max(max, toolInvocation.step ?? 0);\n        }, 0);\n\n        for (let i = 0; i <= maxStep; i++) {\n          const stepInvocations = toolInvocations.filter(\n            toolInvocation => (toolInvocation.step ?? 0) === i && toolInvocation.toolName !== 'updateWorkingMemory',\n          );\n\n          if (stepInvocations.length === 0) {\n            continue;\n          }\n\n          // assistant message with tool calls\n          pushOrCombine({\n            role: 'assistant',\n            ...fields,\n            type: 'tool-call',\n            content: [\n              ...(isLastMessage && content && i === 0 ? [{ type: 'text' as const, text: content }] : []),\n              ...stepInvocations.map(({ toolCallId, toolName, args }) => ({\n                type: 'tool-call' as const,\n                toolCallId,\n                toolName,\n                args,\n              })),\n            ],\n          });\n\n          // Only create tool-result message if there are actual results\n          const invocationsWithResults = stepInvocations.filter(ti => ti.state === 'result' && 'result' in ti);\n\n          if (invocationsWithResults.length > 0) {\n            pushOrCombine({\n              role: 'tool',\n              ...fields,\n              type: 'tool-result',\n              content: invocationsWithResults.map((toolInvocation): ToolResultPart => {\n                const { toolCallId, toolName, result } = toolInvocation;\n                return {\n                  type: 'tool-result',\n                  toolCallId,\n                  toolName,\n                  result,\n                };\n              }),\n            });\n          }\n        }\n\n        if (content && !isLastMessage) {\n          pushOrCombine({ role: 'assistant', ...fields, type: 'text', content: content || '' });\n        }\n\n        break;\n      }\n    }\n  }\n\n  return v1Messages;\n}\n","/**\n * Fetches a URL with retry logic\n * @param url The URL to fetch\n * @param options Fetch options\n * @param maxRetries Maximum number of retry attempts\n * @returns The fetch Response if successful\n */\nexport async function fetchWithRetry(\n  url: string,\n  options: RequestInit = {},\n  maxRetries: number = 3,\n): Promise<Response> {\n  let retryCount = 0;\n  let lastError: Error | null = null;\n\n  while (retryCount < maxRetries) {\n    try {\n      const response = await fetch(url, options);\n\n      if (!response.ok) {\n        // Only retry on server errors (5xx) or network failures\n        // Don't retry on client errors (4xx)\n        if (response.status >= 400 && response.status < 500) {\n          throw new Error(`Request failed with status: ${response.status} ${response.statusText}`);\n        }\n\n        lastError = new Error(`Request failed with status: ${response.status} ${response.statusText}`);\n        retryCount++;\n\n        if (retryCount >= maxRetries) {\n          throw lastError;\n        }\n\n        const delay = Math.min(1000 * Math.pow(2, retryCount), 10000);\n        await new Promise(resolve => setTimeout(resolve, delay));\n        continue;\n      }\n\n      return response;\n    } catch (error) {\n      lastError = error instanceof Error ? error : new Error(String(error));\n\n      // If it's a client error (4xx), don't retry\n      if (lastError.message.includes('status: 4')) {\n        throw lastError;\n      }\n\n      retryCount++;\n\n      if (retryCount >= maxRetries) {\n        break;\n      }\n\n      const delay = Math.min(1000 * Math.pow(2, retryCount), 10000);\n      await new Promise(resolve => setTimeout(resolve, delay));\n    }\n  }\n\n  throw lastError || new Error('Request failed after multiple retry attempts');\n}\n","import { isUrlSupported } from '@ai-sdk/provider-utils-v5';\nimport { ErrorCategory, ErrorDomain, MastraError } from '../../../error';\nimport { fetchWithRetry } from '../../../utils/fetchWithRetry';\nimport type { AIV5Type } from '../types';\n\nexport const downloadFromUrl = async ({ url, downloadRetries }: { url: URL; downloadRetries: number }) => {\n  const urlText = url.toString();\n\n  try {\n    const response = await fetchWithRetry(\n      urlText,\n      {\n        method: 'GET',\n      },\n      downloadRetries,\n    );\n\n    if (!response.ok) {\n      throw new MastraError({\n        id: 'DOWNLOAD_ASSETS_FAILED',\n        text: 'Failed to download asset',\n        domain: ErrorDomain.LLM,\n        category: ErrorCategory.USER,\n      });\n    }\n    return {\n      data: new Uint8Array(await response.arrayBuffer()),\n      mediaType: response.headers.get('content-type') ?? undefined,\n    };\n  } catch (error) {\n    throw new MastraError(\n      {\n        id: 'DOWNLOAD_ASSETS_FAILED',\n        text: 'Failed to download asset',\n        domain: ErrorDomain.LLM,\n        category: ErrorCategory.USER,\n      },\n      error,\n    );\n  }\n};\n\nexport async function downloadAssetsFromMessages({\n  messages,\n  downloadConcurrency = 10,\n  downloadRetries = 3,\n  supportedUrls,\n}: {\n  messages: AIV5Type.ModelMessage[];\n  downloadConcurrency?: number;\n  downloadRetries?: number;\n  supportedUrls?: Record<string, RegExp[]>;\n}) {\n  const pMap = (await import('p-map')).default;\n\n  const filesToDownload = messages\n    .filter(message => message.role === 'user')\n    .map(message => message.content)\n    .filter(content => Array.isArray(content))\n    .flat()\n    .filter(part => part.type === 'image' || part.type === 'file')\n    .map(part => {\n      const mediaType = part.mediaType ?? (part.type === 'image' ? 'image/*' : undefined);\n\n      let data = part.type === 'image' ? part.image : part.data;\n      if (typeof data === 'string') {\n        try {\n          data = new URL(data);\n        } catch {}\n      }\n\n      return { mediaType, data };\n    })\n\n    .filter((part): part is { mediaType: string | undefined; data: URL } => part.data instanceof URL)\n    .map(part => {\n      return {\n        url: part.data,\n        isUrlSupportedByModel:\n          part.mediaType != null &&\n          isUrlSupported({\n            url: part.data.toString(),\n            mediaType: part.mediaType,\n            supportedUrls: supportedUrls ?? {},\n          }),\n      };\n    });\n\n  const downloadedFiles = await pMap(\n    filesToDownload,\n    async fileItem => {\n      if (fileItem.isUrlSupportedByModel) {\n        return null;\n      }\n      return {\n        url: fileItem.url.toString(),\n        ...(await downloadFromUrl({ url: fileItem.url, downloadRetries })),\n      };\n    },\n    {\n      concurrency: downloadConcurrency,\n    },\n  );\n\n  const downloadFileList = downloadedFiles\n    .filter(\n      (\n        downloadedFile,\n      ): downloadedFile is {\n        url: string;\n        mediaType: string | undefined;\n        data: Uint8Array<ArrayBuffer>;\n      } => downloadedFile?.data != null,\n    )\n    .map(({ url, data, mediaType }) => [url, { data, mediaType }]);\n\n  return Object.fromEntries(downloadFileList);\n}\n","import type { MastraDBMessage } from './types';\n\n/**\n * Serialized form of a MastraDBMessage where Date is converted to string\n */\nexport type SerializedMessage = Omit<MastraDBMessage, 'createdAt'> & {\n  createdAt: string;\n};\n\n/**\n * Serialize a message by converting Date to string\n */\nexport function serializeMessage(message: MastraDBMessage): SerializedMessage {\n  return {\n    ...message,\n    createdAt: message.createdAt.toUTCString(),\n  };\n}\n\n/**\n * Deserialize a message by converting string back to Date\n */\nexport function deserializeMessage(message: SerializedMessage): MastraDBMessage {\n  return {\n    ...message,\n    createdAt: new Date(message.createdAt),\n  } as MastraDBMessage;\n}\n\n/**\n * Serialize an array of messages\n */\nexport function serializeMessages(messages: MastraDBMessage[]): SerializedMessage[] {\n  return messages.map(serializeMessage);\n}\n\n/**\n * Deserialize an array of messages\n */\nexport function deserializeMessages(messages: SerializedMessage[]): MastraDBMessage[] {\n  return messages.map(deserializeMessage);\n}\n","import type { CoreSystemMessage } from '@internal/ai-sdk-v4';\n\nimport { serializeMessages, deserializeMessages } from './serialization';\nimport type { SerializedMessage } from './serialization';\nimport type { MastraDBMessage, MessageSource, MemoryInfo } from './types';\n\n// Re-export for backward compatibility\nexport type { MessageSource };\n\n/**\n * MessageStateManager - Manages the state of messages in a MessageList\n *\n * Handles:\n * - Tracking messages by their source (memory, input, response, context)\n * - Tracking which messages have been persisted\n * - Providing efficient lookups for message categorization\n *\n * This replaces the 8 Sets in the original MessageList with a more manageable interface.\n */\nexport class MessageStateManager {\n  // Messages tracked by source\n  private memoryMessages = new Set<MastraDBMessage>();\n  private newUserMessages = new Set<MastraDBMessage>();\n  private newResponseMessages = new Set<MastraDBMessage>();\n  private userContextMessages = new Set<MastraDBMessage>();\n\n  // Persisted message tracking\n  private memoryMessagesPersisted = new Set<MastraDBMessage>();\n  private newUserMessagesPersisted = new Set<MastraDBMessage>();\n  private newResponseMessagesPersisted = new Set<MastraDBMessage>();\n  private userContextMessagesPersisted = new Set<MastraDBMessage>();\n\n  /**\n   * Add a message to the appropriate source set and persisted set\n   */\n  addToSource(message: MastraDBMessage, source: MessageSource): void {\n    switch (source) {\n      case 'memory':\n        this.memoryMessages.add(message);\n        this.memoryMessagesPersisted.add(message);\n        break;\n      case 'response':\n        this.newResponseMessages.add(message);\n        this.newResponseMessagesPersisted.add(message);\n        // Handle case where a client-side tool response was added as user input\n        if (this.newUserMessages.has(message)) {\n          this.newUserMessages.delete(message);\n        }\n        break;\n      case 'input':\n      case 'user': // deprecated alias for input\n        this.newUserMessages.add(message);\n        this.newUserMessagesPersisted.add(message);\n        break;\n      case 'context':\n        this.userContextMessages.add(message);\n        this.userContextMessagesPersisted.add(message);\n        break;\n      default:\n        throw new Error(`Missing message source for message ${message}`);\n    }\n  }\n\n  /**\n   * Check if a message belongs to the memory source\n   */\n  isMemoryMessage(message: MastraDBMessage): boolean {\n    return this.memoryMessages.has(message);\n  }\n\n  /**\n   * Check if a message belongs to the input source\n   */\n  isUserMessage(message: MastraDBMessage): boolean {\n    return this.newUserMessages.has(message);\n  }\n\n  /**\n   * Check if a message belongs to the response source\n   */\n  isResponseMessage(message: MastraDBMessage): boolean {\n    return this.newResponseMessages.has(message);\n  }\n\n  /**\n   * Check if a message belongs to the context source\n   */\n  isContextMessage(message: MastraDBMessage): boolean {\n    return this.userContextMessages.has(message);\n  }\n\n  /**\n   * Get all memory messages\n   */\n  getMemoryMessages(): Set<MastraDBMessage> {\n    return this.memoryMessages;\n  }\n\n  /**\n   * Get all user/input messages\n   */\n  getUserMessages(): Set<MastraDBMessage> {\n    return this.newUserMessages;\n  }\n\n  /**\n   * Get all response messages\n   */\n  getResponseMessages(): Set<MastraDBMessage> {\n    return this.newResponseMessages;\n  }\n\n  /**\n   * Get all context messages\n   */\n  getContextMessages(): Set<MastraDBMessage> {\n    return this.userContextMessages;\n  }\n\n  /**\n   * Get persisted memory messages\n   */\n  getMemoryMessagesPersisted(): Set<MastraDBMessage> {\n    return this.memoryMessagesPersisted;\n  }\n\n  /**\n   * Get persisted user/input messages\n   */\n  getUserMessagesPersisted(): Set<MastraDBMessage> {\n    return this.newUserMessagesPersisted;\n  }\n\n  /**\n   * Get persisted response messages\n   */\n  getResponseMessagesPersisted(): Set<MastraDBMessage> {\n    return this.newResponseMessagesPersisted;\n  }\n\n  /**\n   * Get persisted context messages\n   */\n  getContextMessagesPersisted(): Set<MastraDBMessage> {\n    return this.userContextMessagesPersisted;\n  }\n\n  /**\n   * Remove a message from all source sets\n   */\n  removeMessage(message: MastraDBMessage): void {\n    this.memoryMessages.delete(message);\n    this.newUserMessages.delete(message);\n    this.newResponseMessages.delete(message);\n    this.userContextMessages.delete(message);\n  }\n\n  /**\n   * Clear all user messages\n   */\n  clearUserMessages(): void {\n    this.newUserMessages.clear();\n  }\n\n  /**\n   * Clear all response messages\n   */\n  clearResponseMessages(): void {\n    this.newResponseMessages.clear();\n  }\n\n  /**\n   * Clear all context messages\n   */\n  clearContextMessages(): void {\n    this.userContextMessages.clear();\n  }\n\n  /**\n   * Clear all messages from all sources (but not persisted tracking)\n   */\n  clearAll(): void {\n    this.newUserMessages.clear();\n    this.newResponseMessages.clear();\n    this.userContextMessages.clear();\n  }\n\n  /**\n   * Create a lookup function to determine message source\n   */\n  createSourceChecker(): {\n    memory: Set<string>;\n    input: Set<string>;\n    output: Set<string>;\n    context: Set<string>;\n    getSource: (message: MastraDBMessage) => MessageSource | null;\n  } {\n    const sources = {\n      memory: new Set(Array.from(this.memoryMessages.values()).map(m => m.id)),\n      output: new Set(Array.from(this.newResponseMessages.values()).map(m => m.id)),\n      input: new Set(Array.from(this.newUserMessages.values()).map(m => m.id)),\n      context: new Set(Array.from(this.userContextMessages.values()).map(m => m.id)),\n    };\n\n    return {\n      ...sources,\n      getSource: (msg: MastraDBMessage): MessageSource | null => {\n        if (sources.memory.has(msg.id)) return 'memory';\n        if (sources.input.has(msg.id)) return 'input';\n        if (sources.output.has(msg.id)) return 'response';\n        if (sources.context.has(msg.id)) return 'context';\n        return null;\n      },\n    };\n  }\n\n  /**\n   * Check if a message is a new (unsaved) user or response message by ID\n   */\n  isNewMessage(messageOrId: MastraDBMessage | string): boolean {\n    const id = typeof messageOrId === 'string' ? messageOrId : messageOrId.id;\n\n    // Check by object reference first (fast path)\n    if (typeof messageOrId !== 'string') {\n      if (this.newUserMessages.has(messageOrId) || this.newResponseMessages.has(messageOrId)) {\n        return true;\n      }\n    }\n\n    // Check by ID (handles copies)\n    return (\n      Array.from(this.newUserMessages).some(m => m.id === id) ||\n      Array.from(this.newResponseMessages).some(m => m.id === id)\n    );\n  }\n\n  /**\n   * Serialize source tracking state (message IDs only)\n   */\n  private serializeSourceTracking(): {\n    memoryMessages: string[];\n    newUserMessages: string[];\n    newResponseMessages: string[];\n    userContextMessages: string[];\n    memoryMessagesPersisted: string[];\n    newUserMessagesPersisted: string[];\n    newResponseMessagesPersisted: string[];\n    userContextMessagesPersisted: string[];\n  } {\n    const serializeSet = (set: Set<MastraDBMessage>) => Array.from(set).map(value => value.id);\n\n    return {\n      memoryMessages: serializeSet(this.memoryMessages),\n      newUserMessages: serializeSet(this.newUserMessages),\n      newResponseMessages: serializeSet(this.newResponseMessages),\n      userContextMessages: serializeSet(this.userContextMessages),\n      memoryMessagesPersisted: serializeSet(this.memoryMessagesPersisted),\n      newUserMessagesPersisted: serializeSet(this.newUserMessagesPersisted),\n      newResponseMessagesPersisted: serializeSet(this.newResponseMessagesPersisted),\n      userContextMessagesPersisted: serializeSet(this.userContextMessagesPersisted),\n    };\n  }\n\n  /**\n   * Deserialize source tracking state from message IDs\n   */\n  private deserializeSourceTracking(\n    state: ReturnType<typeof this.serializeSourceTracking>,\n    messages: MastraDBMessage[],\n  ): void {\n    const deserializeSet = (ids: string[]) =>\n      new Set(ids.map(id => messages.find(m => m.id === id)).filter(Boolean) as MastraDBMessage[]);\n\n    this.memoryMessages = deserializeSet(state.memoryMessages);\n    this.newUserMessages = deserializeSet(state.newUserMessages);\n    this.newResponseMessages = deserializeSet(state.newResponseMessages);\n    this.userContextMessages = deserializeSet(state.userContextMessages);\n    this.memoryMessagesPersisted = deserializeSet(state.memoryMessagesPersisted);\n    this.newUserMessagesPersisted = deserializeSet(state.newUserMessagesPersisted);\n    this.newResponseMessagesPersisted = deserializeSet(state.newResponseMessagesPersisted);\n    this.userContextMessagesPersisted = deserializeSet(state.userContextMessagesPersisted);\n  }\n\n  /**\n   * Serialize all MessageList state for workflow suspend/resume\n   */\n  serializeAll(data: {\n    messages: MastraDBMessage[];\n    systemMessages: CoreSystemMessage[];\n    taggedSystemMessages: Record<string, CoreSystemMessage[]>;\n    memoryInfo: MemoryInfo | null;\n    agentNetworkAppend: boolean;\n  }): SerializedMessageListState {\n    return {\n      messages: serializeMessages(data.messages),\n      systemMessages: data.systemMessages,\n      taggedSystemMessages: data.taggedSystemMessages,\n      memoryInfo: data.memoryInfo,\n      _agentNetworkAppend: data.agentNetworkAppend,\n      ...this.serializeSourceTracking(),\n    };\n  }\n\n  /**\n   * Deserialize all MessageList state from workflow suspend/resume\n   */\n  deserializeAll(state: SerializedMessageListState): {\n    messages: MastraDBMessage[];\n    systemMessages: CoreSystemMessage[];\n    taggedSystemMessages: Record<string, CoreSystemMessage[]>;\n    memoryInfo: MemoryInfo | null;\n    agentNetworkAppend: boolean;\n  } {\n    const messages = deserializeMessages(state.messages);\n\n    this.deserializeSourceTracking(\n      {\n        memoryMessages: state.memoryMessages,\n        newUserMessages: state.newUserMessages,\n        newResponseMessages: state.newResponseMessages,\n        userContextMessages: state.userContextMessages,\n        memoryMessagesPersisted: state.memoryMessagesPersisted,\n        newUserMessagesPersisted: state.newUserMessagesPersisted,\n        newResponseMessagesPersisted: state.newResponseMessagesPersisted,\n        userContextMessagesPersisted: state.userContextMessagesPersisted,\n      },\n      messages,\n    );\n\n    return {\n      messages,\n      systemMessages: state.systemMessages,\n      taggedSystemMessages: state.taggedSystemMessages,\n      memoryInfo: state.memoryInfo,\n      agentNetworkAppend: state._agentNetworkAppend,\n    };\n  }\n}\n\n/**\n * Serialized form of the complete MessageList state\n */\nexport interface SerializedMessageListState {\n  messages: SerializedMessage[];\n  systemMessages: CoreSystemMessage[];\n  taggedSystemMessages: Record<string, CoreSystemMessage[]>;\n  memoryInfo: MemoryInfo | null;\n  _agentNetworkAppend: boolean;\n  memoryMessages: string[];\n  newUserMessages: string[];\n  newResponseMessages: string[];\n  userContextMessages: string[];\n  memoryMessagesPersisted: string[];\n  newUserMessagesPersisted: string[];\n  newResponseMessagesPersisted: string[];\n  userContextMessagesPersisted: string[];\n}\n","import type { LanguageModelV2Prompt } from '@ai-sdk/provider-v5';\nimport type { LanguageModelV1Prompt, CoreMessage as CoreMessageV4 } from '@internal/ai-sdk-v4';\nimport type * as AIV4Type from '@internal/ai-sdk-v4';\nimport { v4 as randomUUID } from '@lukeed/uuid';\n\nimport { MastraError, ErrorDomain, ErrorCategory } from '../../error';\nimport type { IdGeneratorContext } from '../../types';\nimport { AIV4Adapter, AIV5Adapter } from './adapters';\nimport { CacheKeyGenerator } from './cache/CacheKeyGenerator';\nimport {\n  aiV4CoreMessageToV1PromptMessage,\n  aiV5ModelMessageToV2PromptMessage,\n  coreContentToString,\n  messagesAreEqual,\n  inputToMastraDBMessage as convertInputToMastraDBMessage,\n  aiV4UIMessagesToAIV4CoreMessages,\n  aiV5UIMessagesToAIV5ModelMessages as convertAIV5UIToModelMessages,\n  aiV4CoreMessagesToAIV5ModelMessages as convertAIV4CoreToAIV5ModelMessages,\n  systemMessageToAIV4Core,\n  StepContentExtractor,\n} from './conversion';\nimport { TypeDetector } from './detection/TypeDetector';\nimport { MessageMerger } from './merge';\nimport { convertImageFilePart } from './prompt/convert-file';\nimport { convertToV1Messages } from './prompt/convert-to-mastra-v1';\nimport { downloadAssetsFromMessages } from './prompt/download-assets';\nimport { MessageStateManager } from './state';\nimport type {\n  MastraDBMessage,\n  MastraMessageV1,\n  MessageSource,\n  MemoryInfo,\n  UIMessageWithMetadata,\n  SerializedMessageListState,\n} from './state';\nimport type { AIV5Type, AIV5ResponseMessage, MessageInput, MessageListInput } from './types';\nimport { ensureGeminiCompatibleMessages } from './utils/provider-compat';\n\nexport class MessageList {\n  private messages: MastraDBMessage[] = [];\n\n  // passed in by dev in input or context\n  private systemMessages: AIV4Type.CoreSystemMessage[] = [];\n  // passed in by us for a specific purpose, eg memory system message\n  private taggedSystemMessages: Record<string, AIV4Type.CoreSystemMessage[]> = {};\n\n  private memoryInfo: null | MemoryInfo = null;\n\n  // Centralized state management for message tracking\n  private stateManager = new MessageStateManager();\n\n  // Legacy getters for backward compatibility - delegate to stateManager\n  private get memoryMessages() {\n    return this.stateManager.getMemoryMessages();\n  }\n  private get newUserMessages() {\n    return this.stateManager.getUserMessages();\n  }\n  private get newResponseMessages() {\n    return this.stateManager.getResponseMessages();\n  }\n  private get userContextMessages() {\n    return this.stateManager.getContextMessages();\n  }\n  private get memoryMessagesPersisted() {\n    return this.stateManager.getMemoryMessagesPersisted();\n  }\n  private get newUserMessagesPersisted() {\n    return this.stateManager.getUserMessagesPersisted();\n  }\n  private get newResponseMessagesPersisted() {\n    return this.stateManager.getResponseMessagesPersisted();\n  }\n  private get userContextMessagesPersisted() {\n    return this.stateManager.getContextMessagesPersisted();\n  }\n\n  private generateMessageId?: (context?: IdGeneratorContext) => string;\n  private _agentNetworkAppend = false;\n\n  // Event recording for observability\n  private isRecording = false;\n  private recordedEvents: Array<{\n    type: 'add' | 'addSystem' | 'removeByIds' | 'clear';\n    source?: MessageSource;\n    count?: number;\n    ids?: string[];\n    text?: string;\n    tag?: string;\n    message?: CoreMessageV4;\n  }> = [];\n\n  constructor({\n    threadId,\n    resourceId,\n    generateMessageId,\n    // @ts-ignore Flag for agent network messages\n    _agentNetworkAppend,\n  }: { threadId?: string; resourceId?: string; generateMessageId?: (context?: IdGeneratorContext) => string } = {}) {\n    if (threadId) {\n      this.memoryInfo = { threadId, resourceId };\n    }\n    this.generateMessageId = generateMessageId;\n    this._agentNetworkAppend = _agentNetworkAppend || false;\n  }\n\n  /**\n   * Start recording mutations to the MessageList for observability/tracing\n   */\n  public startRecording(): void {\n    this.isRecording = true;\n    this.recordedEvents = [];\n  }\n\n  /**\n   * Stop recording and return the list of recorded events\n   */\n  public stopRecording(): Array<{\n    type: 'add' | 'addSystem' | 'removeByIds' | 'clear';\n    source?: MessageSource;\n    count?: number;\n    ids?: string[];\n    text?: string;\n    tag?: string;\n    message?: CoreMessageV4;\n  }> {\n    this.isRecording = false;\n    const events = [...this.recordedEvents];\n    this.recordedEvents = [];\n    return events;\n  }\n\n  public add(messages: MessageListInput, messageSource: MessageSource) {\n    if (messageSource === `user`) messageSource = `input`;\n\n    if (!messages) return this;\n    const messageArray = Array.isArray(messages) ? messages : [messages];\n\n    // Record event if recording is enabled\n    if (this.isRecording) {\n      this.recordedEvents.push({\n        type: 'add',\n        source: messageSource,\n        count: messageArray.length,\n      });\n    }\n\n    for (const message of messageArray) {\n      this.addOne(\n        typeof message === `string`\n          ? {\n              role: 'user',\n              content: message,\n            }\n          : message,\n        messageSource,\n      );\n    }\n    return this;\n  }\n\n  public serialize(): SerializedMessageListState {\n    return this.stateManager.serializeAll({\n      messages: this.messages,\n      systemMessages: this.systemMessages,\n      taggedSystemMessages: this.taggedSystemMessages,\n      memoryInfo: this.memoryInfo,\n      agentNetworkAppend: this._agentNetworkAppend,\n    });\n  }\n\n  public deserialize(state: SerializedMessageListState) {\n    const data = this.stateManager.deserializeAll(state);\n    this.messages = data.messages;\n    this.systemMessages = data.systemMessages;\n    this.taggedSystemMessages = data.taggedSystemMessages;\n    this.memoryInfo = data.memoryInfo;\n    this._agentNetworkAppend = data.agentNetworkAppend;\n    return this;\n  }\n\n  public makeMessageSourceChecker(): {\n    memory: Set<string>;\n    input: Set<string>;\n    output: Set<string>;\n    context: Set<string>;\n    getSource: (message: MastraDBMessage) => MessageSource | null;\n  } {\n    return this.stateManager.createSourceChecker();\n  }\n\n  public getLatestUserContent(): string | null {\n    const currentUserMessages = this.all.core().filter(m => m.role === 'user');\n    const content = currentUserMessages.at(-1)?.content;\n    if (!content) return null;\n    return coreContentToString(content);\n  }\n\n  public get get() {\n    return {\n      all: this.all,\n      remembered: this.remembered,\n      input: this.input,\n      response: this.response,\n    };\n  }\n  public get getPersisted() {\n    return {\n      remembered: this.rememberedPersisted,\n      input: this.inputPersisted,\n      taggedSystemMessages: this.taggedSystemMessages,\n      response: this.responsePersisted,\n    };\n  }\n\n  public get clear() {\n    return {\n      all: {\n        db: (): MastraDBMessage[] => {\n          const allMessages = [...this.messages];\n          this.messages = [];\n          this.stateManager.clearAll();\n          if (this.isRecording && allMessages.length > 0) {\n            this.recordedEvents.push({\n              type: 'clear',\n              count: allMessages.length,\n            });\n          }\n          return allMessages;\n        },\n      },\n      input: {\n        db: (): MastraDBMessage[] => {\n          const userMessages = Array.from(this.stateManager.getUserMessages());\n          this.messages = this.messages.filter(m => !this.stateManager.isUserMessage(m));\n          this.stateManager.clearUserMessages();\n          if (this.isRecording && userMessages.length > 0) {\n            this.recordedEvents.push({\n              type: 'clear',\n              source: 'input',\n              count: userMessages.length,\n            });\n          }\n          return userMessages;\n        },\n      },\n      response: {\n        db: () => {\n          const responseMessages = Array.from(this.stateManager.getResponseMessages());\n          this.messages = this.messages.filter(m => !this.stateManager.isResponseMessage(m));\n          this.stateManager.clearResponseMessages();\n          if (this.isRecording && responseMessages.length > 0) {\n            this.recordedEvents.push({\n              type: 'clear',\n              source: 'response',\n              count: responseMessages.length,\n            });\n          }\n          return responseMessages;\n        },\n      },\n    };\n  }\n\n  /**\n   * Remove messages by ID\n   * @param ids - Array of message IDs to remove\n   * @returns Array of removed messages\n   */\n  public removeByIds(ids: string[]): MastraDBMessage[] {\n    const idsSet = new Set(ids);\n    const removed: MastraDBMessage[] = [];\n    this.messages = this.messages.filter(m => {\n      if (idsSet.has(m.id)) {\n        removed.push(m);\n        this.stateManager.removeMessage(m);\n        return false;\n      }\n      return true;\n    });\n    if (this.isRecording && removed.length > 0) {\n      this.recordedEvents.push({\n        type: 'removeByIds',\n        ids,\n        count: removed.length,\n      });\n    }\n    return removed;\n  }\n\n  private all = {\n    db: (): MastraDBMessage[] => this.messages,\n    v1: (): MastraMessageV1[] => convertToV1Messages(this.all.db()),\n\n    aiV5: {\n      model: (): AIV5Type.ModelMessage[] => convertAIV5UIToModelMessages(this.all.aiV5.ui(), this.messages),\n      ui: (): AIV5Type.UIMessage[] => this.all.db().map(AIV5Adapter.toUIMessage),\n\n      // Used when calling AI SDK streamText/generateText\n      prompt: (): AIV5Type.ModelMessage[] => {\n        const systemMessages = convertAIV4CoreToAIV5ModelMessages(\n          [...this.systemMessages, ...Object.values(this.taggedSystemMessages).flat()],\n          `system`,\n          this.createAdapterContext(),\n          this.messages,\n        );\n        // Filter incomplete tool calls when sending messages TO the LLM\n        const modelMessages = convertAIV5UIToModelMessages(this.all.aiV5.ui(), this.messages, true);\n\n        const messages = [...systemMessages, ...modelMessages];\n\n        return ensureGeminiCompatibleMessages(messages);\n      },\n\n      // Used for creating LLM prompt messages without AI SDK streamText/generateText\n      llmPrompt: async (\n        options: {\n          downloadConcurrency?: number;\n          downloadRetries?: number;\n          supportedUrls?: Record<string, RegExp[]>;\n        } = {\n          downloadConcurrency: 10,\n          downloadRetries: 3,\n        },\n      ): Promise<LanguageModelV2Prompt> => {\n        // Filter incomplete tool calls when sending messages TO the LLM\n        const modelMessages = convertAIV5UIToModelMessages(this.all.aiV5.ui(), this.messages, true);\n        const systemMessages = convertAIV4CoreToAIV5ModelMessages(\n          [...this.systemMessages, ...Object.values(this.taggedSystemMessages).flat()],\n          `system`,\n          this.createAdapterContext(),\n          this.messages,\n        );\n\n        const downloadedAssets = await downloadAssetsFromMessages({\n          messages: modelMessages,\n          downloadConcurrency: options?.downloadConcurrency,\n          downloadRetries: options?.downloadRetries,\n          supportedUrls: options?.supportedUrls,\n        });\n\n        let messages = [...systemMessages, ...modelMessages];\n\n        // Check if any messages have image/file content that needs processing\n        const hasImageOrFileContent = modelMessages.some(\n          message =>\n            message.role === 'user' &&\n            typeof message.content !== 'string' &&\n            message.content.some(part => part.type === 'image' || part.type === 'file'),\n        );\n\n        if (hasImageOrFileContent) {\n          messages = messages.map(message => {\n            if (message.role === 'user') {\n              if (typeof message.content === 'string') {\n                return {\n                  role: 'user' as const,\n                  content: [{ type: 'text' as const, text: message.content }],\n                  providerOptions: message.providerOptions,\n                } as AIV5Type.ModelMessage;\n              }\n\n              const convertedContent = message.content\n                .map(part => {\n                  if (part.type === 'image' || part.type === 'file') {\n                    return convertImageFilePart(part, downloadedAssets);\n                  }\n                  return part;\n                })\n                .filter(part => part.type !== 'text' || part.text !== '');\n\n              return {\n                role: 'user' as const,\n                content: convertedContent,\n                providerOptions: message.providerOptions,\n              } as AIV5Type.ModelMessage;\n            }\n\n            return message;\n          });\n        }\n\n        messages = ensureGeminiCompatibleMessages(messages);\n\n        return messages.map(aiV5ModelMessageToV2PromptMessage);\n      },\n    },\n\n    /* @deprecated use list.get.all.aiV4.prompt() instead */\n    prompt: () => this.all.aiV4.prompt(),\n    /* @deprecated use list.get.all.aiV4.ui() */\n    ui: (): UIMessageWithMetadata[] => this.all.db().map(AIV4Adapter.toUIMessage),\n    /* @deprecated use list.get.all.aiV4.core() */\n    core: (): CoreMessageV4[] => aiV4UIMessagesToAIV4CoreMessages(this.all.aiV4.ui()),\n    aiV4: {\n      ui: (): UIMessageWithMetadata[] => this.all.db().map(AIV4Adapter.toUIMessage),\n      core: (): CoreMessageV4[] => aiV4UIMessagesToAIV4CoreMessages(this.all.aiV4.ui()),\n\n      // Used when calling AI SDK streamText/generateText\n      prompt: () => {\n        const coreMessages = this.all.aiV4.core();\n        const messages = [...this.systemMessages, ...Object.values(this.taggedSystemMessages).flat(), ...coreMessages];\n\n        return ensureGeminiCompatibleMessages(messages);\n      },\n\n      // Used for creating LLM prompt messages without AI SDK streamText/generateText\n      llmPrompt: (): LanguageModelV1Prompt => {\n        const coreMessages = this.all.aiV4.core();\n\n        const systemMessages = [...this.systemMessages, ...Object.values(this.taggedSystemMessages).flat()];\n        let messages = [...systemMessages, ...coreMessages];\n\n        messages = ensureGeminiCompatibleMessages(messages);\n\n        return messages.map(aiV4CoreMessageToV1PromptMessage);\n      },\n    },\n  };\n\n  private remembered = {\n    db: () => this.messages.filter(m => this.memoryMessages.has(m)),\n    v1: () => convertToV1Messages(this.remembered.db()),\n\n    aiV5: {\n      model: () => convertAIV5UIToModelMessages(this.remembered.aiV5.ui(), this.messages),\n      ui: (): AIV5Type.UIMessage[] => this.remembered.db().map(AIV5Adapter.toUIMessage),\n    },\n\n    /* @deprecated use list.get.remembered.aiV4.ui() */\n    ui: (): UIMessageWithMetadata[] => this.remembered.db().map(AIV4Adapter.toUIMessage),\n    /* @deprecated use list.get.remembered.aiV4.core() */\n    core: (): CoreMessageV4[] => aiV4UIMessagesToAIV4CoreMessages(this.all.aiV4.ui()),\n    aiV4: {\n      ui: (): UIMessageWithMetadata[] => this.remembered.db().map(AIV4Adapter.toUIMessage),\n      core: (): CoreMessageV4[] => aiV4UIMessagesToAIV4CoreMessages(this.all.aiV4.ui()),\n    },\n  };\n  private rememberedPersisted = {\n    db: () => this.all.db().filter(m => this.memoryMessagesPersisted.has(m)),\n    v1: () => convertToV1Messages(this.rememberedPersisted.db()),\n\n    aiV5: {\n      model: () => convertAIV5UIToModelMessages(this.rememberedPersisted.aiV5.ui(), this.messages),\n      ui: (): AIV5Type.UIMessage[] => this.rememberedPersisted.db().map(AIV5Adapter.toUIMessage),\n    },\n\n    /* @deprecated use list.getPersisted.remembered.aiV4.ui() */\n    ui: () => this.rememberedPersisted.db().map(AIV4Adapter.toUIMessage),\n    /* @deprecated use list.getPersisted.remembered.aiV4.core() */\n    core: () => aiV4UIMessagesToAIV4CoreMessages(this.rememberedPersisted.ui()),\n    aiV4: {\n      ui: (): UIMessageWithMetadata[] => this.rememberedPersisted.db().map(AIV4Adapter.toUIMessage),\n      core: (): CoreMessageV4[] => aiV4UIMessagesToAIV4CoreMessages(this.rememberedPersisted.aiV4.ui()),\n    },\n  };\n\n  private input = {\n    db: () => this.messages.filter(m => this.newUserMessages.has(m)),\n    v1: () => convertToV1Messages(this.input.db()),\n\n    aiV5: {\n      model: () => convertAIV5UIToModelMessages(this.input.aiV5.ui(), this.messages),\n      ui: (): AIV5Type.UIMessage[] => this.input.db().map(AIV5Adapter.toUIMessage),\n    },\n\n    /* @deprecated use list.get.input.aiV4.ui() instead */\n    ui: () => this.input.db().map(AIV4Adapter.toUIMessage),\n    /* @deprecated use list.get.core.aiV4.ui() instead */\n    core: () => aiV4UIMessagesToAIV4CoreMessages(this.input.ui()),\n    aiV4: {\n      ui: (): UIMessageWithMetadata[] => this.input.db().map(AIV4Adapter.toUIMessage),\n      core: (): CoreMessageV4[] => aiV4UIMessagesToAIV4CoreMessages(this.input.aiV4.ui()),\n    },\n  };\n  private inputPersisted = {\n    db: (): MastraDBMessage[] => this.messages.filter(m => this.newUserMessagesPersisted.has(m)),\n    v1: (): MastraMessageV1[] => convertToV1Messages(this.inputPersisted.db()),\n\n    aiV5: {\n      model: () => convertAIV5UIToModelMessages(this.inputPersisted.aiV5.ui(), this.messages),\n      ui: (): AIV5Type.UIMessage[] => this.inputPersisted.db().map(AIV5Adapter.toUIMessage),\n    },\n\n    /* @deprecated use list.getPersisted.input.aiV4.ui() */\n    ui: (): UIMessageWithMetadata[] => this.inputPersisted.db().map(AIV4Adapter.toUIMessage),\n    /* @deprecated use list.getPersisted.input.aiV4.core() */\n    core: () => aiV4UIMessagesToAIV4CoreMessages(this.inputPersisted.ui()),\n    aiV4: {\n      ui: (): UIMessageWithMetadata[] => this.inputPersisted.db().map(AIV4Adapter.toUIMessage),\n      core: (): CoreMessageV4[] => aiV4UIMessagesToAIV4CoreMessages(this.inputPersisted.aiV4.ui()),\n    },\n  };\n\n  private response = {\n    db: (): MastraDBMessage[] => this.messages.filter(m => this.newResponseMessages.has(m)),\n    v1: (): MastraMessageV1[] => convertToV1Messages(this.response.db()),\n\n    aiV5: {\n      ui: (): AIV5Type.UIMessage[] => this.response.db().map(AIV5Adapter.toUIMessage),\n      model: (): AIV5ResponseMessage[] =>\n        convertAIV5UIToModelMessages(this.response.aiV5.ui(), this.messages).filter(\n          m => m.role === `tool` || m.role === `assistant`,\n        ),\n      modelContent: (stepNumber?: number): AIV5Type.StepResult<any>['content'] => {\n        if (typeof stepNumber === 'number') {\n          // Delegate to StepContentExtractor for step-specific content extraction\n          return StepContentExtractor.extractStepContent(\n            this.response.aiV5.ui(),\n            stepNumber,\n            this.response.aiV5.stepContent,\n          );\n        }\n\n        return this.response.aiV5.model().map(this.response.aiV5.stepContent).flat();\n      },\n      stepContent: (message?: AIV5Type.ModelMessage): AIV5Type.StepResult<any>['content'] => {\n        // Delegate to StepContentExtractor for content conversion\n        return StepContentExtractor.convertToStepContent(message, this.messages, () =>\n          this.response.aiV5.model().at(-1),\n        );\n      },\n    },\n\n    aiV4: {\n      ui: (): UIMessageWithMetadata[] => this.response.db().map(AIV4Adapter.toUIMessage),\n      core: (): CoreMessageV4[] => aiV4UIMessagesToAIV4CoreMessages(this.response.aiV4.ui()),\n    },\n  };\n  private responsePersisted = {\n    db: (): MastraDBMessage[] => this.messages.filter(m => this.newResponseMessagesPersisted.has(m)),\n\n    aiV5: {\n      model: () => convertAIV5UIToModelMessages(this.responsePersisted.aiV5.ui(), this.messages),\n      ui: (): AIV5Type.UIMessage[] => this.responsePersisted.db().map(AIV5Adapter.toUIMessage),\n    },\n\n    /* @deprecated use list.getPersisted.response.aiV4.ui() */\n    ui: (): UIMessageWithMetadata[] => this.responsePersisted.db().map(AIV4Adapter.toUIMessage),\n    aiV4: {\n      ui: (): UIMessageWithMetadata[] => this.responsePersisted.db().map(AIV4Adapter.toUIMessage),\n      core: (): CoreMessageV4[] => aiV4UIMessagesToAIV4CoreMessages(this.responsePersisted.aiV4.ui()),\n    },\n  };\n\n  public drainUnsavedMessages(): MastraDBMessage[] {\n    const messages = this.messages.filter(m => this.newUserMessages.has(m) || this.newResponseMessages.has(m));\n    this.newUserMessages.clear();\n    this.newResponseMessages.clear();\n    return messages;\n  }\n\n  public getEarliestUnsavedMessageTimestamp(): number | undefined {\n    const unsavedMessages = this.messages.filter(m => this.newUserMessages.has(m) || this.newResponseMessages.has(m));\n    if (unsavedMessages.length === 0) return undefined;\n    // Find the earliest createdAt among unsaved messages\n    return Math.min(...unsavedMessages.map(m => new Date(m.createdAt).getTime()));\n  }\n\n  /**\n   * Check if a message is a new user or response message that should be saved.\n   * Checks by message ID to handle cases where the message object may be a copy.\n   */\n  public isNewMessage(messageOrId: MastraDBMessage | string): boolean {\n    return this.stateManager.isNewMessage(messageOrId);\n  }\n\n  public getSystemMessages(tag?: string): CoreMessageV4[] {\n    if (tag) {\n      return this.taggedSystemMessages[tag] || [];\n    }\n    return this.systemMessages;\n  }\n\n  /**\n   * Get all system messages (both tagged and untagged)\n   * @returns Array of all system messages\n   */\n  public getAllSystemMessages(): CoreMessageV4[] {\n    return [...this.systemMessages, ...Object.values(this.taggedSystemMessages).flat()];\n  }\n\n  /**\n   * Replace all system messages with new ones\n   * This clears both tagged and untagged system messages and replaces them with the provided array\n   * @param messages - Array of system messages to set\n   */\n  public replaceAllSystemMessages(messages: CoreMessageV4[]): this {\n    // Clear existing system messages\n    this.systemMessages = [];\n    this.taggedSystemMessages = {};\n\n    // Add all new messages as untagged (processors don't need to preserve tags)\n    for (const message of messages) {\n      if (message.role === 'system') {\n        this.systemMessages.push(message);\n      }\n    }\n\n    return this;\n  }\n\n  public addSystem(\n    messages:\n      | CoreMessageV4\n      | CoreMessageV4[]\n      | AIV5Type.ModelMessage\n      | AIV5Type.ModelMessage[]\n      | MastraDBMessage\n      | MastraDBMessage[]\n      | string\n      | string[]\n      | null,\n    tag?: string,\n  ) {\n    if (!messages) return this;\n    for (const message of Array.isArray(messages) ? messages : [messages]) {\n      this.addOneSystem(message, tag);\n    }\n    return this;\n  }\n\n  private addOneSystem(message: CoreMessageV4 | AIV5Type.ModelMessage | MastraDBMessage | string, tag?: string) {\n    const coreMessage = systemMessageToAIV4Core(message);\n\n    if (coreMessage.role !== `system`) {\n      throw new Error(\n        `Expected role \"system\" but saw ${coreMessage.role} for message ${JSON.stringify(coreMessage, null, 2)}`,\n      );\n    }\n\n    if (tag && !this.isDuplicateSystem(coreMessage, tag)) {\n      this.taggedSystemMessages[tag] ||= [];\n      this.taggedSystemMessages[tag].push(coreMessage);\n      if (this.isRecording) {\n        this.recordedEvents.push({\n          type: 'addSystem',\n          tag,\n          message: coreMessage,\n        });\n      }\n    } else if (!tag && !this.isDuplicateSystem(coreMessage)) {\n      this.systemMessages.push(coreMessage);\n      if (this.isRecording) {\n        this.recordedEvents.push({\n          type: 'addSystem',\n          message: coreMessage,\n        });\n      }\n    }\n  }\n\n  private isDuplicateSystem(message: CoreMessageV4, tag?: string) {\n    if (tag) {\n      if (!this.taggedSystemMessages[tag]) return false;\n      return this.taggedSystemMessages[tag].some(\n        m =>\n          CacheKeyGenerator.fromAIV4CoreMessageContent(m.content) ===\n          CacheKeyGenerator.fromAIV4CoreMessageContent(message.content),\n      );\n    }\n    return this.systemMessages.some(\n      m =>\n        CacheKeyGenerator.fromAIV4CoreMessageContent(m.content) ===\n        CacheKeyGenerator.fromAIV4CoreMessageContent(message.content),\n    );\n  }\n\n  private getMessageById(id: string) {\n    return this.messages.find(m => m.id === id);\n  }\n\n  private shouldReplaceMessage(message: MastraDBMessage): { exists: boolean; shouldReplace?: boolean; id?: string } {\n    if (!this.messages.length) return { exists: false };\n\n    if (!(`id` in message) || !message?.id) {\n      return { exists: false };\n    }\n\n    const existingMessage = this.getMessageById(message.id);\n    if (!existingMessage) return { exists: false };\n\n    return {\n      exists: true,\n      shouldReplace: !messagesAreEqual(existingMessage, message),\n      id: existingMessage.id,\n    };\n  }\n\n  private addOne(message: MessageInput, messageSource: MessageSource) {\n    if (\n      (!(`content` in message) ||\n        (!message.content &&\n          // allow empty strings\n          typeof message.content !== 'string')) &&\n      (!(`parts` in message) || !message.parts)\n    ) {\n      throw new MastraError({\n        id: 'INVALID_MESSAGE_CONTENT',\n        domain: ErrorDomain.AGENT,\n        category: ErrorCategory.USER,\n        text: `Message with role \"${message.role}\" must have either a 'content' property (string or array) or a 'parts' property (array) that is not empty, null, or undefined. Received message: ${JSON.stringify(message, null, 2)}`,\n        details: {\n          role: message.role as string,\n          messageSource,\n          hasContent: 'content' in message,\n          hasParts: 'parts' in message,\n        },\n      });\n    }\n\n    if (message.role === `system`) {\n      // In the past system messages were accidentally stored in the db. these should be ignored because memory is not supposed to store system messages.\n      if (messageSource === `memory`) return null;\n\n      // Check if the message is in a supported format for system messages\n      const isSupportedSystemFormat =\n        TypeDetector.isAIV4CoreMessage(message) ||\n        TypeDetector.isAIV5CoreMessage(message) ||\n        TypeDetector.isMastraDBMessage(message);\n\n      if (isSupportedSystemFormat) {\n        return this.addSystem(message);\n      }\n\n      // if we didn't add the message and we didn't ignore this intentionally, then it's a problem!\n      throw new MastraError({\n        id: 'INVALID_SYSTEM_MESSAGE_FORMAT',\n        domain: ErrorDomain.AGENT,\n        category: ErrorCategory.USER,\n        text: `Invalid system message format. System messages must be CoreMessage format with 'role' and 'content' properties. The content should be a string or valid content array.`,\n        details: {\n          messageSource,\n          receivedMessage: JSON.stringify(message, null, 2),\n        },\n      });\n    }\n\n    const messageV2 = convertInputToMastraDBMessage(message, messageSource, this.createAdapterContext());\n\n    const { exists, shouldReplace, id } = this.shouldReplaceMessage(messageV2);\n\n    const latestMessage = this.messages.at(-1);\n\n    if (messageSource === `memory`) {\n      for (const existingMessage of this.messages) {\n        // don't double store any messages\n        if (messagesAreEqual(existingMessage, messageV2)) {\n          return;\n        }\n      }\n    }\n    // If the last message is an assistant message and the new message is also an assistant message, merge them together and update tool calls with results\n    // Use MessageMerger to handle the complex merge logic\n    const isLatestFromMemory = latestMessage ? this.memoryMessages.has(latestMessage) : false;\n    const shouldMerge = MessageMerger.shouldMerge(\n      latestMessage,\n      messageV2,\n      messageSource,\n      isLatestFromMemory,\n      this._agentNetworkAppend,\n    );\n\n    if (shouldMerge && latestMessage) {\n      // Delegate merge logic to MessageMerger\n      MessageMerger.merge(latestMessage, messageV2);\n\n      // If latest message gets appended to, it should be added to the proper source\n      this.pushMessageToSource(latestMessage, messageSource);\n    }\n    // Else the last message and this message are not both assistant messages OR an existing message has been updated and should be replaced. add a new message to the array or update an existing one.\n    else {\n      let existingIndex = -1;\n      if (shouldReplace) {\n        existingIndex = this.messages.findIndex(m => m.id === id);\n      }\n      const existingMessage = existingIndex !== -1 && this.messages[existingIndex];\n\n      if (shouldReplace && existingMessage) {\n        this.messages[existingIndex] = messageV2;\n      } else if (!exists) {\n        this.messages.push(messageV2);\n      }\n\n      this.pushMessageToSource(messageV2, messageSource);\n    }\n\n    // make sure messages are always stored in order of when they were created!\n    this.messages.sort((a, b) => a.createdAt.getTime() - b.createdAt.getTime());\n\n    return this;\n  }\n\n  private pushMessageToSource(messageV2: MastraDBMessage, messageSource: MessageSource) {\n    this.stateManager.addToSource(messageV2, messageSource);\n  }\n\n  private lastCreatedAt?: number;\n  // this makes sure messages added in order will always have a date atleast 1ms apart.\n  private generateCreatedAt(messageSource: MessageSource, start?: unknown): Date {\n    // Normalize timestamp\n    const startDate: Date | undefined =\n      start instanceof Date\n        ? start\n        : typeof start === 'string' || typeof start === 'number'\n          ? new Date(start)\n          : undefined;\n\n    if (startDate && !this.lastCreatedAt) {\n      this.lastCreatedAt = startDate.getTime();\n      return startDate;\n    }\n\n    if (startDate && messageSource === `memory`) {\n      // Preserve user-provided timestamps for memory messages to avoid re-ordering\n      // Messages without timestamps will fall through to get generated incrementing timestamps\n      return startDate;\n    }\n\n    const now = new Date();\n    const nowTime = startDate?.getTime() || now.getTime();\n    // find the latest createdAt in all stored messages\n    const lastTime = this.messages.reduce((p, m) => {\n      if (m.createdAt.getTime() > p) return m.createdAt.getTime();\n      return p;\n    }, this.lastCreatedAt || 0);\n\n    // make sure our new message is created later than the latest known message time\n    // it's expected that messages are added to the list in order if they don't have a createdAt date on them\n    if (nowTime <= lastTime) {\n      const newDate = new Date(lastTime + 1);\n      this.lastCreatedAt = newDate.getTime();\n      return newDate;\n    }\n\n    this.lastCreatedAt = nowTime;\n    return now;\n  }\n\n  private newMessageId(role?: string): string {\n    if (this.generateMessageId) {\n      return this.generateMessageId({\n        idType: 'message',\n        source: 'agent',\n        threadId: this.memoryInfo?.threadId,\n        resourceId: this.memoryInfo?.resourceId,\n        role,\n      });\n    }\n    return randomUUID();\n  }\n\n  private createAdapterContext() {\n    return {\n      memoryInfo: this.memoryInfo,\n      newMessageId: () => this.newMessageId(),\n      generateCreatedAt: (messageSource: MessageSource, start?: unknown) =>\n        this.generateCreatedAt(messageSource, start),\n      dbMessages: this.messages,\n    };\n  }\n}\n","import type * as AIV4 from '@internal/ai-sdk-v4';\nimport type * as AIV5 from '@internal/ai-sdk-v5';\n\nimport type { MastraDBMessage, UIMessageWithMetadata, MessageListInput } from '../index';\n\nimport { MessageList } from '../index';\n\n/**\n * Available output formats for message conversion.\n *\n * @remarks\n * - `Mastra.V2` - Current database storage format, compatible with AI SDK v4\n * - `AIV4.UI` - AI SDK v4 UIMessage format (for frontend components)\n * - `AIV4.Core` - AI SDK v4 CoreMessage format (for LLM API calls)\n * - `AIV5.UI` - AI SDK v5 UIMessage format (for frontend components)\n * - `AIV5.Model` - AI SDK v5 ModelMessage format (for LLM API calls)\n */\nexport type OutputFormat = 'Mastra.V2' | 'AIV4.UI' | 'AIV4.Core' | 'AIV5.UI' | 'AIV5.Model';\n\nclass MessageConverter {\n  private messageList: MessageList;\n\n  constructor(messages: MessageListInput) {\n    this.messageList = new MessageList();\n    // Use 'memory' source to preserve messages exactly as provided\n    // without any transformations or combinations\n    this.messageList.add(messages, 'memory');\n  }\n\n  /**\n   * Convert messages to Mastra V2 format (current database format).\n   * @param format - The format 'Mastra.V2'\n   * @returns Array of messages in Mastra V2 format, used for database storage\n   */\n  to(format: 'Mastra.V2'): MastraDBMessage[];\n  /**\n   * Convert messages to AI SDK v4 UIMessage format.\n   * @param format - The format 'AIV4.UI'\n   * @returns Array of UIMessages for use with AI SDK v4 frontend components\n   */\n  to(format: 'AIV4.UI'): UIMessageWithMetadata[] | AIV4.UIMessage[];\n  /**\n   * Convert messages to AI SDK v4 CoreMessage format.\n   * @param format - The format 'AIV4.Core'\n   * @returns Array of CoreMessages for AI SDK v4 LLM API calls\n   */\n  to(format: 'AIV4.Core'): AIV4.CoreMessage[];\n  /**\n   * Convert messages to AI SDK v5 UIMessage format.\n   * @param format - The format 'AIV5.UI'\n   * @returns Array of UIMessages for use with AI SDK v5 frontend components\n   */\n  to(format: 'AIV5.UI'): AIV5.UIMessage[];\n  /**\n   * Convert messages to AI SDK v5 ModelMessage format.\n   * @param format - The format 'AIV5.Model'\n   * @returns Array of ModelMessages for AI SDK v5 LLM API calls\n   */\n  to(format: 'AIV5.Model'): AIV5.ModelMessage[];\n  to(format: OutputFormat): unknown[] {\n    switch (format) {\n      // Old format keys (backward compatibility)\n      case 'Mastra.V2':\n        return this.messageList.get.all.db();\n      case 'AIV4.UI':\n        return this.messageList.get.all.aiV4.ui();\n      case 'AIV4.Core':\n        return this.messageList.get.all.aiV4.core();\n      case 'AIV5.UI':\n        return this.messageList.get.all.aiV5.ui();\n      case 'AIV5.Model':\n        return this.messageList.get.all.aiV5.model();\n      default:\n        throw new Error(`Unsupported output format: ${format}`);\n    }\n  }\n}\n\n/**\n * Convert messages from any supported format to another format.\n *\n * @param messages - Input messages in any supported format. Accepts:\n *   - AI SDK v4 formats: UIMessage, CoreMessage, Message\n *   - AI SDK v5 formats: UIMessage, ModelMessage\n *   - Mastra formats: MastraMessageV1 (input only), MastraDBMessage\n *   - Simple strings (will be converted to user messages)\n *   - Arrays of any of the above\n *\n * @returns A converter object with a `.to()` method to specify the output format\n *\n * @example\n * ```typescript\n * import { convertMessages } from '@mastra/core/agent';\n *\n * // Convert AI SDK v5 UI messages to v4 Core messages\n * const v4CoreMessages = convertMessages(v5UIMessages).to('AIV4.Core');\n *\n * // Convert database messages (Mastra V2) to AI SDK v5 UI messages for frontend\n * const v5UIMessages = convertMessages(dbMessages).to('AIV5.UI');\n *\n * // Convert any format to Mastra's V2 format for database storage\n * const mastraV2Messages = convertMessages(anyMessages).to('Mastra.V2');\n *\n * // Convert simple strings to formatted messages\n * const messages = convertMessages(['Hello', 'How are you?']).to('AIV5.UI');\n *\n * // Convert v4 UI messages to v5 Model messages for LLM calls\n * const modelMessages = convertMessages(v4UIMessages).to('AIV5.Model');\n * ```\n *\n * @remarks\n * This utility handles all message format conversions internally, including:\n * - Tool invocations and results\n * - File attachments\n * - Multi-part messages\n * - System messages\n * - Metadata preservation where possible\n */\nexport function convertMessages(messages: MessageListInput): MessageConverter {\n  return new MessageConverter(messages);\n}\n"],"names":["uiMessage","toolResultPart","matchingCall","convertUint8ArrayToBase64","stepParts","convertBase64ToUint8Array","processBlock","content","toolInvocations","i","randomUUID"],"mappings":"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"}}]
}