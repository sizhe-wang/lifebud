"use strict";var M=Object.defineProperty,W=Object.defineProperties,X=Object.getOwnPropertyDescriptor,z=Object.getOwnPropertyDescriptors,Q=Object.getOwnPropertyNames,v=Object.getOwnPropertySymbols;var O=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable;var k=(e,r)=>(r=Symbol[e])?r:Symbol.for("Symbol."+e);var q=(e,r,t)=>r in e?M(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,x=(e,r)=>{for(var t in r||(r={}))O.call(r,t)&&q(e,t,r[t]);if(v)for(var t of v(r))G.call(r,t)&&q(e,t,r[t]);return e},E=(e,r)=>W(e,z(r));var S=(e,r)=>{var t={};for(var a in e)O.call(e,a)&&r.indexOf(a)<0&&(t[a]=e[a]);if(e!=null&&v)for(var a of v(e))r.indexOf(a)<0&&G.call(e,a)&&(t[a]=e[a]);return t};var V=(e,r)=>{for(var t in r)M(e,t,{get:r[t],enumerable:!0})},Y=(e,r,t,a)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of Q(r))!O.call(e,o)&&o!==t&&M(e,o,{get:()=>r[o],enumerable:!(a=X(r,o))||a.enumerable});return e};var Z=e=>Y(M({},"__esModule",{value:!0}),e);var T=(e,r,t)=>(r=e[k("asyncIterator")])?r.call(e):(e=e[k("iterator")](),r={},t=(a,o)=>(o=e[a])&&(r[a]=n=>new Promise((c,l,p)=>(n=o.call(e,n),p=n.done,Promise.resolve(n.value).then(d=>c({value:d,done:p}),l)))),t("next"),t("return"),r);var P={};V(P,{registerCopilotKit:()=>F});module.exports=Z(P);var I=require("@copilotkit/runtime"),$=require("@mastra/core/request-context"),K=require("@mastra/core/server");var A=require("@ag-ui/client"),B=require("@mastra/core/request-context"),L=require("@ag-ui/client"),H=require("rxjs");var b=e=>e?typeof e=="string"?e:Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text.trim()).filter(Boolean).join(`
`):"":"";function _(e){var t,a;let r=[];for(let o of e)if(o.role==="assistant"){let n=b(o.content),c=[];n&&c.push({type:"text",text:n});for(let l of(t=o.toolCalls)!=null?t:[])c.push({type:"tool-call",toolCallId:l.id,toolName:l.function.name,args:JSON.parse(l.function.arguments)});r.push({role:"assistant",content:c})}else if(o.role==="user"){let n=b(o.content);r.push({role:"user",content:n})}else if(o.role==="tool"){let n="unknown";for(let c of e)if(c.role==="assistant"){for(let l of(a=c.toolCalls)!=null?a:[])if(l.id===o.toolCallId){n=l.function.name;break}}r.push({role:"tool",content:[{type:"tool-result",toolCallId:o.toolCallId,toolName:n,result:o.content}]})}return r}async function U({mastraClient:e,resourceId:r}){let t=await e.listAgents();return Object.entries(t).reduce((a,[o])=>{let n=e.getAgent(o);return a[o]=new y({agentId:o,agent:n,resourceId:r}),a},{})}function D({mastra:e,resourceId:r,requestContext:t}){let a=e.listAgents()||{};return Object.entries(a).reduce((n,[c,l])=>(n[c]=new y({agentId:c,agent:l,resourceId:r,requestContext:t}),n),{})}function j({mastra:e,agentId:r,resourceId:t,requestContext:a}){let o=e.getAgent(r);if(!o)throw new Error(`Agent ${r} not found`);return new y({agentId:r,agent:o,resourceId:t,requestContext:a})}function J({mastra:e,networkId:r,resourceId:t,requestContext:a}){let o=e.getAgent(r);if(!o)throw new Error(`Network ${r} not found`);return new y({agentId:o.name,agent:o,resourceId:t,requestContext:a})}var y=class e extends A.AbstractAgent{constructor(t){let l=t,{agent:a,resourceId:o,requestContext:n}=l,c=S(l,["agent","resourceId","requestContext"]);super(c);this.config=t;this.agent=a,this.resourceId=o,this.requestContext=n!=null?n:new B.RequestContext}clone(){return new e(this.config)}run(t){let a=(0,L.randomUUID)();return new H.Observable(o=>((async()=>{var l,p,d;let c={type:A.EventType.RUN_STARTED,threadId:t.threadId,runId:t.runId};if(o.next(c),this.isLocalMastraAgent(this.agent)){let s=await this.agent.getMemory({requestContext:this.requestContext});if(s&&t.state&&Object.keys(t.state||{}).length>0){let i=await s.getThreadById({threadId:t.threadId});i||(i={id:t.threadId,title:"",metadata:{},resourceId:(l=this.resourceId)!=null?l:t.threadId,createdAt:new Date,updatedAt:new Date});let f=JSON.parse((d=(p=i.metadata)==null?void 0:p.workingMemory)!=null?d:"{}"),u=t.state,{messages:C}=u,w=S(u,["messages"]),h=JSON.stringify(x(x({},f),w));await s.saveThread({thread:E(x({},i),{metadata:E(x({},i.metadata),{workingMemory:h})})})}}try{await this.streamMastraAgent(t,{onTextPart:s=>{let i={type:A.EventType.TEXT_MESSAGE_CHUNK,role:"assistant",messageId:a,delta:s};o.next(i)},onToolCallPart:s=>{let i={type:A.EventType.TOOL_CALL_START,parentMessageId:a,toolCallId:s.toolCallId,toolCallName:s.toolName};o.next(i);let f={type:A.EventType.TOOL_CALL_ARGS,toolCallId:s.toolCallId,delta:JSON.stringify(s.args)};o.next(f);let C={type:A.EventType.TOOL_CALL_END,toolCallId:s.toolCallId};o.next(C)},onToolResultPart(s){let i={type:A.EventType.TOOL_CALL_RESULT,toolCallId:s.toolCallId,content:JSON.stringify(s.result),messageId:(0,L.randomUUID)(),role:"tool"};o.next(i)},onFinishMessagePart:async()=>{a=(0,L.randomUUID)()},onError:s=>{console.error("error",s),o.error(s)},onRunFinished:async()=>{if(this.isLocalMastraAgent(this.agent))try{let s=await this.agent.getMemory({requestContext:this.requestContext});if(s){let i=await s.getWorkingMemory({resourceId:this.resourceId,threadId:t.threadId,memoryConfig:{workingMemory:{enabled:!0}}});if(typeof i=="string"){let f=JSON.parse(i);if(f&&!("$schema"in f)){let C={type:A.EventType.STATE_SNAPSHOT,snapshot:f};o.next(C)}}}}catch(s){console.error("Error sending state snapshot",s)}o.next({type:A.EventType.RUN_FINISHED,threadId:t.threadId,runId:t.runId}),o.complete()}})}catch(s){console.error("Stream error:",s),o.error(s)}})(),()=>{}))}isLocalMastraAgent(t){return"getMemory"in t}async streamMastraAgent({threadId:t,runId:a,messages:o,tools:n,context:c},{onTextPart:l,onFinishMessagePart:p,onToolCallPart:d,onToolResultPart:u,onError:s,onRunFinished:i}){var R,N;let f=n.reduce((m,g)=>(m[g.name]={id:g.name,description:g.description,inputSchema:g.parameters},m),{}),C=(R=this.resourceId)!=null?R:t,w=_(o);(N=this.requestContext)==null||N.set("ag-ui",{context:c});let h=this.requestContext;if(this.isLocalMastraAgent(this.agent))try{let m=await this.agent.stream(w,{memory:{thread:t,resource:C},runId:a,clientTools:f,requestContext:h});if(m&&typeof m=="object"){try{for(var mt=T(m.fullStream),dt,At,ut;dt=!(At=await mt.next()).done;dt=!1){let g=At.value;switch(g.type){case"text-delta":{l==null||l(g.payload.text);break}case"tool-call":{d==null||d({toolCallId:g.payload.toolCallId,toolName:g.payload.toolName,args:g.payload.args});break}case"tool-result":{u==null||u({toolCallId:g.payload.toolCallId,result:g.payload.result});break}case"error":{s==null||s(new Error(g.payload.error));break}case"finish":{p==null||p();break}}}}catch(At){ut=[At]}finally{try{dt&&(At=mt.return)&&await At.call(mt)}finally{if(ut)throw ut[0]}}await(i==null?void 0:i())}else throw new Error("Invalid response from local agent")}catch(m){s==null||s(m)}else try{let m=await this.agent.stream({memory:{thread:t,resource:C},runId:a,messages:w,clientTools:f,requestContext:h});if(m&&typeof m.processDataStream=="function")await m.processDataStream({onChunk:async g=>{switch(g.type){case"text-delta":{l==null||l(g.payload.text);break}case"tool-call":{d==null||d({toolCallId:g.payload.toolCallId,toolName:g.payload.toolName,args:g.payload.args});break}case"tool-result":{u==null||u({toolCallId:g.payload.toolCallId,result:g.payload.result});break}case"finish":{p==null||p();break}}}}),await(i==null?void 0:i());else throw new Error("Invalid response from remote agent")}catch(m){s==null||s(m)}}static async getRemoteAgents(t){return U(t)}static getLocalAgents(t){return D(t)}static getLocalAgent(t){return j(t)}static getNetwork(t){return J(t)}};function F({path:e,resourceId:r,serviceAdapter:t=new I.ExperimentalEmptyAdapter,agents:a,setContext:o}){return(0,K.registerApiRoute)(e,{method:"ALL",handler:async n=>{let c=n.get("mastra"),l=new $.RequestContext;o&&await o(n,l);let p=a||y.getLocalAgents({resourceId:r,mastra:c,requestContext:l}),d=new I.CopilotRuntime({agents:Promise.resolve(p)});return(0,I.copilotRuntimeNodeHttpEndpoint)({endpoint:e,runtime:d,serviceAdapter:t}).handle(n.req.raw,{})}})}0&&(module.exports={registerCopilotKit});
//# sourceMappingURL=copilotkit.js.map