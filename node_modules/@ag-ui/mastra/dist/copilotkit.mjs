var j=Object.defineProperty,J=Object.defineProperties;var B=Object.getOwnPropertyDescriptors;var h=Object.getOwnPropertySymbols;var N=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable;var S=(e,r)=>(r=Symbol[e])?r:Symbol.for("Symbol."+e);var R=(e,r,t)=>r in e?j(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,I=(e,r)=>{for(var t in r||(r={}))N.call(r,t)&&R(e,t,r[t]);if(h)for(var t of h(r))k.call(r,t)&&R(e,t,r[t]);return e},v=(e,r)=>J(e,B(r));var M=(e,r)=>{var t={};for(var a in e)N.call(e,a)&&r.indexOf(a)<0&&(t[a]=e[a]);if(e!=null&&h)for(var a of h(e))r.indexOf(a)<0&&k.call(e,a)&&(t[a]=e[a]);return t};var q=(e,r,t)=>(r=e[S("asyncIterator")])?r.call(e):(e=e[S("iterator")](),r={},t=(a,o)=>(o=e[a])&&(r[a]=n=>new Promise((c,l,p)=>(n=o.call(e,n),p=n.done,Promise.resolve(n.value).then(d=>c({value:d,done:p}),l)))),t("next"),t("return"),r);import{CopilotRuntime as W,copilotRuntimeNodeHttpEndpoint as X,ExperimentalEmptyAdapter as z}from"@copilotkit/runtime";import{RequestContext as Q}from"@mastra/core/request-context";import{registerApiRoute as V}from"@mastra/core/server";import{AbstractAgent as H,EventType as y}from"@ag-ui/client";import{RequestContext as $}from"@mastra/core/request-context";import{randomUUID as L}from"@ag-ui/client";import{Observable as K}from"rxjs";var G=e=>e?typeof e=="string"?e:Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text.trim()).filter(Boolean).join(`
`):"":"";function T(e){var t,a;let r=[];for(let o of e)if(o.role==="assistant"){let n=G(o.content),c=[];n&&c.push({type:"text",text:n});for(let l of(t=o.toolCalls)!=null?t:[])c.push({type:"tool-call",toolCallId:l.id,toolName:l.function.name,args:JSON.parse(l.function.arguments)});r.push({role:"assistant",content:c})}else if(o.role==="user"){let n=G(o.content);r.push({role:"user",content:n})}else if(o.role==="tool"){let n="unknown";for(let c of e)if(c.role==="assistant"){for(let l of(a=c.toolCalls)!=null?a:[])if(l.id===o.toolCallId){n=l.function.name;break}}r.push({role:"tool",content:[{type:"tool-result",toolCallId:o.toolCallId,toolName:n,result:o.content}]})}return r}async function b({mastraClient:e,resourceId:r}){let t=await e.listAgents();return Object.entries(t).reduce((a,[o])=>{let n=e.getAgent(o);return a[o]=new f({agentId:o,agent:n,resourceId:r}),a},{})}function _({mastra:e,resourceId:r,requestContext:t}){let a=e.listAgents()||{};return Object.entries(a).reduce((n,[c,l])=>(n[c]=new f({agentId:c,agent:l,resourceId:r,requestContext:t}),n),{})}function U({mastra:e,agentId:r,resourceId:t,requestContext:a}){let o=e.getAgent(r);if(!o)throw new Error(`Agent ${r} not found`);return new f({agentId:r,agent:o,resourceId:t,requestContext:a})}function D({mastra:e,networkId:r,resourceId:t,requestContext:a}){let o=e.getAgent(r);if(!o)throw new Error(`Network ${r} not found`);return new f({agentId:o.name,agent:o,resourceId:t,requestContext:a})}var f=class e extends H{constructor(t){let l=t,{agent:a,resourceId:o,requestContext:n}=l,c=M(l,["agent","resourceId","requestContext"]);super(c);this.config=t;this.agent=a,this.resourceId=o,this.requestContext=n!=null?n:new $}clone(){return new e(this.config)}run(t){let a=L();return new K(o=>((async()=>{var l,p,d;let c={type:y.RUN_STARTED,threadId:t.threadId,runId:t.runId};if(o.next(c),this.isLocalMastraAgent(this.agent)){let s=await this.agent.getMemory({requestContext:this.requestContext});if(s&&t.state&&Object.keys(t.state||{}).length>0){let i=await s.getThreadById({threadId:t.threadId});i||(i={id:t.threadId,title:"",metadata:{},resourceId:(l=this.resourceId)!=null?l:t.threadId,createdAt:new Date,updatedAt:new Date});let u=JSON.parse((d=(p=i.metadata)==null?void 0:p.workingMemory)!=null?d:"{}"),A=t.state,{messages:C}=A,x=M(A,["messages"]),w=JSON.stringify(I(I({},u),x));await s.saveThread({thread:v(I({},i),{metadata:v(I({},i.metadata),{workingMemory:w})})})}}try{await this.streamMastraAgent(t,{onTextPart:s=>{let i={type:y.TEXT_MESSAGE_CHUNK,role:"assistant",messageId:a,delta:s};o.next(i)},onToolCallPart:s=>{let i={type:y.TOOL_CALL_START,parentMessageId:a,toolCallId:s.toolCallId,toolCallName:s.toolName};o.next(i);let u={type:y.TOOL_CALL_ARGS,toolCallId:s.toolCallId,delta:JSON.stringify(s.args)};o.next(u);let C={type:y.TOOL_CALL_END,toolCallId:s.toolCallId};o.next(C)},onToolResultPart(s){let i={type:y.TOOL_CALL_RESULT,toolCallId:s.toolCallId,content:JSON.stringify(s.result),messageId:L(),role:"tool"};o.next(i)},onFinishMessagePart:async()=>{a=L()},onError:s=>{console.error("error",s),o.error(s)},onRunFinished:async()=>{if(this.isLocalMastraAgent(this.agent))try{let s=await this.agent.getMemory({requestContext:this.requestContext});if(s){let i=await s.getWorkingMemory({resourceId:this.resourceId,threadId:t.threadId,memoryConfig:{workingMemory:{enabled:!0}}});if(typeof i=="string"){let u=JSON.parse(i);if(u&&!("$schema"in u)){let C={type:y.STATE_SNAPSHOT,snapshot:u};o.next(C)}}}}catch(s){console.error("Error sending state snapshot",s)}o.next({type:y.RUN_FINISHED,threadId:t.threadId,runId:t.runId}),o.complete()}})}catch(s){console.error("Stream error:",s),o.error(s)}})(),()=>{}))}isLocalMastraAgent(t){return"getMemory"in t}async streamMastraAgent({threadId:t,runId:a,messages:o,tools:n,context:c},{onTextPart:l,onFinishMessagePart:p,onToolCallPart:d,onToolResultPart:A,onError:s,onRunFinished:i}){var O,E;let u=n.reduce((m,g)=>(m[g.name]={id:g.name,description:g.description,inputSchema:g.parameters},m),{}),C=(O=this.resourceId)!=null?O:t,x=T(o);(E=this.requestContext)==null||E.set("ag-ui",{context:c});let w=this.requestContext;if(this.isLocalMastraAgent(this.agent))try{let m=await this.agent.stream(x,{memory:{thread:t,resource:C},runId:a,clientTools:u,requestContext:w});if(m&&typeof m=="object"){try{for(var yt=q(m.fullStream),Ct,It,xt;Ct=!(It=await yt.next()).done;Ct=!1){let g=It.value;switch(g.type){case"text-delta":{l==null||l(g.payload.text);break}case"tool-call":{d==null||d({toolCallId:g.payload.toolCallId,toolName:g.payload.toolName,args:g.payload.args});break}case"tool-result":{A==null||A({toolCallId:g.payload.toolCallId,result:g.payload.result});break}case"error":{s==null||s(new Error(g.payload.error));break}case"finish":{p==null||p();break}}}}catch(It){xt=[It]}finally{try{Ct&&(It=yt.return)&&await It.call(yt)}finally{if(xt)throw xt[0]}}await(i==null?void 0:i())}else throw new Error("Invalid response from local agent")}catch(m){s==null||s(m)}else try{let m=await this.agent.stream({memory:{thread:t,resource:C},runId:a,messages:x,clientTools:u,requestContext:w});if(m&&typeof m.processDataStream=="function")await m.processDataStream({onChunk:async g=>{switch(g.type){case"text-delta":{l==null||l(g.payload.text);break}case"tool-call":{d==null||d({toolCallId:g.payload.toolCallId,toolName:g.payload.toolName,args:g.payload.args});break}case"tool-result":{A==null||A({toolCallId:g.payload.toolCallId,result:g.payload.result});break}case"finish":{p==null||p();break}}}}),await(i==null?void 0:i());else throw new Error("Invalid response from remote agent")}catch(m){s==null||s(m)}}static async getRemoteAgents(t){return b(t)}static getLocalAgents(t){return _(t)}static getLocalAgent(t){return U(t)}static getNetwork(t){return D(t)}};function ut({path:e,resourceId:r,serviceAdapter:t=new z,agents:a,setContext:o}){return V(e,{method:"ALL",handler:async n=>{let c=n.get("mastra"),l=new Q;o&&await o(n,l);let p=a||f.getLocalAgents({resourceId:r,mastra:c,requestContext:l}),d=new W({agents:Promise.resolve(p)});return X({endpoint:e,runtime:d,serviceAdapter:t}).handle(n.req.raw,{})}})}export{ut as registerCopilotKit};
//# sourceMappingURL=copilotkit.mjs.map