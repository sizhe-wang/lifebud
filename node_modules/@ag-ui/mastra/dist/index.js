"use strict";var M=Object.defineProperty,H=Object.defineProperties,$=Object.getOwnPropertyDescriptor,K=Object.getOwnPropertyDescriptors,W=Object.getOwnPropertyNames,w=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var _=(e,r)=>(r=Symbol[e])?r:Symbol.for("Symbol."+e);var b=(e,r,t)=>r in e?M(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,I=(e,r)=>{for(var t in r||(r={}))L.call(r,t)&&b(e,t,r[t]);if(w)for(var t of w(r))U.call(r,t)&&b(e,t,r[t]);return e},O=(e,r)=>H(e,K(r));var S=(e,r)=>{var t={};for(var o in e)L.call(e,o)&&r.indexOf(o)<0&&(t[o]=e[o]);if(e!=null&&w)for(var o of w(e))r.indexOf(o)<0&&U.call(e,o)&&(t[o]=e[o]);return t};var X=(e,r)=>{for(var t in r)M(e,t,{get:r[t],enumerable:!0})},z=(e,r,t,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let a of W(r))!L.call(e,a)&&a!==t&&M(e,a,{get:()=>r[a],enumerable:!(o=$(r,a))||o.enumerable});return e};var Q=e=>z(M({},"__esModule",{value:!0}),e);var D=(e,r,t)=>(r=e[_("asyncIterator")])?r.call(e):(e=e[_("iterator")](),r={},t=(o,a)=>(a=e[o])&&(r[o]=n=>new Promise((c,l,p)=>(n=a.call(e,n),p=n.done,Promise.resolve(n.value).then(d=>c({value:d,done:p}),l)))),t("next"),t("return"),r);var V={};X(V,{MastraAgent:()=>y,convertAGUIMessagesToMastra:()=>E,getLocalAgent:()=>k,getLocalAgents:()=>R,getNetwork:()=>G,getRemoteAgents:()=>N});module.exports=Q(V);var A=require("@ag-ui/client"),J=require("@mastra/core/request-context"),v=require("@ag-ui/client"),B=require("rxjs");var j=e=>e?typeof e=="string"?e:Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text.trim()).filter(Boolean).join(`
`):"":"";function E(e){var t,o;let r=[];for(let a of e)if(a.role==="assistant"){let n=j(a.content),c=[];n&&c.push({type:"text",text:n});for(let l of(t=a.toolCalls)!=null?t:[])c.push({type:"tool-call",toolCallId:l.id,toolName:l.function.name,args:JSON.parse(l.function.arguments)});r.push({role:"assistant",content:c})}else if(a.role==="user"){let n=j(a.content);r.push({role:"user",content:n})}else if(a.role==="tool"){let n="unknown";for(let c of e)if(c.role==="assistant"){for(let l of(o=c.toolCalls)!=null?o:[])if(l.id===a.toolCallId){n=l.function.name;break}}r.push({role:"tool",content:[{type:"tool-result",toolCallId:a.toolCallId,toolName:n,result:a.content}]})}return r}async function N({mastraClient:e,resourceId:r}){let t=await e.listAgents();return Object.entries(t).reduce((o,[a])=>{let n=e.getAgent(a);return o[a]=new y({agentId:a,agent:n,resourceId:r}),o},{})}function R({mastra:e,resourceId:r,requestContext:t}){let o=e.listAgents()||{};return Object.entries(o).reduce((n,[c,l])=>(n[c]=new y({agentId:c,agent:l,resourceId:r,requestContext:t}),n),{})}function k({mastra:e,agentId:r,resourceId:t,requestContext:o}){let a=e.getAgent(r);if(!a)throw new Error(`Agent ${r} not found`);return new y({agentId:r,agent:a,resourceId:t,requestContext:o})}function G({mastra:e,networkId:r,resourceId:t,requestContext:o}){let a=e.getAgent(r);if(!a)throw new Error(`Network ${r} not found`);return new y({agentId:a.name,agent:a,resourceId:t,requestContext:o})}var y=class e extends A.AbstractAgent{constructor(t){let l=t,{agent:o,resourceId:a,requestContext:n}=l,c=S(l,["agent","resourceId","requestContext"]);super(c);this.config=t;this.agent=o,this.resourceId=a,this.requestContext=n!=null?n:new J.RequestContext}clone(){return new e(this.config)}run(t){let o=(0,v.randomUUID)();return new B.Observable(a=>((async()=>{var l,p,d;let c={type:A.EventType.RUN_STARTED,threadId:t.threadId,runId:t.runId};if(a.next(c),this.isLocalMastraAgent(this.agent)){let s=await this.agent.getMemory({requestContext:this.requestContext});if(s&&t.state&&Object.keys(t.state||{}).length>0){let i=await s.getThreadById({threadId:t.threadId});i||(i={id:t.threadId,title:"",metadata:{},resourceId:(l=this.resourceId)!=null?l:t.threadId,createdAt:new Date,updatedAt:new Date});let u=JSON.parse((d=(p=i.metadata)==null?void 0:p.workingMemory)!=null?d:"{}"),f=t.state,{messages:C}=f,x=S(f,["messages"]),h=JSON.stringify(I(I({},u),x));await s.saveThread({thread:O(I({},i),{metadata:O(I({},i.metadata),{workingMemory:h})})})}}try{await this.streamMastraAgent(t,{onTextPart:s=>{let i={type:A.EventType.TEXT_MESSAGE_CHUNK,role:"assistant",messageId:o,delta:s};a.next(i)},onToolCallPart:s=>{let i={type:A.EventType.TOOL_CALL_START,parentMessageId:o,toolCallId:s.toolCallId,toolCallName:s.toolName};a.next(i);let u={type:A.EventType.TOOL_CALL_ARGS,toolCallId:s.toolCallId,delta:JSON.stringify(s.args)};a.next(u);let C={type:A.EventType.TOOL_CALL_END,toolCallId:s.toolCallId};a.next(C)},onToolResultPart(s){let i={type:A.EventType.TOOL_CALL_RESULT,toolCallId:s.toolCallId,content:JSON.stringify(s.result),messageId:(0,v.randomUUID)(),role:"tool"};a.next(i)},onFinishMessagePart:async()=>{o=(0,v.randomUUID)()},onError:s=>{console.error("error",s),a.error(s)},onRunFinished:async()=>{if(this.isLocalMastraAgent(this.agent))try{let s=await this.agent.getMemory({requestContext:this.requestContext});if(s){let i=await s.getWorkingMemory({resourceId:this.resourceId,threadId:t.threadId,memoryConfig:{workingMemory:{enabled:!0}}});if(typeof i=="string"){let u=JSON.parse(i);if(u&&!("$schema"in u)){let C={type:A.EventType.STATE_SNAPSHOT,snapshot:u};a.next(C)}}}}catch(s){console.error("Error sending state snapshot",s)}a.next({type:A.EventType.RUN_FINISHED,threadId:t.threadId,runId:t.runId}),a.complete()}})}catch(s){console.error("Stream error:",s),a.error(s)}})(),()=>{}))}isLocalMastraAgent(t){return"getMemory"in t}async streamMastraAgent({threadId:t,runId:o,messages:a,tools:n,context:c},{onTextPart:l,onFinishMessagePart:p,onToolCallPart:d,onToolResultPart:f,onError:s,onRunFinished:i}){var q,T;let u=n.reduce((m,g)=>(m[g.name]={id:g.name,description:g.description,inputSchema:g.parameters},m),{}),C=(q=this.resourceId)!=null?q:t,x=E(a);(T=this.requestContext)==null||T.set("ag-ui",{context:c});let h=this.requestContext;if(this.isLocalMastraAgent(this.agent))try{let m=await this.agent.stream(x,{memory:{thread:t,resource:C},runId:o,clientTools:u,requestContext:h});if(m&&typeof m=="object"){try{for(var it=D(m.fullStream),gt,ct,mt;gt=!(ct=await it.next()).done;gt=!1){let g=ct.value;switch(g.type){case"text-delta":{l==null||l(g.payload.text);break}case"tool-call":{d==null||d({toolCallId:g.payload.toolCallId,toolName:g.payload.toolName,args:g.payload.args});break}case"tool-result":{f==null||f({toolCallId:g.payload.toolCallId,result:g.payload.result});break}case"error":{s==null||s(new Error(g.payload.error));break}case"finish":{p==null||p();break}}}}catch(ct){mt=[ct]}finally{try{gt&&(ct=it.return)&&await ct.call(it)}finally{if(mt)throw mt[0]}}await(i==null?void 0:i())}else throw new Error("Invalid response from local agent")}catch(m){s==null||s(m)}else try{let m=await this.agent.stream({memory:{thread:t,resource:C},runId:o,messages:x,clientTools:u,requestContext:h});if(m&&typeof m.processDataStream=="function")await m.processDataStream({onChunk:async g=>{switch(g.type){case"text-delta":{l==null||l(g.payload.text);break}case"tool-call":{d==null||d({toolCallId:g.payload.toolCallId,toolName:g.payload.toolName,args:g.payload.args});break}case"tool-result":{f==null||f({toolCallId:g.payload.toolCallId,result:g.payload.result});break}case"finish":{p==null||p();break}}}}),await(i==null?void 0:i());else throw new Error("Invalid response from remote agent")}catch(m){s==null||s(m)}}static async getRemoteAgents(t){return N(t)}static getLocalAgents(t){return R(t)}static getLocalAgent(t){return k(t)}static getNetwork(t){return G(t)}};0&&(module.exports={MastraAgent,convertAGUIMessagesToMastra,getLocalAgent,getLocalAgents,getNetwork,getRemoteAgents});
//# sourceMappingURL=index.js.map