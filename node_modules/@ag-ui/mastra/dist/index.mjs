var j=Object.defineProperty,J=Object.defineProperties;var B=Object.getOwnPropertyDescriptors;var w=Object.getOwnPropertySymbols;var R=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable;var E=(e,r)=>(r=Symbol[e])?r:Symbol.for("Symbol."+e);var N=(e,r,t)=>r in e?j(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,I=(e,r)=>{for(var t in r||(r={}))R.call(r,t)&&N(e,t,r[t]);if(w)for(var t of w(r))k.call(r,t)&&N(e,t,r[t]);return e},M=(e,r)=>J(e,B(r));var v=(e,r)=>{var t={};for(var s in e)R.call(e,s)&&r.indexOf(s)<0&&(t[s]=e[s]);if(e!=null&&w)for(var s of w(e))r.indexOf(s)<0&&k.call(e,s)&&(t[s]=e[s]);return t};var G=(e,r,t)=>(r=e[E("asyncIterator")])?r.call(e):(e=e[E("iterator")](),r={},t=(s,a)=>(a=e[s])&&(r[s]=n=>new Promise((c,l,p)=>(n=a.call(e,n),p=n.done,Promise.resolve(n.value).then(d=>c({value:d,done:p}),l)))),t("next"),t("return"),r);import{AbstractAgent as H,EventType as f}from"@ag-ui/client";import{RequestContext as $}from"@mastra/core/request-context";import{randomUUID as L}from"@ag-ui/client";import{Observable as K}from"rxjs";var q=e=>e?typeof e=="string"?e:Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>t.text.trim()).filter(Boolean).join(`
`):"":"";function T(e){var t,s;let r=[];for(let a of e)if(a.role==="assistant"){let n=q(a.content),c=[];n&&c.push({type:"text",text:n});for(let l of(t=a.toolCalls)!=null?t:[])c.push({type:"tool-call",toolCallId:l.id,toolName:l.function.name,args:JSON.parse(l.function.arguments)});r.push({role:"assistant",content:c})}else if(a.role==="user"){let n=q(a.content);r.push({role:"user",content:n})}else if(a.role==="tool"){let n="unknown";for(let c of e)if(c.role==="assistant"){for(let l of(s=c.toolCalls)!=null?s:[])if(l.id===a.toolCallId){n=l.function.name;break}}r.push({role:"tool",content:[{type:"tool-result",toolCallId:a.toolCallId,toolName:n,result:a.content}]})}return r}async function _({mastraClient:e,resourceId:r}){let t=await e.listAgents();return Object.entries(t).reduce((s,[a])=>{let n=e.getAgent(a);return s[a]=new C({agentId:a,agent:n,resourceId:r}),s},{})}function b({mastra:e,resourceId:r,requestContext:t}){let s=e.listAgents()||{};return Object.entries(s).reduce((n,[c,l])=>(n[c]=new C({agentId:c,agent:l,resourceId:r,requestContext:t}),n),{})}function U({mastra:e,agentId:r,resourceId:t,requestContext:s}){let a=e.getAgent(r);if(!a)throw new Error(`Agent ${r} not found`);return new C({agentId:r,agent:a,resourceId:t,requestContext:s})}function D({mastra:e,networkId:r,resourceId:t,requestContext:s}){let a=e.getAgent(r);if(!a)throw new Error(`Network ${r} not found`);return new C({agentId:a.name,agent:a,resourceId:t,requestContext:s})}var C=class e extends H{constructor(t){let l=t,{agent:s,resourceId:a,requestContext:n}=l,c=v(l,["agent","resourceId","requestContext"]);super(c);this.config=t;this.agent=s,this.resourceId=a,this.requestContext=n!=null?n:new $}clone(){return new e(this.config)}run(t){let s=L();return new K(a=>((async()=>{var l,p,d;let c={type:f.RUN_STARTED,threadId:t.threadId,runId:t.runId};if(a.next(c),this.isLocalMastraAgent(this.agent)){let o=await this.agent.getMemory({requestContext:this.requestContext});if(o&&t.state&&Object.keys(t.state||{}).length>0){let i=await o.getThreadById({threadId:t.threadId});i||(i={id:t.threadId,title:"",metadata:{},resourceId:(l=this.resourceId)!=null?l:t.threadId,createdAt:new Date,updatedAt:new Date});let A=JSON.parse((d=(p=i.metadata)==null?void 0:p.workingMemory)!=null?d:"{}"),u=t.state,{messages:y}=u,x=v(u,["messages"]),h=JSON.stringify(I(I({},A),x));await o.saveThread({thread:M(I({},i),{metadata:M(I({},i.metadata),{workingMemory:h})})})}}try{await this.streamMastraAgent(t,{onTextPart:o=>{let i={type:f.TEXT_MESSAGE_CHUNK,role:"assistant",messageId:s,delta:o};a.next(i)},onToolCallPart:o=>{let i={type:f.TOOL_CALL_START,parentMessageId:s,toolCallId:o.toolCallId,toolCallName:o.toolName};a.next(i);let A={type:f.TOOL_CALL_ARGS,toolCallId:o.toolCallId,delta:JSON.stringify(o.args)};a.next(A);let y={type:f.TOOL_CALL_END,toolCallId:o.toolCallId};a.next(y)},onToolResultPart(o){let i={type:f.TOOL_CALL_RESULT,toolCallId:o.toolCallId,content:JSON.stringify(o.result),messageId:L(),role:"tool"};a.next(i)},onFinishMessagePart:async()=>{s=L()},onError:o=>{console.error("error",o),a.error(o)},onRunFinished:async()=>{if(this.isLocalMastraAgent(this.agent))try{let o=await this.agent.getMemory({requestContext:this.requestContext});if(o){let i=await o.getWorkingMemory({resourceId:this.resourceId,threadId:t.threadId,memoryConfig:{workingMemory:{enabled:!0}}});if(typeof i=="string"){let A=JSON.parse(i);if(A&&!("$schema"in A)){let y={type:f.STATE_SNAPSHOT,snapshot:A};a.next(y)}}}}catch(o){console.error("Error sending state snapshot",o)}a.next({type:f.RUN_FINISHED,threadId:t.threadId,runId:t.runId}),a.complete()}})}catch(o){console.error("Stream error:",o),a.error(o)}})(),()=>{}))}isLocalMastraAgent(t){return"getMemory"in t}async streamMastraAgent({threadId:t,runId:s,messages:a,tools:n,context:c},{onTextPart:l,onFinishMessagePart:p,onToolCallPart:d,onToolResultPart:u,onError:o,onRunFinished:i}){var O,S;let A=n.reduce((m,g)=>(m[g.name]={id:g.name,description:g.description,inputSchema:g.parameters},m),{}),y=(O=this.resourceId)!=null?O:t,x=T(a);(S=this.requestContext)==null||S.set("ag-ui",{context:c});let h=this.requestContext;if(this.isLocalMastraAgent(this.agent))try{let m=await this.agent.stream(x,{memory:{thread:t,resource:y},runId:s,clientTools:A,requestContext:h});if(m&&typeof m=="object"){try{for(var it=G(m.fullStream),gt,ct,mt;gt=!(ct=await it.next()).done;gt=!1){let g=ct.value;switch(g.type){case"text-delta":{l==null||l(g.payload.text);break}case"tool-call":{d==null||d({toolCallId:g.payload.toolCallId,toolName:g.payload.toolName,args:g.payload.args});break}case"tool-result":{u==null||u({toolCallId:g.payload.toolCallId,result:g.payload.result});break}case"error":{o==null||o(new Error(g.payload.error));break}case"finish":{p==null||p();break}}}}catch(ct){mt=[ct]}finally{try{gt&&(ct=it.return)&&await ct.call(it)}finally{if(mt)throw mt[0]}}await(i==null?void 0:i())}else throw new Error("Invalid response from local agent")}catch(m){o==null||o(m)}else try{let m=await this.agent.stream({memory:{thread:t,resource:y},runId:s,messages:x,clientTools:A,requestContext:h});if(m&&typeof m.processDataStream=="function")await m.processDataStream({onChunk:async g=>{switch(g.type){case"text-delta":{l==null||l(g.payload.text);break}case"tool-call":{d==null||d({toolCallId:g.payload.toolCallId,toolName:g.payload.toolName,args:g.payload.args});break}case"tool-result":{u==null||u({toolCallId:g.payload.toolCallId,result:g.payload.result});break}case"finish":{p==null||p();break}}}}),await(i==null?void 0:i());else throw new Error("Invalid response from remote agent")}catch(m){o==null||o(m)}}static async getRemoteAgents(t){return _(t)}static getLocalAgents(t){return b(t)}static getLocalAgent(t){return U(t)}static getNetwork(t){return D(t)}};export{C as MastraAgent,T as convertAGUIMessagesToMastra,U as getLocalAgent,b as getLocalAgents,D as getNetwork,_ as getRemoteAgents};
//# sourceMappingURL=index.mjs.map