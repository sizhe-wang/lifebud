# Observability API Reference

> API reference for observability - 8 entries


---

## Reference: OtelBridge

> OpenTelemetry bridge for Tracing

> **Note:**

The OpenTelemetry Bridge is currently **experimental**. APIs and configuration options may change in future releases.

Enables bidirectional integration between Mastra tracing and OpenTelemetry infrastructure. Creates native OTEL spans for Mastra operations and inherits context from active OTEL spans.

## Constructor

```typescript
new OtelBridge()
```

## Methods

### executeInContext

```typescript
executeInContext<T>(spanId: string, fn: () => Promise<T>): Promise<T>
```

Executes an async function within the OTEL context of a Mastra span. OTEL-instrumented code running inside the function will have correct parent relationships.

**Returns:** `Promise<T>` - The result of the function execution.

### executeInContextSync

```typescript
executeInContextSync<T>(spanId: string, fn: () => T): T
```

Executes a synchronous function within the OTEL context of a Mastra span.

**Returns:** `T` - The result of the function execution.

### shutdown

```typescript
async shutdown(): Promise<void>
```

Shuts down the bridge and cleans up resources. Ends any spans that were not properly closed.

## Usage Examples

### Basic Usage

```typescript
import { Mastra } from "@mastra/core";
import { Observability } from "@mastra/observability";
import { OtelBridge } from "@mastra/otel-bridge";

const mastra = new Mastra({
  observability: new Observability({
    configs: {
      default: {
        serviceName: "my-service",
        bridge: new OtelBridge(),
      },
    },
  }),
  agents: { myAgent },
});
```

### Combined with Exporters

The bridge can be used alongside exporters. The bridge handles OTEL context, while exporters send data to additional destinations:

```typescript
import { Mastra } from "@mastra/core";
import { Observability, DefaultExporter } from "@mastra/observability";
import { OtelBridge } from "@mastra/otel-bridge";
import { LangfuseExporter } from "@mastra/langfuse";

const mastra = new Mastra({
  observability: new Observability({
    configs: {
      default: {
        serviceName: "my-service",
        bridge: new OtelBridge(), // Handles OTEL context
        exporters: [
          new DefaultExporter(), // Studio access
          new LangfuseExporter({
            // Additional destination
            publicKey: process.env.LANGFUSE_PUBLIC_KEY,
            secretKey: process.env.LANGFUSE_SECRET_KEY,
          }),
        ],
      },
    },
  }),
});
```

## OpenTelemetry Setup Requirements

The OtelBridge requires an active OpenTelemetry SDK to function. The bridge reads from OTEL's ambient context.

See the [OtelBridge Guide](https://mastra.ai/docs/v1/observability/tracing/bridges/otel#configuration) for complete setup instructions, including how to configure OTEL instrumentation and run your application.

## Tags Support

The OtelBridge supports trace tagging for categorization and filtering. Tags are only applied to root spans and are included as the `mastra.tags` attribute on native OTEL spans.

### Usage

```typescript
const result = await agent.generate({
  messages: [{ role: "user", content: "Hello" }],
  tracingOptions: {
    tags: ["production", "experiment-v2", "user-request"],
  },
});
```

### How Tags Are Stored

Tags are stored as a JSON-stringified array in the `mastra.tags` span attribute:

```json
{
  "mastra.tags": "[\"production\",\"experiment-v2\",\"user-request\"]"
}
```

This format ensures compatibility with all OTEL-compatible backends and collectors.

## Related

- [OtelBridge Guide](https://mastra.ai/docs/v1/observability/tracing/bridges/otel) - Setup guide with examples
- [Tracing Overview](https://mastra.ai/docs/v1/observability/tracing/overview) - General tracing concepts
- [OtelExporter Reference](https://mastra.ai/reference/v1/observability/tracing/exporters/otel) - OTEL exporter for sending traces

---

## Reference: DatadogExporter

> Datadog LLM Observability exporter for Tracing

Sends Tracing data to Datadog's LLM Observability product for monitoring and analytics.

## Constructor

```typescript
new DatadogExporter(config: DatadogExporterConfig)
```

## DatadogExporterConfig

```typescript
interface DatadogExporterConfig extends BaseExporterConfig {
  apiKey?: string;
  mlApp?: string;
  site?: string;
  service?: string;
  env?: string;
  agentless?: boolean;
  integrationsEnabled?: boolean;
}
```

Extends `BaseExporterConfig`, which includes:
- `logger?: IMastraLogger` - Logger instance
- `logLevel?: LogLevel | 'debug' | 'info' | 'warn' | 'error'` - Log level (default: INFO)

## Methods

### exportTracingEvent

```typescript
async exportTracingEvent(event: TracingEvent): Promise<void>
```

Exports a tracing event to Datadog LLM Observability.

### shutdown

```typescript
async shutdown(): Promise<void>
```

Flushes pending data and shuts down the exporter. Cancels any pending cleanup timers and disables LLM Observability.

## Usage

### Zero-Config (using environment variables)

```typescript
import { DatadogExporter } from "@mastra/datadog";

// Reads from DD_LLMOBS_ML_APP, DD_API_KEY, DD_SITE, DD_ENV
const exporter = new DatadogExporter();
```

### Explicit Configuration

```typescript
import { DatadogExporter } from "@mastra/datadog";

const exporter = new DatadogExporter({
  mlApp: "my-llm-app",
  apiKey: process.env.DD_API_KEY,
  site: "datadoghq.com",
  env: "production",
});
```

### With Local Datadog Agent

```typescript
const exporter = new DatadogExporter({
  mlApp: "my-llm-app",
  agentless: false, // Use local Datadog Agent
  env: "production",
});
```

## Span Mapping

Mastra span types are mapped to Datadog LLMObs span kinds:

| Mastra SpanType | Datadog Kind |
|-----------------|--------------|
| `AGENT_RUN` | `agent` |
| `MODEL_GENERATION` | `workflow` |
| `MODEL_STEP` | `llm` |
| `TOOL_CALL` | `tool` |
| `MCP_TOOL_CALL` | `tool` |
| `WORKFLOW_RUN` | `workflow` |
| All other types | `task` |

All unmapped span types (including `MODEL_CHUNK`, `WORKFLOW_STEP`, `GENERIC`, and future span types) automatically default to `task`.

## Environment Variables

The exporter reads configuration from these environment variables:

| Variable | Description |
|----------|-------------|
| `DD_API_KEY` | Datadog API key |
| `DD_LLMOBS_ML_APP` | ML application name |
| `DD_SITE` | Datadog site |
| `DD_ENV` | Environment name |
| `DD_LLMOBS_AGENTLESS_ENABLED` | Set to 'false' or '0' to use local agent |

---

## Reference: SensitiveDataFilter

> API reference for the SensitiveDataFilter processor

A SpanOutputProcessor that redacts sensitive information from span fields.

## Constructor

```typescript
new SensitiveDataFilter(options?: SensitiveDataFilterOptions)
```

## SensitiveDataFilterOptions

```typescript
interface SensitiveDataFilterOptions {
  /**
   * List of sensitive field names to redact.
   * Matching is case-insensitive and normalizes separators
   * (api-key, api_key, Api Key â†’ apikey).
   * Defaults include: password, token, secret, key, apikey, auth,
   * authorization, bearer, bearertoken, jwt, credential,
   * clientsecret, privatekey, refresh, ssn.
   */
  sensitiveFields?: string[];

  /**
   * The token used for full redaction.
   * Default: "[REDACTED]"
   */
  redactionToken?: string;

  /**
   * Style of redaction to use:
   * - "full": always replace with redactionToken
   * - "partial": show 3 characters from the start and end, redact the middle
   * Default: "full"
   */
  redactionStyle?: RedactionStyle;
}
```

## RedactionStyle

```typescript
type RedactionStyle = "full" | "partial";
```

## Methods

### process

```typescript
process(span: AnySpan): AnySpan
```

Process a span by filtering sensitive data across its key fields: attributes, metadata, input, output, and errorInfo.

**Returns:** A new span with sensitive values redacted.

### shutdown

```typescript
async shutdown(): Promise<void>
```

No cleanup needed for this processor.

## Properties

```typescript
readonly name = 'sensitive-data-filter';
```

## Default Sensitive Fields

When no custom fields are provided:

```typescript
[
  "password",
  "token",
  "secret",
  "key",
  "apikey",
  "auth",
  "authorization",
  "bearer",
  "bearertoken",
  "jwt",
  "credential",
  "clientsecret",
  "privatekey",
  "refresh",
  "ssn",
];
```

## Processing Behavior

### Field Matching

- **Case-insensitive**: `APIKey`, `apikey`, `ApiKey` all match
- **Separator-agnostic**: `api-key`, `api_key`, `apiKey` are treated identically
- **Exact matching**: After normalization, fields must match exactly
  - `token` matches `token`, `Token`, `TOKEN`
  - `token` does NOT match `promptTokens` or `tokenCount`

### Redaction Styles

#### Full Redaction (default)

All matched values replaced with redactionToken.

#### Partial Redaction

- Shows first 3 and last 3 characters
- Values â‰¤ 6 characters are fully redacted
- Non-string values are converted to strings before partial redaction

### Error Handling

If filtering a field fails, the field is replaced with:

```typescript
{
  error: {
    processor: "sensitive-data-filter";
  }
}
```

### Processed Fields

The filter recursively processes:

- `span.attributes` - Span metadata and properties
- `span.metadata` - Custom metadata
- `span.input` - Input data
- `span.output` - Output data
- `span.errorInfo` - Error information

Handles nested objects, arrays, and circular references safely.

---

## Reference: Configuration

> Tracing configuration types and registry functions

## ObservabilityRegistryConfig

```typescript
interface ObservabilityRegistryConfig {
  default?: { enabled?: boolean };
  configs?: Record<string, Omit<ObservabilityInstanceConfig, "name"> | ObservabilityInstance>;
  configSelector?: ConfigSelector;
}
```

## ObservabilityInstanceConfig

```typescript
interface ObservabilityInstanceConfig {
  name: string;
  serviceName: string;
  sampling?: SamplingStrategy;
  exporters?: ObservabilityExporter[];
  spanOutputProcessors?: SpanOutputProcessor[];
  includeInternalSpans?: boolean;
  requestContextKeys?: string[];
  serializationOptions?: SerializationOptions;
}
```

## SerializationOptions

Options for controlling how span data is serialized before export. Use these to customize truncation limits for large payloads.

```typescript
interface SerializationOptions {
  maxStringLength?: number;
  maxDepth?: number;
  maxArrayLength?: number;
  maxObjectKeys?: number;
}
```

## SamplingStrategy

```typescript
type SamplingStrategy =
  | { type: "always" }
  | { type: "never" }
  | { type: "ratio"; probability: number }
  | { type: "custom"; sampler: (options?: TracingOptions) => boolean };
```

## ConfigSelector

```typescript
type ConfigSelector = (
  options: ConfigSelectorOptions,
  availableConfigs: ReadonlyMap<string, ObservabilityInstance>,
) => string | undefined;
```

## ConfigSelectorOptions

```typescript
interface ConfigSelectorOptions {
  requestContext?: RequestContext;
}
```

# Registry Methods

The Observability class provides methods for managing observability instances:

## registerInstance

```typescript
registerInstance(
  name: string,
  instance: ObservabilityInstance,
  isDefault?: boolean
): void;
```

Registers an observability instance in the registry.

## getInstance

```typescript
getInstance(name: string): ObservabilityInstance | undefined;
```

Retrieves an observability instance by name.

## getDefaultInstance

```typescript
getDefaultInstance(): ObservabilityInstance | undefined;
```

Returns the default observability instance.

## getSelectedInstance

```typescript
getSelectedInstance(
  options: ConfigSelectorOptions
): ObservabilityInstance | undefined;
```

Returns the observability instance selected by the config selector or default.

## listInstances

```typescript
listInstances(): ReadonlyMap<string, ObservabilityInstance>;
```

Returns all registered observability instances.

## hasInstance

```typescript
hasInstance(name: string): boolean;
```

Checks if an observability instance exists.

## setConfigSelector

```typescript
setConfigSelector(selector: ConfigSelector): void;
```

Sets the config selector function.

## unregisterInstance

```typescript
unregisterInstance(name: string): boolean;
```

Removes an observability instance from the registry.

## clear

```typescript
clear(): void;
```

Clears all instances without shutdown.

## shutdown

```typescript
async shutdown(): Promise<void>;
```

Shuts down all observability instances and clears the registry.

## See Also

### Documentation

- [Tracing Overview](https://mastra.ai/docs/v1/observability/tracing/overview) - Concepts and usage guide
- [Sampling Strategies](https://mastra.ai/docs/v1/observability/tracing/overview#sampling-strategies) - Sampling configuration details
- [Multi-Config Setup](https://mastra.ai/docs/v1/observability/tracing/overview#multi-config-setup) - Using multiple configurations

### Reference

- [Tracing Classes](https://mastra.ai/reference/v1/observability/tracing/instances) - Core tracing classes
- [Interfaces](https://mastra.ai/reference/v1/observability/tracing/interfaces) - Type definitions
- [Spans Reference](https://mastra.ai/reference/v1/observability/tracing/spans) - Span lifecycle

### Exporters

- [DefaultExporter](https://mastra.ai/reference/v1/observability/tracing/exporters/default-exporter) - Storage configuration
- [CloudExporter](https://mastra.ai/reference/v1/observability/tracing/exporters/cloud-exporter) - Cloud setup
- [Braintrust](https://mastra.ai/reference/v1/observability/tracing/exporters/braintrust) - Braintrust integration
- [Langfuse](https://mastra.ai/reference/v1/observability/tracing/exporters/langfuse) - Langfuse integration
- [LangSmith](https://mastra.ai/reference/v1/observability/tracing/exporters/langsmith) - LangSmith integration

---

## Reference: ConsoleExporter

> API reference for the ConsoleExporter

Outputs trace events to the console for debugging and development.

## Constructor

```typescript
new ConsoleExporter(config?: BaseExporterConfig)
```

## BaseExporterConfig

```typescript
interface BaseExporterConfig {
  logger?: IMastraLogger;
  logLevel?: LogLevel | 'debug' | 'info' | 'warn' | 'error';
}
```

## Properties

```typescript
readonly name = 'tracing-console-exporter';
```

## Methods

### exportTracingEvent

```typescript
async exportTracingEvent(event: TracingEvent): Promise<void>
```

Exports a tracing event to the console.

### shutdown

```typescript
async shutdown(): Promise<void>
```

Logs shutdown message.

## Output Format

The exporter outputs different formats based on event type:

### SPAN_STARTED

```
ðŸš€ SPAN_STARTED
   Type: [span type]
   Name: [span name]
   ID: [span id]
   Trace ID: [trace id]
   Input: [formatted input]
   Attributes: [formatted attributes]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

### SPAN_ENDED

```
âœ… SPAN_ENDED
   Type: [span type]
   Name: [span name]
   ID: [span id]
   Duration: [duration]ms
   Trace ID: [trace id]
   Input: [formatted input]
   Output: [formatted output]
   Error: [formatted error if present]
   Attributes: [formatted attributes]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

### SPAN_UPDATED

```
ðŸ“ SPAN_UPDATED
   Type: [span type]
   Name: [span name]
   ID: [span id]
   Trace ID: [trace id]
   Input: [formatted input]
   Output: [formatted output]
   Error: [formatted error if present]
   Updated Attributes: [formatted attributes]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

## Usage

```typescript
import { ConsoleExporter } from "@mastra/observability";
import { ConsoleLogger, LogLevel } from "@mastra/core/logger";

// Use default logger (INFO level)
const exporter = new ConsoleExporter();

// Use custom log level
const exporter = new ConsoleExporter({
  logLevel: 'debug'
});

// Use custom logger instance
const customLogger = new ConsoleLogger({ level: LogLevel.DEBUG });
const exporterWithLogger = new ConsoleExporter({
  logger: customLogger
});
```

## Implementation Details

- Formats attributes as JSON with 2-space indentation
- Calculates and displays span duration in milliseconds
- Handles serialization errors gracefully
- Logs unimplemented event types as warnings
- Uses 80-character separator lines between events

## See Also

### Documentation

- [Tracing Overview](https://mastra.ai/docs/v1/observability/tracing/overview) - Complete guide
- [Exporters](https://mastra.ai/docs/v1/observability/tracing/overview#exporters) - Exporter concepts

### Other Exporters

- [DefaultExporter](https://mastra.ai/reference/v1/observability/tracing/exporters/default-exporter) - Storage persistence
- [CloudExporter](https://mastra.ai/reference/v1/observability/tracing/exporters/cloud-exporter) - Mastra Cloud
- [Langfuse](https://mastra.ai/reference/v1/observability/tracing/exporters/langfuse) - Langfuse integration
- [Braintrust](https://mastra.ai/reference/v1/observability/tracing/exporters/braintrust) - Braintrust integration

### Reference

- [Configuration](https://mastra.ai/reference/v1/observability/tracing/configuration) - Configuration options
- [Interfaces](https://mastra.ai/reference/v1/observability/tracing/interfaces) - Type definitions

---

## Reference: Tracing

> Core Tracing classes and methods

## DefaultObservabilityInstance

Default implementation of the ObservabilityInstance interface.

### Constructor

```typescript
new DefaultObservabilityInstance(config: ObservabilityInstanceConfig)
```

Creates a new DefaultObservabilityInstance with the specified configuration.

### Properties

Inherits all properties and methods from BaseObservabilityInstance.

## BaseObservabilityInstance

Base class for custom ObservabilityInstance implementations.

### Methods

#### getConfig

```typescript
getConfig(): Readonly<Required<ObservabilityInstanceConfig>>
```

Returns the current observability configuration.

#### getExporters

```typescript
getExporters(): readonly ObservabilityExporter[]
```

Returns all configured exporters.

#### getSpanOutputProcessors

```typescript
getSpanOutputProcessors(): readonly SpanOutputProcessor[]
```

Returns all configured span output processors.

#### getLogger

```typescript
getLogger(): IMastraLogger
```

Returns the logger instance for exporters and other components.

#### startSpan

```typescript
startSpan<TType extends SpanType>(
  options: StartSpanOptions<TType>
): Span<TType>
```

Start a new span of a specific SpanType. Creates the root span of a trace if no parent is provided.

#### shutdown

```typescript
async shutdown(): Promise<void>
```

Shuts down all exporters and processors, cleaning up resources.

## Custom Implementation

To create a custom ObservabilityInstance implementation, extend BaseObservabilityInstance:

```typescript
class CustomObservabilityInstance extends BaseObservabilityInstance {
  constructor(config: ObservabilityInstanceConfig) {
    super(config);
    // Custom initialization
  }

  // Override methods as needed
  startSpan<TType extends SpanType>(
    options: StartSpanOptions<TType>,
  ): Span<TType> {
    // Custom span creation logic
    return super.startSpan(options);
  }
}
```

## See Also

### Documentation

- [Tracing Overview](https://mastra.ai/docs/v1/observability/tracing/overview) - Concepts and usage guide
- [Configuration Reference](https://mastra.ai/reference/v1/observability/tracing/configuration) - Configuration options
- [Interfaces Reference](https://mastra.ai/reference/v1/observability/tracing/interfaces) - Type definitions
- [Spans Reference](https://mastra.ai/reference/v1/observability/tracing/spans) - Span lifecycle and methods

### Exporters

- [DefaultExporter](https://mastra.ai/reference/v1/observability/tracing/exporters/default-exporter) - Storage persistence
- [CloudExporter](https://mastra.ai/reference/v1/observability/tracing/exporters/cloud-exporter) - Mastra Cloud integration
- [ConsoleExporter](https://mastra.ai/reference/v1/observability/tracing/exporters/console-exporter) - Debug output

---

## Reference: Interfaces

> Tracing type definitions and interfaces

## Core Interfaces

### ObservabilityInstance

Primary interface for observability.

```typescript
interface ObservabilityInstance {
  /** Get current configuration */
  getConfig(): Readonly<Required<ObservabilityInstanceConfig>>;

  /** Get all exporters */
  getExporters(): readonly ObservabilityExporter[];

  /** Get all span output processors */
  getSpanOutputProcessors(): readonly SpanOutputProcessor[];

  /** Get the logger instance (for exporters and other components) */
  getLogger(): IMastraLogger;

  /** Start a new span of a specific SpanType */
  startSpan<TType extends SpanType>(
    options: StartSpanOptions<TType>,
  ): Span<TType>;

  /** Shutdown observability and clean up resources */
  shutdown(): Promise<void>;
}
```

### SpanTypeMap

Mapping of span types to their corresponding attribute interfaces.

```typescript
interface SpanTypeMap {
  AGENT_RUN: AgentRunAttributes;
  WORKFLOW_RUN: WorkflowRunAttributes;
  MODEL_GENERATION: ModelGenerationAttributes;
  MODEL_STEP: ModelStepAttributes;
  MODEL_CHUNK: ModelChunkAttributes;
  TOOL_CALL: ToolCallAttributes;
  MCP_TOOL_CALL: MCPToolCallAttributes;
  PROCESSOR_RUN: ProcessorRunAttributes;
  WORKFLOW_STEP: WorkflowStepAttributes;
  WORKFLOW_CONDITIONAL: WorkflowConditionalAttributes;
  WORKFLOW_CONDITIONAL_EVAL: WorkflowConditionalEvalAttributes;
  WORKFLOW_PARALLEL: WorkflowParallelAttributes;
  WORKFLOW_LOOP: WorkflowLoopAttributes;
  WORKFLOW_SLEEP: WorkflowSleepAttributes;
  WORKFLOW_WAIT_EVENT: WorkflowWaitEventAttributes;
  GENERIC: AIBaseAttributes;
}
```

This mapping defines which attribute interface is used for each span type when creating or processing spans.

### Span

Span interface, used internally for tracing.

```typescript
interface Span<TType extends SpanType> {
  readonly id: string;
  readonly traceId: string;
  readonly type: TType;
  readonly name: string;

  /** Is an internal span? (spans internal to the operation of mastra) */
  isInternal: boolean;

  /** Parent span reference (undefined for root spans) */
  parent?: AnySpan;

  /** Pointer to the ObservabilityInstance instance */
  observabilityInstance: ObservabilityInstance;

  attributes?: SpanTypeMap[TType];
  metadata?: Record<string, any>;
  input?: any;
  output?: any;
  errorInfo?: any;

  /** Tags for categorizing traces (only present on root spans) */
  tags?: string[];

  /** End the span */
  end(options?: EndSpanOptions<TType>): void;

  /** Record an error for the span, optionally end the span as well */
  error(options: ErrorSpanOptions<TType>): void;

  /** Update span attributes */
  update(options: UpdateSpanOptions<TType>): void;

  /** Create child span - can be any span type independent of parent */
  createChildSpan<TChildType extends SpanType>(
    options: ChildSpanOptions<TChildType>,
  ): Span<TChildType>;

  /** Create event span - can be any span type independent of parent */
  createEventSpan<TChildType extends SpanType>(
    options: ChildEventOptions<TChildType>,
  ): Span<TChildType>;

  /** Returns TRUE if the span is the root span of a trace */
  get isRootSpan(): boolean;

  /** Returns TRUE if the span is a valid span (not a NO-OP Span) */
  get isValid(): boolean;
}
```

### ObservabilityExporter

Interface for observability exporters.

```typescript
interface ObservabilityExporter {
  /** Exporter name */
  name: string;

  /** Initialize exporter with tracing configuration and/or access to Mastra */
  init?(options: InitExporterOptions): void;

  /** Export tracing events */
  exportTracingEvent(event: TracingEvent): Promise<void>;

  /** Add score to a trace (optional) */
  addScoreToTrace?({
    traceId,
    spanId,
    score,
    reason,
    scorerName,
    metadata,
  }: {
    traceId: string;
    spanId?: string;
    score: number;
    reason?: string;
    scorerName: string;
    metadata?: Record<string, any>;
  }): Promise<void>;

  /** Shutdown exporter */
  shutdown(): Promise<void>;
}
```

### SpanOutputProcessor

Interface for span output processors.

```typescript
interface SpanOutputProcessor {
  /** Processor name */
  name: string;

  /** Process span before export */
  process(span?: AnySpan): AnySpan | undefined;

  /** Shutdown processor */
  shutdown(): Promise<void>;
}
```

## Span Types

### SpanType

AI-specific span types with their associated metadata.

```typescript
enum SpanType {
  /** Agent run - root span for agent processes */
  AGENT_RUN = "agent_run",

  /** Generic span for custom operations */
  GENERIC = "generic",

  /** Model generation with model calls, token usage, prompts, completions */
  MODEL_GENERATION = "model_generation",

  /** Single model execution step within a generation (one API call) */
  MODEL_STEP = "model_step",

  /** Individual model streaming chunk/event */
  MODEL_CHUNK = "model_chunk",

  /** MCP (Model Context Protocol) tool execution */
  MCP_TOOL_CALL = "mcp_tool_call",

  /** Input or Output Processor execution */
  PROCESSOR_RUN = "processor_run",

  /** Function/tool execution with inputs, outputs, errors */
  TOOL_CALL = "tool_call",

  /** Workflow run - root span for workflow processes */
  WORKFLOW_RUN = "workflow_run",

  /** Workflow step execution with step status, data flow */
  WORKFLOW_STEP = "workflow_step",

  /** Workflow conditional execution with condition evaluation */
  WORKFLOW_CONDITIONAL = "workflow_conditional",

  /** Individual condition evaluation within conditional */
  WORKFLOW_CONDITIONAL_EVAL = "workflow_conditional_eval",

  /** Workflow parallel execution */
  WORKFLOW_PARALLEL = "workflow_parallel",

  /** Workflow loop execution */
  WORKFLOW_LOOP = "workflow_loop",

  /** Workflow sleep operation */
  WORKFLOW_SLEEP = "workflow_sleep",

  /** Workflow wait for event operation */
  WORKFLOW_WAIT_EVENT = "workflow_wait_event",
}
```

### AnySpan

Union type for cases that need to handle any span.

```typescript
type AnySpan = Span<keyof SpanTypeMap>;
```

## Span Attributes

### AgentRunAttributes

Agent Run attributes.

```typescript
interface AgentRunAttributes {
  /** Agent identifier */
  agentId: string;

  /** Agent Instructions */
  instructions?: string;

  /** Agent Prompt */
  prompt?: string;

  /** Available tools for this execution */
  availableTools?: string[];

  /** Maximum steps allowed */
  maxSteps?: number;
}
```

### ModelGenerationAttributes

Model Generation attributes.

```typescript
interface ModelGenerationAttributes {
  /** Model name (e.g., 'gpt-4', 'claude-3') */
  model?: string;

  /** Model provider (e.g., 'openai', 'anthropic') */
  provider?: string;

  /** Type of result/output this model call produced */
  resultType?:
    | "tool_selection"
    | "response_generation"
    | "reasoning"
    | "planning";

  /** Token usage statistics */
  usage?: {
    promptTokens?: number;
    completionTokens?: number;
    totalTokens?: number;
    promptCacheHitTokens?: number;
    promptCacheMissTokens?: number;
  };

  /** Model parameters */
  parameters?: {
    maxOutputTokens?: number;
    temperature?: number;
    topP?: number;
    topK?: number;
    presencePenalty?: number;
    frequencyPenalty?: number;
    stopSequences?: string[];
    seed?: number;
    maxRetries?: number;
  };

  /** Whether this was a streaming response */
  streaming?: boolean;

  /** Reason the generation finished */
  finishReason?: string;
}
```

### ModelStepAttributes

Model Step attributes - for a single model execution within a generation.

```typescript
interface ModelStepAttributes {
  /** Index of this step in the generation (0, 1, 2, ...) */
  stepIndex?: number;

  /** Token usage statistics */
  usage?: UsageStats;

  /** Reason this step finished (stop, tool-calls, length, etc.) */
  finishReason?: string;

  /** Should execution continue */
  isContinued?: boolean;

  /** Result warnings */
  warnings?: Record<string, any>;
}
```

### ModelChunkAttributes

Model Chunk attributes - for individual streaming chunks/events.

```typescript
interface ModelChunkAttributes {
  /** Type of chunk (text-delta, reasoning-delta, tool-call, etc.) */
  chunkType?: string;

  /** Sequence number of this chunk in the stream */
  sequenceNumber?: number;
}
```

### ToolCallAttributes

Tool Call attributes.

```typescript
interface ToolCallAttributes {
  toolId?: string;
  toolType?: string;
  toolDescription?: string;
  success?: boolean;
}
```

### MCPToolCallAttributes

MCP Tool Call attributes.

```typescript
interface MCPToolCallAttributes {
  /** Id of the MCP tool/function */
  toolId: string;

  /** MCP server identifier */
  mcpServer: string;

  /** MCP server version */
  serverVersion?: string;

  /** Whether tool execution was successful */
  success?: boolean;
}
```

### ProcessorRunAttributes

Processor attributes.

```typescript
interface ProcessorRunAttributes {
  /** Name of the Processor */
  processorName: string;

  /** Processor type (input or output) */
  processorType: 'input' | 'output';

  /** Processor index in the agent */
  processorIndex?: number;
}
```

### WorkflowRunAttributes

Workflow Run attributes.

```typescript
interface WorkflowRunAttributes {
  /** Workflow identifier */
  workflowId: string;

  /** Workflow status */
  status?: WorkflowRunStatus;
}
```

### WorkflowStepAttributes

Workflow Step attributes.

```typescript
interface WorkflowStepAttributes {
  /** Step identifier */
  stepId: string;

  /** Step status */
  status?: WorkflowStepStatus;
}
```

## Options Types

### StartSpanOptions

Options for starting new spans.

```typescript
interface StartSpanOptions<TType extends SpanType> {
  /** Span type */
  type: TType;

  /** Span name */
  name: string;

  /** Span attributes */
  attributes?: SpanTypeMap[TType];

  /** Span metadata */
  metadata?: Record<string, any>;

  /** Input data */
  input?: any;

  /** Parent span */
  parent?: AnySpan;

  /** Policy-level tracing configuration */
  tracingPolicy?: TracingPolicy;

  /** Options passed when using a custom sampler strategy */
  customSamplerOptions?: CustomSamplerOptions;
}
```

### UpdateSpanOptions

Options for updating spans.

```typescript
interface UpdateSpanOptions<TType extends SpanType> {
  /** Span attributes */
  attributes?: Partial<SpanTypeMap[TType]>;

  /** Span metadata */
  metadata?: Record<string, any>;

  /** Input data */
  input?: any;

  /** Output data */
  output?: any;
}
```

### EndSpanOptions

Options for ending spans.

```typescript
interface EndSpanOptions<TType extends SpanType> {
  /** Output data */
  output?: any;

  /** Span metadata */
  metadata?: Record<string, any>;

  /** Span attributes */
  attributes?: Partial<SpanTypeMap[TType]>;
}
```

### ErrorSpanOptions

Options for recording span errors.

```typescript
interface ErrorSpanOptions<TType extends SpanType> {
  /** The error associated with the issue */
  error: Error;

  /** End the span when true */
  endSpan?: boolean;

  /** Span metadata */
  metadata?: Record<string, any>;

  /** Span attributes */
  attributes?: Partial<SpanTypeMap[TType]>;
}
```

## Context Types

### TracingContext

Context for Tracing that flows through workflow and agent execution.

```typescript
interface TracingContext {
  /** Current span for creating child spans and adding metadata */
  currentSpan?: AnySpan;
}
```

### TracingProperties

Properties returned to the user for working with traces externally.

```typescript
type TracingProperties = {
  /** Trace ID used on the execution (if the execution was traced) */
  traceId?: string;
};
```

### TracingOptions

Options passed when starting a new agent or workflow execution.

```typescript
interface TracingOptions {
  /** Metadata to add to the root trace span */
  metadata?: Record<string, any>;

  /**
   * Additional RequestContext keys to extract as metadata for this trace.
   * These keys are added to the requestContextKeys config.
   * Supports dot notation for nested values (e.g., 'user.id', 'session.data.experimentId').
   */
  requestContextKeys?: string[];

  /**
   * Trace ID to use for this execution (1-32 hexadecimal characters).
   * If provided, this trace will be part of the specified trace rather than starting a new one.
   */
  traceId?: string;

  /**
   * Parent span ID to use for this execution (1-16 hexadecimal characters).
   * If provided, the root span will be created as a child of this span.
   */
  parentSpanId?: string;

  /**
   * Tags to apply to this trace.
   * Tags are string labels that can be used to categorize and filter traces
   * Note: Tags are only applied to the root span of a trace.
   */
  tags?: string[];

  /**
   * When true, input data will be hidden from all spans in this trace.
   * Useful for protecting sensitive data from being logged.
   */
  hideInput?: boolean;

  /**
   * When true, output data will be hidden from all spans in this trace.
   * Useful for protecting sensitive data from being logged.
   */
  hideOutput?: boolean;
}
```

### TracingPolicy

Policy-level tracing configuration applied when creating a workflow or agent.

```typescript
interface TracingPolicy {
  /**
   * Bitwise options to set different types of spans as Internal in
   * a workflow or agent execution. Internal spans are hidden by
   * default in exported traces.
   */
  internal?: InternalSpans;
}
```

## Configuration Types

### ObservabilityInstanceConfig

Configuration for a single observability instance.

```typescript
interface ObservabilityInstanceConfig {
  /** Unique identifier for this config in the observability registry */
  name: string;

  /** Service name for observability */
  serviceName: string;

  /** Sampling strategy - controls whether tracing is collected (defaults to ALWAYS) */
  sampling?: SamplingStrategy;

  /** Custom exporters */
  exporters?: ObservabilityExporter[];

  /** Custom span output processors */
  spanOutputProcessors?: SpanOutputProcessor[];

  /** Set to true if you want to see spans internal to the operation of mastra */
  includeInternalSpans?: boolean;

  /** RequestContext keys to automatically extract as metadata for all spans */
  requestContextKeys?: string[];
}
```

### ObservabilityRegistryConfig

Complete observability registry configuration.

```typescript
interface ObservabilityRegistryConfig {
  /** Enables default exporters, with sampling: always, and sensitive data filtering */
  default?: {
    enabled?: boolean;
  };

  /** Map of tracing instance names to their configurations or pre-instantiated instances */
  configs?: Record<string, Omit<ObservabilityInstanceConfig, "name"> | ObservabilityInstance>;

  /** Optional selector function to choose which tracing instance to use */
  configSelector?: ConfigSelector;
}
```

## Sampling Types

### SamplingStrategy

Sampling strategy configuration.

```typescript
type SamplingStrategy =
  | { type: "always" }
  | { type: "never" }
  | { type: "ratio"; probability: number }
  | { type: "custom"; sampler: (options?: CustomSamplerOptions) => boolean };
```

### CustomSamplerOptions

Options passed when using a custom sampler strategy.

```typescript
interface CustomSamplerOptions {
  requestContext?: RequestContext;
  metadata?: Record<string, any>;
}
```

## Config Selector Types

### ConfigSelector

Function to select which observability instance to use for a given span.

```typescript
type ConfigSelector = (
  options: ConfigSelectorOptions,
  availableConfigs: ReadonlyMap<string, ObservabilityInstance>,
) => string | undefined;
```

### ConfigSelectorOptions

Options passed when using a custom tracing config selector.

```typescript
interface ConfigSelectorOptions {
  /** Request Context */
  requestContext?: RequestContext;
}
```

## Internal Spans

### InternalSpans

Bitwise options to set different types of spans as internal in a workflow or agent execution.

```typescript
enum InternalSpans {
  /** No spans are marked internal */
  NONE = 0,

  /** Workflow spans are marked internal */
  WORKFLOW = 1 << 0,

  /** Agent spans are marked internal */
  AGENT = 1 << 1,

  /** Tool spans are marked internal */
  TOOL = 1 << 2,

  /** Model spans are marked internal */
  MODEL = 1 << 3,

  /** All spans are marked internal */
  ALL = (1 << 4) - 1,
}
```

## See Also

### Documentation

- [Tracing Overview](https://mastra.ai/docs/v1/observability/tracing/overview) - Complete guide to Tracing
- [Creating Child Spans](https://mastra.ai/docs/v1/observability/tracing/overview#creating-child-spans) - Working with span hierarchies
- [Adding Custom Metadata](https://mastra.ai/docs/v1/observability/tracing/overview#adding-custom-metadata) - Enriching traces

### Reference

- [Configuration](https://mastra.ai/reference/v1/observability/tracing/configuration) - Registry and configuration
- [Tracing Classes](https://mastra.ai/reference/v1/observability/tracing/instances) - Core implementations
- [Spans Reference](https://mastra.ai/reference/v1/observability/tracing/spans) - Span lifecycle methods

---

## Reference: Spans

> Span interfaces, methods, and lifecycle events

## BaseSpan

Base interface for all span types.

```typescript
interface BaseSpan<TType extends SpanType> {
  /** Unique span identifier */
  id: string;

  /** OpenTelemetry-compatible trace ID (32 hex chars) */
  traceId: string;

  /** Name of the span */
  name: string;

  /** Type of the span */
  type: TType;

  /** When span started */
  startTime: Date;

  /** When span ended */
  endTime?: Date;

  /** Type-specific attributes */
  attributes?: SpanTypeMap[TType];

  /** User-defined metadata */
  metadata?: Record<string, any>;

  /** Input passed at the start of the span */
  input?: any;

  /** Output generated at the end of the span */
  output?: any;

  /** Error information if span failed */
  errorInfo?: {
    message: string;
    id?: string;
    domain?: string;
    category?: string;
    details?: Record<string, any>;
  };

  /** Is an event span? (occurs at startTime, has no endTime) */
  isEvent: boolean;
}
```

## Span

Span interface, used internally for tracing. Extends BaseSpan with lifecycle methods and properties.

```typescript
interface Span<TType extends SpanType> extends BaseSpan<TType> {
  /** Is an internal span? (spans internal to the operation of mastra) */
  isInternal: boolean;

  /** Parent span reference (undefined for root spans) */
  parent?: AnySpan;

  /** Pointer to the ObservabilityInstance instance */
  observabilityInstance: ObservabilityInstance;
}
```

### Properties

```typescript
/** Returns TRUE if the span is the root span of a trace */
get isRootSpan(): boolean

/** Returns TRUE if the span is a valid span (not a NO-OP Span) */
get isValid(): boolean

/** Get the closest parent spanId that isn't an internal span */
getParentSpanId(includeInternalSpans?: boolean): string | undefined

/** Returns a lightweight span ready for export */
exportSpan(includeInternalSpans?: boolean): ExportedSpan<TType> | undefined
```

### Methods

#### end

```typescript
end(options?: EndSpanOptions<TType>): void
```

Ends the span and triggers export to configured exporters. Sets the `endTime` and optionally updates `output`, `metadata`, and `attributes`.

#### error

```typescript
error(options: ErrorSpanOptions<TType>): void
```

Records an error on the span. Sets the `errorInfo` field and can optionally end the span.

#### update

```typescript
update(options: UpdateSpanOptions<TType>): void
```

Updates span data while it's still active. Can modify `input`, `output`, `metadata`, and `attributes`.

#### createChildSpan

```typescript
createChildSpan<TChildType extends SpanType>(
  options: ChildSpanOptions<TChildType>
): Span<TChildType>
```

Creates a child span under this span. Child spans track sub-operations and inherit the trace context.

#### createEventSpan

```typescript
createEventSpan<TChildType extends SpanType>(
  options: ChildEventOptions<TChildType>
): Span<TChildType>
```

Creates an event span under this span. Event spans represent point-in-time occurrences with no duration.

## ExportedSpan

Exported Span interface, used for tracing exporters. A lightweight version of Span without methods or circular references.

```typescript
interface ExportedSpan<TType extends SpanType> extends BaseSpan<TType> {
  /** Parent span id reference (undefined for root spans) */
  parentSpanId?: string;

  /** TRUE if the span is the root span of a trace */
  isRootSpan: boolean;
}
```

## Span Lifecycle Events

Events emitted during the span lifecycle.

### TracingEventType

```typescript
enum TracingEventType {
  /** Emitted when a span is created and started */
  SPAN_STARTED = "span_started",

  /** Emitted when a span is updated via update() */
  SPAN_UPDATED = "span_updated",

  /** Emitted when a span is ended via end() or error() */
  SPAN_ENDED = "span_ended",
}
```

### TracingEvent

```typescript
type TracingEvent =
  | { type: "span_started"; exportedSpan: AnyExportedSpan }
  | { type: "span_updated"; exportedSpan: AnyExportedSpan }
  | { type: "span_ended"; exportedSpan: AnyExportedSpan };
```

Exporters receive these events to process and send trace data to observability platforms.

## Union Types

### AnySpan

```typescript
type AnySpan = Span<keyof SpanTypeMap>;
```

Union type for cases that need to handle any span type.

### AnyExportedSpan

```typescript
type AnyExportedSpan = ExportedSpan<keyof SpanTypeMap>;
```

Union type for cases that need to handle any exported span type.

## NO-OP Spans

When tracing is disabled (sampling returns false), NO-OP spans are returned:

### NoOpSpan

```typescript
class NoOpSpan<TType extends SpanType> extends BaseSpan<TType>
```

A span that performs no operations. All methods are no-ops:

- `id` returns `'no-op'`
- `traceId` returns `'no-op-trace'`
- `isValid` returns `false`
- `end()`, `error()`, `update()` do nothing
- `createChildSpan()` returns another NO-OP span

## See Also

### Documentation

- [Tracing Overview](https://mastra.ai/docs/v1/observability/tracing/overview) - Concepts and usage
- [Creating Child Spans](https://mastra.ai/docs/v1/observability/tracing/overview#creating-child-spans) - Practical examples
- [Retrieving Trace IDs](https://mastra.ai/docs/v1/observability/tracing/overview#retrieving-trace-ids) - Using trace IDs

### Reference

- [Tracing Classes](https://mastra.ai/reference/v1/observability/tracing/instances) - Core tracing classes
- [Interfaces](https://mastra.ai/reference/v1/observability/tracing/interfaces) - Complete type reference
- [Configuration](https://mastra.ai/reference/v1/observability/tracing/configuration) - Configuration options