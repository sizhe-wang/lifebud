{"version":3,"sources":["../src/build/plugins/node-modules-extension-resolver.ts","../src/build/bundler.ts"],"names":["getPackageRootPath","readFile","join","nodeResolve","isBuiltinModule","isAbsolute","getPackageName","slash","subpathExternalsResolver","pathToFileURL","alias","fileURLToPath","tsConfigPaths","esbuild","optimizeLodashImports","commonjs","esmShim","json","removeDeployer","rollup"],"mappings":"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","file":"chunk-7EPD2XJR.cjs","sourcesContent":["import { join, isAbsolute } from 'node:path';\nimport { readFile } from 'node:fs/promises';\nimport type { Plugin } from 'rollup';\nimport nodeResolve from '@rollup/plugin-node-resolve';\nimport { getPackageName, isBuiltinModule } from '../utils';\nimport { getPackageRootPath } from '../package-info';\nimport type { PackageJson } from 'type-fest';\n\n/**\n * Check if a package has an exports field in its package.json.\n * Results are cached to avoid repeated filesystem reads.\n */\nasync function getPackageJSON(pkgName: string, importer: string): Promise<PackageJson> {\n  const pkgRoot = await getPackageRootPath(pkgName, importer);\n  if (!pkgRoot) {\n    throw new Error(`Package ${pkgName} not found`);\n  }\n\n  const pkgJSON = JSON.parse(await readFile(join(pkgRoot, 'package.json'), 'utf-8')) as PackageJson;\n  return pkgJSON;\n}\n\n/**\n * Rollup plugin that resolves module extensions for external dependencies.\n *\n * This plugin handles ESM compatibility for external imports when node-resolve is not used:\n * - Packages WITH exports field (e.g., hono, date-fns): Keep imports as-is or strip redundant extensions\n * - Packages WITHOUT exports field (e.g., lodash): Add .js extension for direct file imports\n */\nexport function nodeModulesExtensionResolver(): Plugin {\n  // Create a single instance of node-resolve to reuse\n  const nodeResolvePlugin = nodeResolve();\n\n  return {\n    name: 'node-modules-extension-resolver',\n    async resolveId(id, importer, options) {\n      // Skip relative imports, absolute paths, no importer, or builtin modules\n      if (!importer || id.startsWith('.') || id.startsWith('/') || isBuiltinModule(id) || isAbsolute(id)) {\n        return null;\n      }\n\n      // Skip direct package imports (e.g., 'lodash', '@mastra/core')\n      const parts = id.split('/');\n      const isScoped = id.startsWith('@');\n      if ((isScoped && parts.length === 2) || (!isScoped && parts.length === 1)) {\n        return null;\n      }\n\n      const pkgName = getPackageName(id);\n      if (!pkgName) {\n        return null;\n      }\n\n      try {\n        const packageJSON = await getPackageJSON(pkgName, importer);\n        // if it has exports, node should be able to rsolve it, if not the exports map is wrong.\n        if (!!packageJSON.exports) {\n          return null;\n        }\n\n        const packageRoot = await getPackageRootPath(pkgName, importer);\n        // @ts-expect-error - handle is part of resolveId signature\n        const nodeResolved = await nodeResolvePlugin.resolveId?.handler?.call(this, id, importer, options);\n        // if we cannot resolve it, it's not a valid import so we let node handle it\n        if (!nodeResolved?.id) {\n          return null;\n        }\n\n        let filePath = nodeResolved.id;\n        if (nodeResolved.resolvedBy === 'commonjs--resolver') {\n          filePath = filePath.substring(1).split('?')[0];\n        }\n\n        const resolvedImportPath = filePath.replace(packageRoot, pkgName);\n\n        return {\n          id: resolvedImportPath,\n          external: true,\n        };\n      } catch (err) {\n        console.error(err);\n        return null;\n      }\n    },\n  };\n}\n","import alias from '@rollup/plugin-alias';\nimport commonjs from '@rollup/plugin-commonjs';\nimport json from '@rollup/plugin-json';\nimport nodeResolve from '@rollup/plugin-node-resolve';\nimport { esmShim } from './plugins/esm-shim';\nimport { fileURLToPath, pathToFileURL } from 'node:url';\nimport { rollup, type InputOptions, type OutputOptions, type Plugin } from 'rollup';\nimport { esbuild } from './plugins/esbuild';\nimport { optimizeLodashImports } from '@optimize-lodash/rollup-plugin';\nimport { analyzeBundle } from './analyze';\nimport { removeAllOptionsFromMastraExceptPlugin } from './plugins/remove-all-except';\nimport { tsConfigPaths } from './plugins/tsconfig-paths';\nimport { join } from 'node:path';\nimport { slash, type BundlerPlatform } from './utils';\nimport { subpathExternalsResolver } from './plugins/subpath-externals-resolver';\nimport { nodeModulesExtensionResolver } from './plugins/node-modules-extension-resolver';\nimport { removeDeployer } from './plugins/remove-deployer';\n\nexport async function getInputOptions(\n  entryFile: string,\n  analyzedBundleInfo: Awaited<ReturnType<typeof analyzeBundle>>,\n  platform: BundlerPlatform,\n  env: Record<string, string> = { 'process.env.NODE_ENV': JSON.stringify('production') },\n  {\n    sourcemap = false,\n    isDev = false,\n    projectRoot,\n    workspaceRoot = undefined,\n    enableEsmShim = true,\n    externalsPreset = false,\n  }: {\n    sourcemap?: boolean;\n    isDev?: boolean;\n    workspaceRoot?: string;\n    projectRoot: string;\n    enableEsmShim?: boolean;\n    externalsPreset?: boolean;\n  },\n): Promise<InputOptions> {\n  // For 'neutral' platform (Bun), use similar settings to 'node' for module resolution\n  let nodeResolvePlugin =\n    platform === 'node' || platform === 'neutral'\n      ? nodeResolve({\n          preferBuiltins: true,\n          exportConditions: ['node'],\n        })\n      : nodeResolve({\n          preferBuiltins: false,\n          browser: true,\n        });\n\n  const externalsCopy = new Set<string>(analyzedBundleInfo.externalDependencies);\n  const externals = externalsPreset ? [] : Array.from(externalsCopy);\n\n  const normalizedEntryFile = slash(entryFile);\n  return {\n    logLevel: process.env.MASTRA_BUNDLER_DEBUG === 'true' ? 'debug' : 'silent',\n    treeshake: 'smallest',\n    preserveSymlinks: true,\n    external: externals,\n    plugins: [\n      subpathExternalsResolver(externals),\n      {\n        name: 'alias-optimized-deps',\n        resolveId(id: string) {\n          if (!analyzedBundleInfo.dependencies.has(id)) {\n            return null;\n          }\n\n          const filename = analyzedBundleInfo.dependencies.get(id)!;\n          const absolutePath = join(workspaceRoot || projectRoot, filename);\n\n          // During `mastra dev` we want to keep deps as external\n          if (isDev) {\n            return {\n              id: process.platform === 'win32' ? pathToFileURL(absolutePath).href : absolutePath,\n              external: true,\n            };\n          }\n\n          // For production builds return the absolute path as-is so Rollup can handle itself\n          return {\n            id: absolutePath,\n            external: false,\n          };\n        },\n      } satisfies Plugin,\n      alias({\n        entries: [\n          {\n            find: /^\\#server$/,\n            replacement: slash(fileURLToPath(import.meta.resolve('@mastra/deployer/server'))),\n          },\n          {\n            find: /^\\@mastra\\/server\\/(.*)/,\n            replacement: `@mastra/server/$1`,\n            customResolver: id => {\n              if (id.startsWith('@mastra/server')) {\n                return {\n                  id: fileURLToPath(import.meta.resolve(id)),\n                };\n              }\n            },\n          },\n          { find: /^\\#mastra$/, replacement: normalizedEntryFile },\n        ],\n      }),\n      tsConfigPaths(),\n      {\n        name: 'tools-rewriter',\n        resolveId(id: string) {\n          if (id === '#tools') {\n            return {\n              id: './tools.mjs',\n              external: true,\n            };\n          }\n        },\n      } satisfies Plugin,\n      esbuild({\n        platform,\n        define: env,\n      }),\n      optimizeLodashImports({\n        include: '**/*.{js,ts,mjs,cjs}',\n      }),\n      externalsPreset\n        ? null\n        : commonjs({\n            extensions: ['.js', '.ts'],\n            transformMixedEsModules: true,\n            esmExternals(id) {\n              return externals.includes(id);\n            },\n          }),\n      enableEsmShim ? esmShim() : undefined,\n      externalsPreset ? nodeModulesExtensionResolver() : nodeResolvePlugin,\n      // for debugging\n      // {\n      //   name: 'logger',\n      //   //@ts-ignore\n      //   resolveId(id, ...args) {\n      //     console.log({ id, args });\n      //   },\n      //   // @ts-ignore\n      // transform(code, id) {\n      //   if (code.includes('class Duplexify ')) {\n      //     console.log({ duplex: id });\n      //   }\n      // },\n      // },\n      json(),\n      removeDeployer(entryFile, { sourcemap }),\n      // treeshake unused imports\n      esbuild({\n        include: entryFile,\n        platform,\n      }),\n    ].filter(Boolean),\n  } satisfies InputOptions;\n}\n\nexport async function createBundler(\n  inputOptions: InputOptions,\n  outputOptions: Partial<OutputOptions> & { dir: string },\n) {\n  const bundler = await rollup(inputOptions);\n\n  return {\n    write: () => {\n      return bundler.write({\n        ...outputOptions,\n        format: 'esm',\n        entryFileNames: '[name].mjs',\n        chunkFileNames: '[name].mjs',\n      });\n    },\n    close: () => {\n      return bundler.close();\n    },\n  };\n}\n"]}