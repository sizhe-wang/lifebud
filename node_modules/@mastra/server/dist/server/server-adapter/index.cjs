'use strict';

var chunkXCEQ4GQW_cjs = require('../../chunk-XCEQ4GQW.cjs');
var chunkFLLJIPD4_cjs = require('../../chunk-FLLJIPD4.cjs');
var chunk6MP2S6VI_cjs = require('../../chunk-6MP2S6VI.cjs');
var chunkMPUVSOEU_cjs = require('../../chunk-MPUVSOEU.cjs');
var chunkUK4FZWNW_cjs = require('../../chunk-UK4FZWNW.cjs');
var chunkQPFYN6B5_cjs = require('../../chunk-QPFYN6B5.cjs');
var chunkWJ6DNHLW_cjs = require('../../chunk-WJ6DNHLW.cjs');
var chunkBW3BLTCG_cjs = require('../../chunk-BW3BLTCG.cjs');
var chunk4DJ7EJRB_cjs = require('../../chunk-4DJ7EJRB.cjs');
var chunkAV3CN5ZR_cjs = require('../../chunk-AV3CN5ZR.cjs');
var chunkU7IJEAF4_cjs = require('../../chunk-U7IJEAF4.cjs');
var chunkTENMF4X2_cjs = require('../../chunk-TENMF4X2.cjs');
var chunkILV5M6C7_cjs = require('../../chunk-ILV5M6C7.cjs');
var chunkGWLR6K3H_cjs = require('../../chunk-GWLR6K3H.cjs');
var chunk63NFBEYY_cjs = require('../../chunk-63NFBEYY.cjs');
var chunkAVRO3FIN_cjs = require('../../chunk-AVRO3FIN.cjs');
var requestContext = require('@mastra/core/request-context');
var server = require('@mastra/core/server');

// src/server/server-adapter/routes/a2a.ts
var A2A_ROUTES = [chunkU7IJEAF4_cjs.GET_AGENT_CARD_ROUTE, chunkU7IJEAF4_cjs.AGENT_EXECUTION_ROUTE];

// src/server/server-adapter/routes/agent-builder.ts
var AGENT_BUILDER_ROUTES = [
  chunkTENMF4X2_cjs.LIST_AGENT_BUILDER_ACTIONS_ROUTE,
  chunkTENMF4X2_cjs.GET_AGENT_BUILDER_ACTION_BY_ID_ROUTE,
  chunkTENMF4X2_cjs.LIST_AGENT_BUILDER_ACTION_RUNS_ROUTE,
  chunkTENMF4X2_cjs.GET_AGENT_BUILDER_ACTION_RUN_BY_ID_ROUTE,
  chunkTENMF4X2_cjs.CREATE_AGENT_BUILDER_ACTION_RUN_ROUTE,
  chunkTENMF4X2_cjs.STREAM_AGENT_BUILDER_ACTION_ROUTE,
  chunkTENMF4X2_cjs.START_ASYNC_AGENT_BUILDER_ACTION_ROUTE,
  chunkTENMF4X2_cjs.START_AGENT_BUILDER_ACTION_RUN_ROUTE,
  chunkTENMF4X2_cjs.OBSERVE_STREAM_AGENT_BUILDER_ACTION_ROUTE,
  chunkTENMF4X2_cjs.RESUME_ASYNC_AGENT_BUILDER_ACTION_ROUTE,
  chunkTENMF4X2_cjs.RESUME_AGENT_BUILDER_ACTION_ROUTE,
  chunkTENMF4X2_cjs.RESUME_STREAM_AGENT_BUILDER_ACTION_ROUTE,
  chunkTENMF4X2_cjs.CANCEL_AGENT_BUILDER_ACTION_RUN_ROUTE
];

// src/server/server-adapter/routes/agents.ts
var AGENTS_ROUTES = [
  // ============================================================================
  // Agent Core Routes
  // ============================================================================
  chunk63NFBEYY_cjs.LIST_AGENTS_ROUTE,
  chunk63NFBEYY_cjs.GET_PROVIDERS_ROUTE,
  chunk63NFBEYY_cjs.GET_AGENT_BY_ID_ROUTE,
  // ============================================================================
  // Voice Routes
  // ============================================================================
  chunkUK4FZWNW_cjs.GET_SPEAKERS_ROUTE,
  chunkUK4FZWNW_cjs.GET_SPEAKERS_DEPRECATED_ROUTE,
  // ============================================================================
  // Agent Execution Routes
  // ============================================================================
  chunk63NFBEYY_cjs.GENERATE_AGENT_ROUTE,
  chunk63NFBEYY_cjs.GENERATE_AGENT_VNEXT_ROUTE,
  chunk63NFBEYY_cjs.STREAM_GENERATE_ROUTE,
  chunk63NFBEYY_cjs.STREAM_GENERATE_VNEXT_DEPRECATED_ROUTE,
  // ============================================================================
  // Tool Routes
  // ============================================================================
  chunk6MP2S6VI_cjs.EXECUTE_AGENT_TOOL_ROUTE,
  chunk63NFBEYY_cjs.APPROVE_TOOL_CALL_ROUTE,
  chunk63NFBEYY_cjs.DECLINE_TOOL_CALL_ROUTE,
  chunk63NFBEYY_cjs.APPROVE_NETWORK_TOOL_CALL_ROUTE,
  chunk63NFBEYY_cjs.DECLINE_NETWORK_TOOL_CALL_ROUTE,
  // ============================================================================
  // Network Routes
  // ============================================================================
  chunk63NFBEYY_cjs.STREAM_NETWORK_ROUTE,
  // ============================================================================
  // Model Management Routes
  // ============================================================================
  chunk63NFBEYY_cjs.UPDATE_AGENT_MODEL_ROUTE,
  chunk63NFBEYY_cjs.RESET_AGENT_MODEL_ROUTE,
  chunk63NFBEYY_cjs.REORDER_AGENT_MODEL_LIST_ROUTE,
  chunk63NFBEYY_cjs.UPDATE_AGENT_MODEL_IN_MODEL_LIST_ROUTE,
  // ============================================================================
  // Instruction Enhancement Routes
  // ============================================================================
  chunk63NFBEYY_cjs.ENHANCE_INSTRUCTIONS_ROUTE,
  // ============================================================================
  // Agent Tool Routes
  // ============================================================================
  chunk6MP2S6VI_cjs.GET_AGENT_TOOL_ROUTE,
  // ============================================================================
  // Voice/Speech Routes
  // ============================================================================
  chunkUK4FZWNW_cjs.GENERATE_SPEECH_ROUTE,
  chunkUK4FZWNW_cjs.GENERATE_SPEECH_DEPRECATED_ROUTE,
  chunkUK4FZWNW_cjs.TRANSCRIBE_SPEECH_ROUTE,
  chunkUK4FZWNW_cjs.TRANSCRIBE_SPEECH_DEPRECATED_ROUTE,
  chunkUK4FZWNW_cjs.GET_LISTENER_ROUTE,
  // ============================================================================
  // Deprecated Routes
  // ============================================================================
  chunk63NFBEYY_cjs.STREAM_VNEXT_DEPRECATED_ROUTE,
  chunk63NFBEYY_cjs.STREAM_UI_MESSAGE_VNEXT_DEPRECATED_ROUTE,
  chunk63NFBEYY_cjs.STREAM_UI_MESSAGE_DEPRECATED_ROUTE
];

// src/server/server-adapter/routes/legacy.ts
var LEGACY_ROUTES = [
  // ============================================================================
  // Legacy Agent Routes
  // ============================================================================
  chunk63NFBEYY_cjs.GENERATE_LEGACY_ROUTE,
  chunk63NFBEYY_cjs.STREAM_GENERATE_LEGACY_ROUTE,
  // ============================================================================
  // Legacy Workflow Routes
  // ============================================================================
  chunkILV5M6C7_cjs.STREAM_LEGACY_WORKFLOW_ROUTE,
  chunkILV5M6C7_cjs.OBSERVE_STREAM_LEGACY_WORKFLOW_ROUTE,
  // ============================================================================
  // Legacy Agent Builder Routes
  // ============================================================================
  chunkTENMF4X2_cjs.STREAM_LEGACY_AGENT_BUILDER_ACTION_ROUTE,
  chunkTENMF4X2_cjs.OBSERVE_STREAM_LEGACY_AGENT_BUILDER_ACTION_ROUTE
];

// src/server/server-adapter/routes/logs.ts
var LOGS_ROUTES = [
  chunkQPFYN6B5_cjs.LIST_LOG_TRANSPORTS_ROUTE,
  chunkQPFYN6B5_cjs.LIST_LOGS_ROUTE,
  chunkQPFYN6B5_cjs.LIST_LOGS_BY_RUN_ID_ROUTE
];

// src/server/server-adapter/routes/mcp.ts
var MCP_ROUTES = [
  // ============================================================================
  // MCP Server Registry Routes
  // ============================================================================
  chunkWJ6DNHLW_cjs.LIST_MCP_SERVERS_ROUTE,
  chunkWJ6DNHLW_cjs.GET_MCP_SERVER_DETAIL_ROUTE,
  // ============================================================================
  // MCP Server Tool Routes
  // ============================================================================
  chunkWJ6DNHLW_cjs.LIST_MCP_SERVER_TOOLS_ROUTE,
  chunkWJ6DNHLW_cjs.GET_MCP_SERVER_TOOL_DETAIL_ROUTE,
  chunkWJ6DNHLW_cjs.EXECUTE_MCP_SERVER_TOOL_ROUTE,
  // ============================================================================
  // MCP Transport Routes (handled by adapters)
  // ============================================================================
  chunkWJ6DNHLW_cjs.MCP_HTTP_TRANSPORT_ROUTE,
  chunkWJ6DNHLW_cjs.MCP_SSE_TRANSPORT_ROUTE,
  chunkWJ6DNHLW_cjs.MCP_SSE_MESSAGES_ROUTE
];

// src/server/server-adapter/routes/memory.ts
var MEMORY_ROUTES = [
  chunkBW3BLTCG_cjs.GET_MEMORY_STATUS_ROUTE,
  chunkBW3BLTCG_cjs.GET_MEMORY_CONFIG_ROUTE,
  chunkBW3BLTCG_cjs.LIST_THREADS_ROUTE,
  chunkBW3BLTCG_cjs.GET_THREAD_BY_ID_ROUTE,
  chunkBW3BLTCG_cjs.LIST_MESSAGES_ROUTE,
  chunkBW3BLTCG_cjs.GET_WORKING_MEMORY_ROUTE,
  chunkBW3BLTCG_cjs.SAVE_MESSAGES_ROUTE,
  chunkBW3BLTCG_cjs.CREATE_THREAD_ROUTE,
  chunkBW3BLTCG_cjs.UPDATE_THREAD_ROUTE,
  chunkBW3BLTCG_cjs.DELETE_THREAD_ROUTE,
  chunkBW3BLTCG_cjs.CLONE_THREAD_ROUTE,
  chunkBW3BLTCG_cjs.UPDATE_WORKING_MEMORY_ROUTE,
  chunkBW3BLTCG_cjs.DELETE_MESSAGES_ROUTE,
  chunkBW3BLTCG_cjs.SEARCH_MEMORY_ROUTE,
  chunkBW3BLTCG_cjs.GET_MEMORY_STATUS_NETWORK_ROUTE,
  chunkBW3BLTCG_cjs.LIST_THREADS_NETWORK_ROUTE,
  chunkBW3BLTCG_cjs.GET_THREAD_BY_ID_NETWORK_ROUTE,
  chunkBW3BLTCG_cjs.LIST_MESSAGES_NETWORK_ROUTE,
  chunkBW3BLTCG_cjs.SAVE_MESSAGES_NETWORK_ROUTE,
  chunkBW3BLTCG_cjs.CREATE_THREAD_NETWORK_ROUTE,
  chunkBW3BLTCG_cjs.UPDATE_THREAD_NETWORK_ROUTE,
  chunkBW3BLTCG_cjs.DELETE_THREAD_NETWORK_ROUTE,
  chunkBW3BLTCG_cjs.DELETE_MESSAGES_NETWORK_ROUTE
];

// src/server/server-adapter/routes/observability.ts
var OBSERVABILITY_ROUTES = [
  chunk4DJ7EJRB_cjs.LIST_TRACES_ROUTE,
  chunk4DJ7EJRB_cjs.GET_TRACE_ROUTE,
  chunk4DJ7EJRB_cjs.SCORE_TRACES_ROUTE,
  chunk4DJ7EJRB_cjs.LIST_SCORES_BY_SPAN_ROUTE
];

// src/server/server-adapter/routes/scorers.ts
var SCORES_ROUTES = [
  chunkAV3CN5ZR_cjs.LIST_SCORERS_ROUTE,
  chunkAV3CN5ZR_cjs.GET_SCORER_ROUTE,
  chunkAV3CN5ZR_cjs.LIST_SCORES_BY_RUN_ID_ROUTE,
  chunkAV3CN5ZR_cjs.LIST_SCORES_BY_SCORER_ID_ROUTE,
  chunkAV3CN5ZR_cjs.LIST_SCORES_BY_ENTITY_ID_ROUTE,
  chunkAV3CN5ZR_cjs.SAVE_SCORE_ROUTE
];

// src/server/server-adapter/routes/stored-agents.ts
var STORED_AGENTS_ROUTES = [
  // ============================================================================
  // Stored Agents CRUD Routes
  // ============================================================================
  chunkXCEQ4GQW_cjs.LIST_STORED_AGENTS_ROUTE,
  chunkXCEQ4GQW_cjs.GET_STORED_AGENT_ROUTE,
  chunkXCEQ4GQW_cjs.CREATE_STORED_AGENT_ROUTE,
  chunkXCEQ4GQW_cjs.UPDATE_STORED_AGENT_ROUTE,
  chunkXCEQ4GQW_cjs.DELETE_STORED_AGENT_ROUTE
];

// src/server/server-adapter/routes/system.ts
var SYSTEM_ROUTES = [chunkFLLJIPD4_cjs.GET_SYSTEM_PACKAGES_ROUTE];

// src/server/server-adapter/routes/tools.ts
var TOOLS_ROUTES = [chunk6MP2S6VI_cjs.LIST_TOOLS_ROUTE, chunk6MP2S6VI_cjs.GET_TOOL_BY_ID_ROUTE, chunk6MP2S6VI_cjs.EXECUTE_TOOL_ROUTE];

// src/server/server-adapter/routes/vectors.ts
var VECTORS_ROUTES = [
  chunkMPUVSOEU_cjs.UPSERT_VECTORS_ROUTE,
  chunkMPUVSOEU_cjs.CREATE_INDEX_ROUTE,
  chunkMPUVSOEU_cjs.QUERY_VECTORS_ROUTE,
  chunkMPUVSOEU_cjs.LIST_INDEXES_ROUTE,
  chunkMPUVSOEU_cjs.DESCRIBE_INDEX_ROUTE,
  chunkMPUVSOEU_cjs.DELETE_INDEX_ROUTE
];

// src/server/server-adapter/routes/workflows.ts
var WORKFLOWS_ROUTES = [
  chunkILV5M6C7_cjs.LIST_WORKFLOWS_ROUTE,
  chunkILV5M6C7_cjs.GET_WORKFLOW_BY_ID_ROUTE,
  chunkILV5M6C7_cjs.LIST_WORKFLOW_RUNS_ROUTE,
  chunkILV5M6C7_cjs.GET_WORKFLOW_RUN_BY_ID_ROUTE,
  chunkILV5M6C7_cjs.DELETE_WORKFLOW_RUN_BY_ID_ROUTE,
  chunkILV5M6C7_cjs.CREATE_WORKFLOW_RUN_ROUTE,
  chunkILV5M6C7_cjs.STREAM_WORKFLOW_ROUTE,
  chunkILV5M6C7_cjs.RESUME_STREAM_WORKFLOW_ROUTE,
  chunkILV5M6C7_cjs.START_ASYNC_WORKFLOW_ROUTE,
  chunkILV5M6C7_cjs.START_WORKFLOW_RUN_ROUTE,
  chunkILV5M6C7_cjs.OBSERVE_STREAM_WORKFLOW_ROUTE,
  chunkILV5M6C7_cjs.RESUME_ASYNC_WORKFLOW_ROUTE,
  chunkILV5M6C7_cjs.RESUME_WORKFLOW_ROUTE,
  chunkILV5M6C7_cjs.CANCEL_WORKFLOW_RUN_ROUTE,
  chunkILV5M6C7_cjs.TIME_TRAVEL_WORKFLOW_ROUTE,
  chunkILV5M6C7_cjs.TIME_TRAVEL_ASYNC_WORKFLOW_ROUTE,
  chunkILV5M6C7_cjs.TIME_TRAVEL_STREAM_WORKFLOW_ROUTE,
  chunkILV5M6C7_cjs.RESTART_WORKFLOW_ROUTE,
  chunkILV5M6C7_cjs.RESTART_ASYNC_WORKFLOW_ROUTE,
  chunkILV5M6C7_cjs.RESTART_ALL_ACTIVE_WORKFLOW_RUNS_ROUTE,
  chunkILV5M6C7_cjs.RESTART_ALL_ACTIVE_WORKFLOW_RUNS_ASYNC_ROUTE
];

// src/server/server-adapter/routes/index.ts
var SERVER_ROUTES = [
  ...AGENTS_ROUTES,
  ...WORKFLOWS_ROUTES,
  ...TOOLS_ROUTES,
  ...MEMORY_ROUTES,
  ...SCORES_ROUTES,
  ...OBSERVABILITY_ROUTES,
  ...LOGS_ROUTES,
  ...VECTORS_ROUTES,
  ...A2A_ROUTES,
  ...AGENT_BUILDER_ROUTES,
  ...LEGACY_ROUTES,
  ...MCP_ROUTES,
  ...STORED_AGENTS_ROUTES,
  ...SYSTEM_ROUTES
];

// src/server/server-adapter/redact.ts
function redactV2Payload(payload) {
  const redactedPayload = { ...payload };
  if (redactedPayload.metadata && typeof redactedPayload.metadata === "object") {
    const { request, ...metadataRest } = redactedPayload.metadata;
    redactedPayload.metadata = metadataRest;
  }
  if (redactedPayload.output && typeof redactedPayload.output === "object") {
    const output = { ...redactedPayload.output };
    if (Array.isArray(output.steps)) {
      output.steps = output.steps.map((step) => {
        if (step && typeof step === "object") {
          const { request, ...stepRest } = step;
          return stepRest;
        }
        return step;
      });
    }
    redactedPayload.output = output;
  }
  return redactedPayload;
}
function redactStreamChunk(chunk) {
  if (!chunk || typeof chunk !== "object") {
    return chunk;
  }
  const typedChunk = chunk;
  switch (chunk.type) {
    case "step-start": {
      if ("payload" in typedChunk && typedChunk.payload && typeof typedChunk.payload === "object") {
        const { payload, ...rest } = typedChunk;
        const { request, ...payloadRest } = payload;
        return {
          ...rest,
          type: "step-start",
          payload: {
            ...payloadRest,
            // Keep an empty request object to maintain structure but remove body
            request: {}
          }
        };
      } else if ("request" in typedChunk) {
        const { request, ...rest } = typedChunk;
        return {
          ...rest,
          type: "step-start",
          // Keep an empty request object to maintain structure
          request: {}
        };
      }
      return chunk;
    }
    case "step-finish": {
      if ("payload" in typedChunk && typedChunk.payload && typeof typedChunk.payload === "object") {
        const { payload, ...rest } = typedChunk;
        return {
          ...rest,
          type: "step-finish",
          payload: redactV2Payload(payload)
        };
      } else if ("request" in typedChunk) {
        const { request, ...rest } = typedChunk;
        return {
          ...rest,
          type: "step-finish"
        };
      }
      return chunk;
    }
    case "finish": {
      if ("payload" in typedChunk && typedChunk.payload && typeof typedChunk.payload === "object") {
        const { payload, ...rest } = typedChunk;
        return {
          ...rest,
          type: "finish",
          payload: redactV2Payload(payload)
        };
      } else if ("request" in typedChunk) {
        const { request, ...rest } = typedChunk;
        return {
          ...rest,
          type: "finish"
        };
      }
      return chunk;
    }
    default:
      return chunk;
  }
}

// src/server/server-adapter/index.ts
function normalizeQueryParams(rawQuery) {
  const queryParams = {};
  for (const [key, value] of Object.entries(rawQuery)) {
    if (typeof value === "string") {
      queryParams[key] = value;
    } else if (Array.isArray(value)) {
      const stringValues = value.filter((v) => typeof v === "string");
      queryParams[key] = stringValues.length === 1 ? stringValues[0] : stringValues;
    }
  }
  return queryParams;
}
var MastraServer = class extends server.MastraServerBase {
  mastra;
  bodyLimitOptions;
  tools;
  prefix;
  openapiPath;
  taskStore;
  customRouteAuthConfig;
  streamOptions;
  constructor({
    app,
    mastra,
    bodyLimitOptions,
    tools,
    prefix = "",
    openapiPath = "",
    taskStore,
    customRouteAuthConfig,
    streamOptions
  }) {
    super({ app, name: "MastraServer" });
    this.mastra = mastra;
    this.bodyLimitOptions = bodyLimitOptions;
    this.tools = tools;
    this.prefix = prefix;
    this.openapiPath = openapiPath;
    this.taskStore = taskStore;
    this.customRouteAuthConfig = customRouteAuthConfig;
    this.streamOptions = { redact: true, ...streamOptions };
    mastra.setMastraServer(this);
  }
  mergeRequestContext({
    paramsRequestContext,
    bodyRequestContext
  }) {
    const requestContext$1 = new requestContext.RequestContext();
    if (bodyRequestContext) {
      for (const [key, value] of Object.entries(bodyRequestContext)) {
        requestContext$1.set(key, value);
      }
    }
    if (paramsRequestContext) {
      for (const [key, value] of Object.entries(paramsRequestContext)) {
        requestContext$1.set(key, value);
      }
    }
    return requestContext$1;
  }
  async init() {
    this.registerContextMiddleware();
    this.registerAuthMiddleware();
    await this.registerRoutes();
  }
  async registerOpenAPIRoute(app, config = {}, { prefix }) {
    const {
      title = "Mastra API",
      version = "1.0.0",
      description = "Mastra Server API",
      path = "/openapi.json"
    } = config;
    const openApiSpec = chunkAVRO3FIN_cjs.generateOpenAPIDocument(SERVER_ROUTES, {
      title,
      version,
      description
    });
    const openApiRoute = {
      method: "GET",
      path,
      responseType: "json",
      handler: async () => openApiSpec
    };
    await this.registerRoute(app, openApiRoute, { prefix });
  }
  async registerRoutes() {
    await Promise.all(SERVER_ROUTES.map((route) => this.registerRoute(this.app, route, { prefix: this.prefix })));
    if (this.openapiPath) {
      await this.registerOpenAPIRoute(
        this.app,
        {
          title: "Mastra API",
          version: "1.0.0",
          description: "Mastra Server API",
          path: this.openapiPath
        },
        { prefix: this.prefix }
      );
    }
  }
  async parsePathParams(route, params) {
    const pathParamSchema = route.pathParamSchema;
    if (!pathParamSchema) {
      return params;
    }
    return pathParamSchema.parseAsync(params);
  }
  async parseQueryParams(route, params) {
    const queryParamSchema = route.queryParamSchema;
    if (!queryParamSchema) {
      return params;
    }
    return queryParamSchema.parseAsync(params);
  }
  async parseBody(route, body) {
    const bodySchema = route.bodySchema;
    if (!bodySchema) {
      return body;
    }
    return bodySchema.parseAsync(body);
  }
};

Object.defineProperty(exports, "WorkflowRegistry", {
  enumerable: true,
  get: function () { return chunkGWLR6K3H_cjs.WorkflowRegistry; }
});
Object.defineProperty(exports, "createRoute", {
  enumerable: true,
  get: function () { return chunkAVRO3FIN_cjs.createRoute; }
});
Object.defineProperty(exports, "generateOpenAPIDocument", {
  enumerable: true,
  get: function () { return chunkAVRO3FIN_cjs.generateOpenAPIDocument; }
});
Object.defineProperty(exports, "jsonQueryParam", {
  enumerable: true,
  get: function () { return chunkAVRO3FIN_cjs.jsonQueryParam; }
});
Object.defineProperty(exports, "pickParams", {
  enumerable: true,
  get: function () { return chunkAVRO3FIN_cjs.pickParams; }
});
Object.defineProperty(exports, "wrapSchemaForQueryParams", {
  enumerable: true,
  get: function () { return chunkAVRO3FIN_cjs.wrapSchemaForQueryParams; }
});
exports.MastraServer = MastraServer;
exports.SERVER_ROUTES = SERVER_ROUTES;
exports.normalizeQueryParams = normalizeQueryParams;
exports.redactStreamChunk = redactStreamChunk;
//# sourceMappingURL=index.cjs.map
//# sourceMappingURL=index.cjs.map